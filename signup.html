<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title data-i18n="pageTitle">Flux On | Premium Workspace</title>
  
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Mono:wght@700&display=swap" rel="stylesheet">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/i18next/23.7.6/i18next.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/i18next-browser-languagedetector/7.1.0/i18nextBrowserLanguageDetector.min.js"></script>

  <style>
    :root {
      --primary: #000000;
      --accent: #2563eb;
      --error: #dc2626;
      --success: #16a34a;
      --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      --glass-bg: rgba(255, 255, 255, 0.95);
      --radius: 12px;
      --shadow-elite: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    * { box-sizing: border-box; outline: none; }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: var(--bg-gradient);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: #1e293b;
    }

    /* Language Selector */
    .language-selector {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 100;
    }

    .language-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--glass-bg);
      border: 1px solid #e2e8f0;
      border-radius: 30px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      color: #1e293b;
      transition: all 0.2s;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
    }
    .language-btn:hover {
      background: #fff;
      border-color: var(--primary);
      transform: translateY(-1px);
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    }

    .language-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      box-shadow: var(--shadow-elite);
      z-index: 1000;
      max-height: 400px;
      overflow-y: auto;
      width: 280px;
      display: none;
    }
    .language-dropdown.show { display: block; }
    .language-option {
      padding: 10px 15px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 13px;
      border-bottom: 1px solid #f1f5f9;
    }
    .language-option:last-child { border-bottom: none; }
    .language-option:hover { background: #f8fafc; }
    .language-option.active { background: #e2e8f0; font-weight: 600; }
    .language-dropdown::-webkit-scrollbar { width: 6px; }
    .language-dropdown::-webkit-scrollbar-track { background: #f1f5f9; }
    .language-dropdown::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }

    /* AUTH CONTAINER */
    .auth-card {
      width: 100%;
      max-width: 420px;
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.5);
      border-radius: 24px;
      box-shadow: var(--shadow-elite);
      overflow: hidden;
    }

    .brand-section {
      padding: 40px 40px 20px;
      text-align: center;
    }

    /* TABS */
    .auth-tabs {
      display: flex;
      padding: 8px;
      background: #f1f5f9;
      margin: 0 40px 24px;
      border-radius: 12px;
    }
    .tab-btn {
      flex: 1;
      padding: 10px;
      border: none;
      background: transparent;
      font-weight: 600;
      font-size: 14px;
      color: #64748b;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    .tab-btn.active {
      background: #fff;
      color: #000;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
    }

    /* FORMS */
    .form-content { padding: 0 40px 40px; }
    .form-group { margin-bottom: 20px; }
    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #475569;
    }
    .form-control {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      font-size: 15px;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
      background: #f8fafc;
      color: #1e293b;
    }
    .form-control:focus {
      background: #fff;
      border-color: #000;
      box-shadow: 0 0 0 4px rgba(0,0,0,0.05);
    }

    /* Password strength */
    .password-strength {
      margin-top: 8px;
      height: 4px;
      background: #e2e8f0;
      border-radius: 2px;
      overflow: hidden;
    }
    .strength-bar { height: 100%; width: 0; transition: width 0.3s, background-color 0.3s; border-radius: 2px; }
    .strength-weak   { background: #dc2626; width: 33.33%; }
    .strength-medium { background: #f59e0b; width: 66.66%; }
    .strength-strong { background: #10b981; width: 100%; }
    .strength-text { font-size: 12px; margin-top: 4px; color: #64748b; min-height: 16px; }

    /* BUTTONS */
    .btn-submit {
      width: 100%;
      padding: 14px;
      background: #000;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 16px;
      font-family: 'Inter', sans-serif;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-submit:hover:not(:disabled) {
      background: #1e293b;
      transform: translateY(-1px);
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    }
    .btn-submit:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
      opacity: 0.7;
    }

    .btn-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 0.8s linear infinite;
      flex-shrink: 0;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ALERTS */
    .error-box {
      background: #fff1f2;
      border-left: 4px solid var(--error);
      color: #991b1b;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 13px;
      display: none;
      line-height: 1.5;
    }
    .success-box {
      background: #f0fdf4;
      border-left: 4px solid var(--success);
      color: #166534;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 13px;
      display: none;
      line-height: 1.5;
    }
    .info-box {
      background: #eff6ff;
      border-left: 4px solid #3b82f6;
      color: #1e40af;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 13px;
      display: none;
      line-height: 1.5;
    }

    .forgot-link {
      display: block;
      text-align: center;
      margin-top: 20px;
      font-size: 13px;
      color: #64748b;
      text-decoration: none;
      cursor: pointer;
      transition: color 0.2s;
    }
    .forgot-link:hover { color: #000; text-decoration: underline; }

    .hidden { display: none !important; }

    /* Password visibility toggle */
    .password-wrapper { position: relative; }
    .password-toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: #64748b;
      font-size: 16px;
      padding: 4px;
      line-height: 1;
    }
    .password-toggle:hover { color: #000; }
    .password-wrapper .form-control { padding-right: 44px; }

    /* Debug panel (hidden in production) */
    #debugPanel {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      color: #0f0;
      font-family: monospace;
      font-size: 11px;
      padding: 8px 12px;
      border-radius: 6px;
      max-width: 380px;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      z-index: 9999;
      line-height: 1.6;
    }
  </style>
</head>
<body>

  <!-- Language Selector -->
  <div class="language-selector">
    <button class="language-btn" onclick="toggleLanguageDropdown()">
      <span>üåê</span>
      <span id="currentLanguage">English</span>
      <span>‚ñº</span>
    </button>
    <div class="language-dropdown" id="languageDropdown"></div>
  </div>

  <!-- Debug Panel (dev only ‚Äî remove in prod) -->
  <div id="debugPanel"></div>

  <div class="auth-card">
    <div class="brand-section">
      <h1 style="margin:0;">
        <img width="160px" src="flux.png" alt="Flux On" style="display:block;margin:0 auto;" onerror="this.outerHTML='<span style=\'font-family:Space Mono,monospace;font-size:22px;font-weight:800;\'>Flux On</span>'">
      </h1>
    </div>

    <!-- Tabs: Login shown by default -->
    <div class="auth-tabs">
      <button class="tab-btn" id="tab-signup" onclick="switchTab('signup')" data-i18n="tabs.signup">Sign Up</button>
      <button class="tab-btn active" id="tab-login" onclick="switchTab('login')" data-i18n="tabs.login">Log In</button>
    </div>

    <div class="form-content">
      <div id="error-display"   class="error-box"></div>
      <div id="success-display" class="success-box"></div>
      <div id="info-display"    class="info-box"></div>

      <!-- ===== LOGIN FORM ===== -->
      <!--
        FLOW:
        1. POST /api/login  (YOUR backend ‚Äî not n8n directly)
        2. Backend calls n8n internally, gets userid
        3. Backend calls session.regenerate(), stores userId + CSRF token in session
        4. Backend sets:
             - session cookie: fluxon.sid (httpOnly)
             - CSRF cookie: XSRF-TOKEN (JS-readable)
        5. Backend returns: { success: true, userid, userId, email, message: 'Login successful' }
        6. Frontend reads XSRF-TOKEN cookie, stores userId in localStorage fallback
        7. Redirect to flow.html
      -->
      <form id="loginForm" novalidate>
        <div class="form-group">
          <label class="form-label" for="li-email" data-i18n="labels.email">Email Address</label>
          <input type="email" id="li-email" class="form-control"
            placeholder="name@company.com"
            data-i18n-placeholder="placeholders.email"
            required autocomplete="email">
        </div>
        <div class="form-group">
          <label class="form-label" for="li-password" data-i18n="labels.password">Password</label>
          <div class="password-wrapper">
            <input type="password" id="li-password" class="form-control"
              placeholder="Enter your password"
              data-i18n-placeholder="placeholders.loginPassword"
              required autocomplete="current-password">
            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('li-password')" aria-label="Toggle password">üëÅ</button>
          </div>
        </div>
        <button type="submit" class="btn-submit" id="btn-login" data-i18n="buttons.login">Sign In</button>
        <a class="forgot-link" onclick="forgotPassword()" data-i18n="links.forgotPassword">Forgotten password?</a>
      </form>

      <!-- ===== SIGNUP FORM ===== -->
      <!--
        FLOW:
        1. POST to n8n /webhook/signup directly (backend has no /api/signup route)
        2. n8n creates the user in the database, returns: { message: '...success...', userid: '...' }
        3. Frontend calls POST /api/create-session with { userId, email }
        4. Backend calls session.regenerate(), stores userId + CSRF in session
        5. Backend sets:
             - session cookie: fluxon.sid (httpOnly)
             - CSRF cookie: XSRF-TOKEN (JS-readable)
        6. Backend returns: { success: true, userId, sessionId }
        7. Frontend reads XSRF-TOKEN cookie, stores localStorage fallback
        8. Redirect to flow.html
      -->
      <form id="signupForm" class="hidden" novalidate>
        <div class="form-group">
          <label class="form-label" for="su-username" data-i18n="labels.username">Username</label>
          <input type="text" id="su-username" class="form-control"
            placeholder="Choose a username"
            data-i18n-placeholder="placeholders.username"
            required autocomplete="username" minlength="3" maxlength="30">
        </div>
        <div class="form-group">
          <label class="form-label" for="su-email" data-i18n="labels.email">Email Address</label>
          <input type="email" id="su-email" class="form-control"
            placeholder="name@company.com"
            data-i18n-placeholder="placeholders.email"
            required autocomplete="email">
        </div>
        <div class="form-group">
          <label class="form-label" for="su-password" data-i18n="labels.password">Password</label>
          <div class="password-wrapper">
            <input type="password" id="su-password" class="form-control"
              placeholder="Min. 8 characters"
              data-i18n-placeholder="placeholders.password"
              required autocomplete="new-password" minlength="8"
              oninput="checkPasswordStrength(this.value)">
            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('su-password')" aria-label="Toggle password">üëÅ</button>
          </div>
          <div class="password-strength"><div class="strength-bar" id="strengthBar"></div></div>
          <div class="strength-text" id="strengthText"></div>
        </div>
        <div class="form-group">
          <label class="form-label" for="su-confirm-password" data-i18n="labels.confirmPassword">Confirm Password</label>
          <div class="password-wrapper">
            <input type="password" id="su-confirm-password" class="form-control"
              placeholder="Confirm your password"
              data-i18n-placeholder="placeholders.confirmPassword"
              required autocomplete="new-password"
              oninput="checkPasswordMatch()">
            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('su-confirm-password')" aria-label="Toggle password">üëÅ</button>
          </div>
          <div class="strength-text" id="matchText"></div>
        </div>
        <button type="submit" class="btn-submit" id="btn-signup" data-i18n="buttons.signup">Create Workspace</button>
      </form>
    </div>
  </div>

<script>
'use strict';

// ============================================
// CONFIGURATION
// ============================================

const API_BASE_URL  = 'https://flowon.onrender.com/api';
const N8N_BASE      = 'https://kingoftech.app.n8n.cloud/webhook';

// ============================================
// DEBUG LOGGER (safe to leave in ‚Äî silent in prod)
// ============================================

const DEBUG = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

function dbg(...args) {
  if (!DEBUG) return;
  const panel = document.getElementById('debugPanel');
  if (panel) {
    panel.style.display = 'block';
    const line = document.createElement('div');
    line.textContent = '[' + new Date().toLocaleTimeString() + '] ' + args.join(' ');
    panel.appendChild(line);
    panel.scrollTop = panel.scrollHeight;
  }
  console.log('[FluxOn]', ...args);
}

// ============================================
// CSRF ‚Äî read the cookie the backend sets
// ============================================

function readCsrfCookie() {
  const match = document.cookie
    .split('; ')
    .find(c => c.startsWith('XSRF-TOKEN='));
  return match ? decodeURIComponent(match.split('=')[1]) : null;
}

// ============================================
// SESSION CHECK ‚Äî redirect if already logged in
// Must use plain fetch (no CSRF needed for GET /api/session)
// ============================================

async function checkExistingSession() {
  try {
    dbg('Checking existing session...');
    const res = await fetch(`${API_BASE_URL}/session`, {
      method: 'GET',
      credentials: 'include'
    });

    if (!res.ok) return false;
    const data = await res.json();
    dbg('Session check result:', JSON.stringify(data));

    if (data.authenticated && data.userId) {
      dbg('Already authenticated ‚Üí redirecting');
      redirectToApp();
      return true;
    }
    return false;
  } catch (e) {
    dbg('Session check error:', e.message);
    return false;
  }
}

// ============================================
// UI HELPERS
// ============================================

function showError(html) {
  const el = document.getElementById('error-display');
  el.innerHTML = html;
  el.style.display = 'block';
  document.getElementById('success-display').style.display = 'none';
  document.getElementById('info-display').style.display = 'none';
}

function showSuccess(html) {
  const el = document.getElementById('success-display');
  el.innerHTML = html;
  el.style.display = 'block';
  document.getElementById('error-display').style.display = 'none';
  document.getElementById('info-display').style.display = 'none';
}

function showInfo(html) {
  const el = document.getElementById('info-display');
  el.innerHTML = html;
  el.style.display = 'block';
  document.getElementById('error-display').style.display = 'none';
  document.getElementById('success-display').style.display = 'none';
}

function clearMessages() {
  ['error-display', 'success-display', 'info-display'].forEach(id => {
    document.getElementById(id).style.display = 'none';
  });
}

function setButtonLoading(btn, loading, text) {
  if (loading) {
    btn.dataset.og = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `<span class="btn-spinner"></span>${text}`;
  } else {
    btn.innerHTML = btn.dataset.og || btn.innerHTML;
    btn.disabled = false;
  }
}

function validateEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

function checkPasswordStrength(pw) {
  const bar  = document.getElementById('strengthBar');
  const text = document.getElementById('strengthText');
  if (!pw) { bar.className = 'strength-bar'; text.textContent = ''; return; }
  let s = 0;
  if (pw.length >= 8) s++;
  if (pw.length >= 12) s++;
  if (/[a-z]/.test(pw)) s++;
  if (/[A-Z]/.test(pw)) s++;
  if (/[0-9]/.test(pw)) s++;
  if (/[^a-zA-Z0-9]/.test(pw)) s++;
  if (s <= 2) { bar.className = 'strength-bar strength-weak';   text.textContent = i18next.t('passwordStrength.weak'); }
  else if (s <= 4) { bar.className = 'strength-bar strength-medium'; text.textContent = i18next.t('passwordStrength.medium'); }
  else { bar.className = 'strength-bar strength-strong'; text.textContent = i18next.t('passwordStrength.strong'); }
}

function checkPasswordMatch() {
  const pw  = document.getElementById('su-password').value;
  const con = document.getElementById('su-confirm-password').value;
  const el  = document.getElementById('matchText');
  if (!con) { el.textContent = ''; return; }
  if (pw === con) { el.textContent = '‚úì ' + i18next.t('passwordMatch.match');   el.style.color = '#16a34a'; }
  else            { el.textContent = '‚úó ' + i18next.t('passwordMatch.noMatch'); el.style.color = '#dc2626'; }
}

function togglePasswordVisibility(id) {
  const el = document.getElementById(id);
  el.type = el.type === 'password' ? 'text' : 'password';
}

function switchTab(tab) {
  clearMessages();
  const isSignup = tab === 'signup';
  document.getElementById('signupForm').classList.toggle('hidden', !isSignup);
  document.getElementById('loginForm').classList.toggle('hidden',  isSignup);
  document.getElementById('tab-signup').classList.toggle('active',  isSignup);
  document.getElementById('tab-login').classList.toggle('active',  !isSignup);
}

function forgotPassword() {
  alert(i18next.t('alerts.forgotPassword'));
}

function redirectToApp() {
  const lang = i18next.language;
  const url  = (lang && lang !== 'en') ? `flow.html?lang=${lang}` : 'flow.html';
  setTimeout(() => { window.location.href = url; }, 800);
}

// ============================================
// PERSIST auth for localStorage fallback
// (flow.html reads this if session cookie is missing)
// ============================================

function persistLocalAuth(userId, email) {
  localStorage.setItem('flowid', userId);
  if (email) localStorage.setItem('userEmail', email);
  dbg('localStorage auth set for userId:', userId);
}

// ============================================
// LOGIN
//
// CORRECT FLOW:
//   POST /api/login  ‚Üê YOUR backend (not n8n directly!)
//   Backend internally calls n8n, creates session, sets cookies
//   Returns: { success: true, userid, userId, email, message: 'Login successful' }
//
// WHAT THE OLD CODE DID WRONG:
//   It called N8N_BASE/login directly ‚Üí backend never created a session
//   handleAuthSuccess checked data.message.includes('success') but
//   /api/login returns { success: true } not { message: 'success' }
//   So it always showed "wrong credentials"
// ============================================

document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const email    = document.getElementById('li-email').value.trim();
  const password = document.getElementById('li-password').value;

  if (!email || !validateEmail(email)) { showError(i18next.t('errors.invalidEmail')); return; }
  if (!password)                        { showError(i18next.t('errors.passwordRequired')); return; }

  const btn = document.getElementById('btn-login');
  setButtonLoading(btn, true, i18next.t('buttons.authenticating'));
  clearMessages();

  try {
    dbg('LOGIN ‚Üí POST /api/login');

    const res = await fetch(`${API_BASE_URL}/login`, {
      method:      'POST',
      credentials: 'include',          // ‚Üê CRITICAL: receives session + XSRF-TOKEN cookies
      headers:     { 'Content-Type': 'application/json' },
      body:        JSON.stringify({ email, password })
    });

    const data = await res.json();
    dbg('Login response:', res.status, JSON.stringify(data));

    // Backend returns { success: true, userid, userId, email }
    // on bad credentials it returns 401 + { error: '...' }
    if (res.ok && data.success && (data.userid || data.userId)) {
      const userId = data.userid || data.userId;

      // Session cookie (httpOnly) and XSRF-TOKEN cookie are now set by the browser
      // Store localStorage fallback for flow.html
      persistLocalAuth(userId, email);

      dbg('Login ‚úì userId:', userId, 'CSRF cookie:', readCsrfCookie() ? 'SET' : 'MISSING');
      showSuccess(i18next.t('auth.loginSuccess'));
      redirectToApp();

    } else {
      // 401 from backend ‚Äî bad credentials
      const msg = data.error || data.message || i18next.t('errors.wrongCredentials');
      dbg('Login ‚úó error:', msg);
      showError(`<b>${msg}</b>`);
    }

  } catch (err) {
    dbg('Login exception:', err.message);
    showError(i18next.t('errors.connectionFailed'));
  } finally {
    setButtonLoading(btn, false);
  }
});

// ============================================
// SIGNUP
//
// CORRECT FLOW:
//   Step 1: POST to n8n directly (your backend has no /api/signup)
//           n8n creates user in DB, returns: { message: '...success...', userid: '...' }
//   Step 2: POST /api/create-session with { userId, email }
//           Backend: session.regenerate() ‚Üí sets userId + CSRF in session
//           Sets cookies: fluxon.sid (httpOnly) + XSRF-TOKEN (JS-readable)
//           Returns: { success: true, userId, sessionId }
//   Step 3: Read XSRF-TOKEN cookie, persist localStorage fallback, redirect
//
// WHAT THE OLD CODE DID WRONG:
//   Called handleAuthSuccess twice (once in the if-block, once inside it)
//   handleAuthSuccess also tried to createSession ‚Äî but session creation was
//   already inside handleAuthSuccess, so it was called but the CSRF wasn't read
//   afterwards. Race condition + double-call.
// ============================================

document.getElementById('signupForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const username        = document.getElementById('su-username').value.trim();
  const email           = document.getElementById('su-email').value.trim();
  const password        = document.getElementById('su-password').value;
  const confirmPassword = document.getElementById('su-confirm-password').value;

  if (!username)                           { showError(i18next.t('errors.usernameRequired')); return; }
  if (!email || !validateEmail(email))     { showError(i18next.t('errors.invalidEmail')); return; }
  if (!password || password.length < 8)   { showError(i18next.t('errors.passwordTooShort')); return; }
  if (password !== confirmPassword)        { showError(i18next.t('errors.passwordsDoNotMatch')); return; }

  const btn = document.getElementById('btn-signup');
  setButtonLoading(btn, true, i18next.t('buttons.signingUp'));
  clearMessages();

  try {
    // ‚îÄ‚îÄ STEP 1: Create user in n8n ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    dbg('SIGNUP step 1 ‚Üí POST n8n/signup');
    showInfo('Creating your account...');

    const n8nRes = await fetch(`${N8N_BASE}/signup`, {
      method:  'POST',
      headers: { 'Content-Type': 'application/json' },
      body:    JSON.stringify({ username, email, password })
    });

    const n8nData = await n8nRes.json();
    dbg('n8n signup response:', n8nRes.status, JSON.stringify(n8nData));

    // n8n returns: { message: "Sign Up Successful...", userid: "..." }
    const isSuccess = n8nData.message &&
      (n8nData.message.toLowerCase().includes('success') ||
       n8nData.message.toLowerCase().includes('successful'));

    if (!isSuccess || !n8nData.userid) {
      const msg = n8nData.message || i18next.t('errors.serverError');
      dbg('n8n signup ‚úó:', msg);
      showError(msg);
      return;
    }

    const userId = n8nData.userid;
    dbg('n8n signup ‚úì userId:', userId);

    // ‚îÄ‚îÄ STEP 2: Create backend session ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    dbg('SIGNUP step 2 ‚Üí POST /api/create-session');
    showInfo('Setting up your workspace...');

    const sessionRes = await fetch(`${API_BASE_URL}/create-session`, {
      method:      'POST',
      credentials: 'include',           // ‚Üê CRITICAL: receives session + XSRF-TOKEN cookies
      headers:     { 'Content-Type': 'application/json' },
      body:        JSON.stringify({ userId, email })
    });

    const sessionData = await sessionRes.json();
    dbg('create-session response:', sessionRes.status, JSON.stringify(sessionData));

    if (!sessionRes.ok || !sessionData.success) {
      // Session failed ‚Äî user account was created but session couldn't be established.
      // Fall back to localStorage auth and still redirect; flow.html handles this.
      console.warn('[Signup] Session creation failed ‚Äî using localStorage fallback');
      dbg('Session failed, using localStorage fallback');
      persistLocalAuth(userId, email);
      showSuccess(i18next.t('auth.signupSuccess'));
      redirectToApp();
      return;
    }

    // ‚îÄ‚îÄ STEP 3: Session established ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Cookies are now set: fluxon.sid (httpOnly) and XSRF-TOKEN (JS-readable)
    const csrfCookie = readCsrfCookie();
    dbg('Signup ‚úì sessionId:', sessionData.sessionId, 'CSRF cookie:', csrfCookie ? 'SET' : 'MISSING');

    // localStorage fallback for flow.html
    persistLocalAuth(userId, email);

    showSuccess(i18next.t('auth.signupSuccess'));
    redirectToApp();

  } catch (err) {
    dbg('Signup exception:', err.message);
    showError(i18next.t('errors.connectionFailed'));
  } finally {
    setButtonLoading(btn, false);
  }
});

// ============================================
// TRANSLATIONS
// ============================================

const translationResources = {
  en: {
    pageTitle: 'Flux On | Premium Workspace',
    tabs: { signup: 'Sign Up', login: 'Log In' },
    labels: { username: 'Username', email: 'Email Address', password: 'Password', confirmPassword: 'Confirm Password' },
    placeholders: { username: 'Choose a username', email: 'name@company.com', password: 'Min. 8 characters', loginPassword: 'Enter your password', confirmPassword: 'Confirm your password' },
    buttons: { signup: 'Create Workspace', login: 'Sign In', authenticating: 'Signing in...', signingUp: 'Creating account...' },
    links: { forgotPassword: 'Forgotten password?' },
    errors: {
      wrongCredentials: '<b>Wrong email or password.</b><br>Click Forgotten password or contact your admin.',
      connectionFailed: 'Connection failed. Please check your internet connection.',
      serverError: 'Could not reach the server. Please try again later.',
      invalidEmail: 'Please enter a valid email address.',
      passwordTooShort: 'Password must be at least 8 characters.',
      passwordsDoNotMatch: 'Passwords do not match.',
      usernameRequired: 'Username is required.',
      passwordRequired: 'Password is required.'
    },
    alerts: { forgotPassword: 'Forgotten Password is coming soon. Please contact your administrator.' },
    passwordStrength: { weak: 'Weak password', medium: 'Medium strength', strong: 'Strong password' },
    passwordMatch: { match: 'Passwords match', noMatch: 'Passwords do not match' },
    auth: {
      loginSuccess: 'Login successful! Redirecting...',
      signupSuccess: 'Account created! Redirecting...',
    }
  },
  es: {
    pageTitle: 'Flux On | Espacio de Trabajo Premium',
    tabs: { signup: 'Registrarse', login: 'Iniciar Sesi√≥n' },
    labels: { username: 'Nombre de Usuario', email: 'Correo Electr√≥nico', password: 'Contrase√±a', confirmPassword: 'Confirmar Contrase√±a' },
    placeholders: { username: 'Elige un nombre de usuario', email: 'nombre@empresa.com', password: 'M√≠n. 8 caracteres', loginPassword: 'Ingresa tu contrase√±a', confirmPassword: 'Confirma tu contrase√±a' },
    buttons: { signup: 'Crear Espacio de Trabajo', login: 'Iniciar Sesi√≥n', authenticating: 'Iniciando sesi√≥n...', signingUp: 'Creando cuenta...' },
    links: { forgotPassword: '¬øOlvidaste tu contrase√±a?' },
    errors: {
      wrongCredentials: '<b>Correo o contrase√±a incorrectos.</b>',
      connectionFailed: 'Error de conexi√≥n. Verifica tu internet.',
      serverError: 'No se pudo conectar al servidor.',
      invalidEmail: 'Ingresa un correo electr√≥nico v√°lido.',
      passwordTooShort: 'La contrase√±a debe tener al menos 8 caracteres.',
      passwordsDoNotMatch: 'Las contrase√±as no coinciden.',
      usernameRequired: 'El nombre de usuario es requerido.',
      passwordRequired: 'La contrase√±a es requerida.'
    },
    alerts: { forgotPassword: 'La funci√≥n de contrase√±a olvidada estar√° disponible pronto.' },
    passwordStrength: { weak: 'Contrase√±a d√©bil', medium: 'Contrase√±a media', strong: 'Contrase√±a fuerte' },
    passwordMatch: { match: 'Las contrase√±as coinciden', noMatch: 'Las contrase√±as no coinciden' },
    auth: { loginSuccess: '¬°Inicio de sesi√≥n exitoso! Redirigiendo...', signupSuccess: '¬°Cuenta creada! Redirigiendo...' }
  },
  fr: {
    pageTitle: 'Flux On | Espace de Travail Premium',
    tabs: { signup: "S'inscrire", login: 'Se connecter' },
    labels: { username: "Nom d'utilisateur", email: 'Adresse e-mail', password: 'Mot de passe', confirmPassword: 'Confirmer le mot de passe' },
    placeholders: { username: "Choisissez un nom d'utilisateur", email: 'nom@entreprise.com', password: 'Min. 8 caract√®res', loginPassword: 'Entrez votre mot de passe', confirmPassword: 'Confirmez votre mot de passe' },
    buttons: { signup: "Cr√©er l'espace de travail", login: 'Se connecter', authenticating: 'Connexion...', signingUp: 'Cr√©ation du compte...' },
    links: { forgotPassword: 'Mot de passe oubli√©?' },
    errors: {
      wrongCredentials: '<b>E-mail ou mot de passe incorrect.</b>',
      connectionFailed: 'Connexion √©chou√©e. V√©rifiez votre internet.',
      serverError: 'Impossible de joindre le serveur.',
      invalidEmail: 'Veuillez entrer une adresse e-mail valide.',
      passwordTooShort: 'Le mot de passe doit comporter au moins 8 caract√®res.',
      passwordsDoNotMatch: 'Les mots de passe ne correspondent pas.',
      usernameRequired: "Le nom d'utilisateur est requis.",
      passwordRequired: 'Le mot de passe est requis.'
    },
    alerts: { forgotPassword: "La fonction de mot de passe oubli√© arrive bient√¥t." },
    passwordStrength: { weak: 'Mot de passe faible', medium: 'Mot de passe moyen', strong: 'Mot de passe fort' },
    passwordMatch: { match: 'Les mots de passe correspondent', noMatch: 'Les mots de passe ne correspondent pas' },
    auth: { loginSuccess: 'Connexion r√©ussie ! Redirection...', signupSuccess: 'Compte cr√©√© ! Redirection...' }
  },
  de: {
    pageTitle: 'Flux On | Premium Arbeitsbereich',
    tabs: { signup: 'Registrieren', login: 'Anmelden' },
    labels: { username: 'Benutzername', email: 'E-Mail-Adresse', password: 'Passwort', confirmPassword: 'Passwort best√§tigen' },
    placeholders: { username: 'Benutzernamen w√§hlen', email: 'name@unternehmen.com', password: 'Min. 8 Zeichen', loginPassword: 'Passwort eingeben', confirmPassword: 'Passwort best√§tigen' },
    buttons: { signup: 'Arbeitsbereich erstellen', login: 'Anmelden', authenticating: 'Anmeldung...', signingUp: 'Konto wird erstellt...' },
    links: { forgotPassword: 'Passwort vergessen?' },
    errors: {
      wrongCredentials: '<b>Falsche E-Mail oder falsches Passwort.</b>',
      connectionFailed: 'Verbindung fehlgeschlagen.',
      serverError: 'Server nicht erreichbar.',
      invalidEmail: 'Bitte g√ºltige E-Mail-Adresse eingeben.',
      passwordTooShort: 'Passwort muss mindestens 8 Zeichen haben.',
      passwordsDoNotMatch: 'Passw√∂rter stimmen nicht √ºberein.',
      usernameRequired: 'Benutzername ist erforderlich.',
      passwordRequired: 'Passwort ist erforderlich.'
    },
    alerts: { forgotPassword: 'Passwort vergessen Funktion kommt bald.' },
    passwordStrength: { weak: 'Schwaches Passwort', medium: 'Mittleres Passwort', strong: 'Starkes Passwort' },
    passwordMatch: { match: 'Passw√∂rter stimmen √ºberein', noMatch: 'Passw√∂rter stimmen nicht √ºberein' },
    auth: { loginSuccess: 'Anmeldung erfolgreich! Weiterleitung...', signupSuccess: 'Konto erstellt! Weiterleitung...' }
  },
  pt: {
    pageTitle: 'Flux On | Espa√ßo de Trabalho Premium',
    tabs: { signup: 'Registar', login: 'Entrar' },
    labels: { username: 'Nome de utilizador', email: 'Endere√ßo de e-mail', password: 'Palavra-passe', confirmPassword: 'Confirmar palavra-passe' },
    placeholders: { username: 'Escolha um nome de utilizador', email: 'nome@empresa.com', password: 'M√≠n. 8 caracteres', loginPassword: 'Digite a sua palavra-passe', confirmPassword: 'Confirme a sua palavra-passe' },
    buttons: { signup: 'Criar Espa√ßo de Trabalho', login: 'Entrar', authenticating: 'A autenticar...', signingUp: 'A criar conta...' },
    links: { forgotPassword: 'Esqueceu a palavra-passe?' },
    errors: {
      wrongCredentials: '<b>E-mail ou palavra-passe incorretos.</b>',
      connectionFailed: 'Falha na conex√£o. Verifique sua internet.',
      serverError: 'N√£o foi poss√≠vel conectar ao servidor.',
      invalidEmail: 'Por favor insira um e-mail v√°lido.',
      passwordTooShort: 'A palavra-passe deve ter pelo menos 8 caracteres.',
      passwordsDoNotMatch: 'As palavras-passe n√£o coincidem.',
      usernameRequired: 'O nome de utilizador √© obrigat√≥rio.',
      passwordRequired: 'A palavra-passe √© obrigat√≥ria.'
    },
    alerts: { forgotPassword: 'A fun√ß√£o de recupera√ß√£o de senha estar√° dispon√≠vel em breve.' },
    passwordStrength: { weak: 'Senha fraca', medium: 'Senha m√©dia', strong: 'Senha forte' },
    passwordMatch: { match: 'As senhas coincidem', noMatch: 'As senhas n√£o coincidem' },
    auth: { loginSuccess: 'Login efetuado! A redirecionar...', signupSuccess: 'Conta criada! A redirecionar...' }
  },
  yo: {
    pageTitle: 'Flux On | Ibi I·π£·∫π Oke',
    tabs: { signup: 'Foruk·ªçsil·∫π', login: 'W·ªçle' },
    labels: { username: 'Oruk·ªç Olumulo', email: 'Adir·∫πsi Imeeli', password: '·ªår·ªç igbaniw·ªçle', confirmPassword: 'J·∫πrisi ·ªår·ªç igbaniw·ªçle' },
    placeholders: { username: 'Yan oruk·ªç olumulo', email: 'oruko@ile-i·π£·∫π.com', password: 'O kere 8 ohun kik·ªç', loginPassword: 'T·∫π ·ªçr·ªç igbaniw·ªçle r·∫π', confirmPassword: 'J·∫πrisi ·ªçr·ªç igbaniw·ªçle r·∫π' },
    buttons: { signup: '·π¢·∫πda Ibi I·π£·∫π', login: 'W·ªçle', authenticating: '·π¢i·π£ay·∫πwo...', signingUp: '·π¢i·π£·∫πda ak·ªç·ªçl·∫π...' },
    links: { forgotPassword: 'Gbagbe ·ªçr·ªç igbaniw·ªçle?' },
    errors: {
      wrongCredentials: '<b>Imeeli tabi ·ªçr·ªç igbaniw·ªçle ti ko t·ªç.</b>',
      connectionFailed: 'Asop·ªç kuna. ·π¢ay·∫πwo intan·∫π·∫πti r·∫π.',
      serverError: 'Ko le de olupin. Gbiyanju l·∫π·∫πkansi.',
      invalidEmail: 'J·ªçw·ªç t·∫π imeeli to t·ªç sii.',
      passwordTooShort: '·ªår·ªç igbaniw·ªçle gb·ªçd·ªç ni o kere 8 ohun kik·ªç.',
      passwordsDoNotMatch: 'Aw·ªçn ·ªçr·ªç igbaniw·ªçle ko baramu.',
      usernameRequired: 'Oruk·ªç olumulo j·∫π dandan.',
      passwordRequired: '·ªår·ªç igbaniw·ªçle j·∫π dandan.'
    },
    alerts: { forgotPassword: 'I·π£·∫π gbagbe ·ªçr·ªç igbaniw·ªçle mb·ªç laip·∫π.' },
    passwordStrength: { weak: '·ªår·ªç igbaniw·ªçle alailagbara', medium: '·ªår·ªç igbaniw·ªçle aarin', strong: '·ªår·ªç igbaniw·ªçle lagbara' },
    passwordMatch: { match: 'Aw·ªçn ·ªçr·ªç igbaniw·ªçle baramu', noMatch: 'Aw·ªçn ·ªçr·ªç igbaniw·ªçle ko baramu' },
    auth: { loginSuccess: 'W·ªçle ·π£a·π£ey·ªçri! Nfiran·π£·∫π...', signupSuccess: 'Ak·ªç·ªçl·∫π ·π£·∫πda! Nfiran·π£·∫π...' }
  },
  ha: {
    pageTitle: 'Flux On | Wurin Aiki na Farko',
    tabs: { signup: 'Yi Rajista', login: 'Shiga' },
    labels: { username: 'Sunan Mai amfani', email: 'Adireshin Imel', password: 'Kalmar sirri', confirmPassword: 'Tabbatar kalmar sirri' },
    placeholders: { username: 'Za…ìi sunan mai amfani', email: 'suna@kamfani.com', password: 'M√≠nimum 8 haruffa', loginPassword: 'Shigar da kalmar sirri', confirmPassword: 'Tabbatar da kalmar sirri' },
    buttons: { signup: '∆òir∆ôiri Wurin Aiki', login: 'Shiga', authenticating: 'Tabbatarwa...', signingUp: 'Ana ∆ôir∆ôirar asusun...' },
    links: { forgotPassword: 'Manta kalmar sirri?' },
    errors: {
      wrongCredentials: '<b>Imel ko kalmar sirri ba daidai ba.</b>',
      connectionFailed: 'Ha…óin kai ya kasa. Duba intanet …óinka.',
      serverError: 'Ba za a iya ha…óawa da sabar ba.',
      invalidEmail: 'Da fatan a shigar da imel mai inganci.',
      passwordTooShort: 'Kalmar sirri dole ta ∆ôunshi haruffa 8 a∆ôalla.',
      passwordsDoNotMatch: 'Kalmomin sirri ba su dace ba.',
      usernameRequired: 'Ana bu∆ôatar sunan mai amfani.',
      passwordRequired: 'Ana bu∆ôatar kalmar sirri.'
    },
    alerts: { forgotPassword: 'Aikin manta kalmar sirri zai zo nan ba da da…óewa ba.' },
    passwordStrength: { weak: 'Kalmar sirri mai rauni', medium: 'Kalmar sirri matsakaici', strong: 'Kalmar sirri mai ∆ôarfi' },
    passwordMatch: { match: 'Kalmomin sirri sun dace', noMatch: 'Kalmomin sirri ba su dace ba' },
    auth: { loginSuccess: 'Shiga ya yi nasara! Ana juyawa...', signupSuccess: 'An ∆ôir∆ôiri asusun! Ana juyawa...' }
  },
  ig: {
    pageTitle: 'Flux On | Ebe ·ªår·ª• D·ªã Elu',
    tabs: { signup: 'Debanye Aha', login: 'Banye' },
    labels: { username: 'Aha Onye Ojibo', email: 'Adrees·ªã Ozi Eri', password: 'Okwuntughe', confirmPassword: 'Kwenye Okwuntughe' },
    placeholders: { username: 'H·ªçr·ªç aha onye ojibo', email: 'aha@·ª•l·ªç ·ªçr·ª•.com', password: 'Obere 8 mkp·ª•r·ª• edemede', loginPassword: 'Tinye okwuntughe g·ªã', confirmPassword: 'Kwenye okwuntughe g·ªã' },
    buttons: { signup: 'Mep·ª•ta Ebe ·ªår·ª•', login: 'Banye', authenticating: 'Na-enyocha...', signingUp: 'Na-emep·ª•ta aka·ª•nt·ª•...' },
    links: { forgotPassword: 'Chefuo okwuntughe?' },
    errors: {
      wrongCredentials: '<b>Ozi eri ma ·ªç b·ª• okwuntughe ezighi ezi.</b>',
      connectionFailed: 'Njik·ªç dara ada. Lelee intanet g·ªã.',
      serverError: 'Enwegh·ªã ike iru sava.',
      invalidEmail: 'Biko tinye adrees·ªã ozi eri d·ªã ir√®.',
      passwordTooShort: 'Okwuntughe ga-enwe obere mkp·ª•r·ª• edemede 8.',
      passwordsDoNotMatch: 'Okwuntughe ab·ª•gh·ªã otu.',
      usernameRequired: 'Aha onye ojibo d·ªã mkpa.',
      passwordRequired: 'Okwuntughe d·ªã mkpa.'
    },
    alerts: { forgotPassword: '·ªår·ª• nchefuo okwuntughe ga-ab·ªãa n\'oge na-ad·ªãgh·ªã anya.' },
    passwordStrength: { weak: 'Okwuntughe ad·ªãgh·ªã ike', medium: 'Okwuntughe n\'etiti', strong: 'Okwuntughe siri ike' },
    passwordMatch: { match: 'Okwuntughe d·ªã otu', noMatch: 'Okwuntughe ab·ª•gh·ªã otu' },
    auth: { loginSuccess: '·ªå banye nke ·ªçma! Na-at·ª•ghar·ªã...', signupSuccess: 'Emep·ª•tara aka·ª•nt·ª•! Na-at·ª•ghar·ªã...' }
  }
};

// ============================================
// AVAILABLE LANGUAGES
// ============================================

const availableLanguages = {
  en: { name:'English',    native:'English',           flag:'üá∫üá∏' },
  es: { name:'Spanish',    native:'Espa√±ol',           flag:'üá™üá∏' },
  fr: { name:'French',     native:'Fran√ßais',          flag:'üá´üá∑' },
  de: { name:'German',     native:'Deutsch',           flag:'üá©üá™' },
  it: { name:'Italian',    native:'Italiano',          flag:'üáÆüáπ' },
  pt: { name:'Portuguese', native:'Portugu√™s',         flag:'üáµüáπ' },
  ru: { name:'Russian',    native:'–†—É—Å—Å–∫–∏–π',           flag:'üá∑üá∫' },
  zh: { name:'Chinese',    native:'‰∏≠Êñá',              flag:'üá®üá≥' },
  ja: { name:'Japanese',   native:'Êó•Êú¨Ë™û',            flag:'üáØüáµ' },
  ko: { name:'Korean',     native:'ÌïúÍµ≠Ïñ¥',            flag:'üá∞üá∑' },
  ar: { name:'Arabic',     native:'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©',          flag:'üá∏üá¶' },
  hi: { name:'Hindi',      native:'‡§π‡§ø‡§®‡•ç‡§¶‡•Ä',            flag:'üáÆüá≥' },
  bn: { name:'Bengali',    native:'‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ',            flag:'üáßüá©' },
  pa: { name:'Punjabi',    native:'‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä',            flag:'üáÆüá≥' },
  te: { name:'Telugu',     native:'‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å',           flag:'üáÆüá≥' },
  mr: { name:'Marathi',    native:'‡§Æ‡§∞‡§æ‡§†‡•Ä',            flag:'üáÆüá≥' },
  ta: { name:'Tamil',      native:'‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç',             flag:'üáÆüá≥' },
  ur: { name:'Urdu',       native:'ÿßÿ±ÿØŸà',             flag:'üáµüá∞' },
  fa: { name:'Persian',    native:'ŸÅÿßÿ±ÿ≥€å',            flag:'üáÆüá∑' },
  tr: { name:'Turkish',    native:'T√ºrk√ße',            flag:'üáπüá∑' },
  nl: { name:'Dutch',      native:'Nederlands',        flag:'üá≥üá±' },
  pl: { name:'Polish',     native:'Polski',            flag:'üáµüá±' },
  uk: { name:'Ukrainian',  native:'–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞',        flag:'üá∫üá¶' },
  el: { name:'Greek',      native:'ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨',         flag:'üá¨üá∑' },
  cs: { name:'Czech',      native:'ƒåe≈°tina',           flag:'üá®üáø' },
  sv: { name:'Swedish',    native:'Svenska',           flag:'üá∏üá™' },
  da: { name:'Danish',     native:'Dansk',             flag:'üá©üá∞' },
  fi: { name:'Finnish',    native:'Suomi',             flag:'üá´üáÆ' },
  no: { name:'Norwegian',  native:'Norsk',             flag:'üá≥üá¥' },
  he: { name:'Hebrew',     native:'◊¢◊ë◊®◊ô◊™',            flag:'üáÆüá±' },
  th: { name:'Thai',       native:'‡πÑ‡∏ó‡∏¢',              flag:'üáπüá≠' },
  vi: { name:'Vietnamese', native:'Ti·∫øng Vi·ªát',        flag:'üáªüá≥' },
  id: { name:'Indonesian', native:'Bahasa Indonesia',  flag:'üáÆüá©' },
  ms: { name:'Malay',      native:'Bahasa Melayu',     flag:'üá≤üáæ' },
  tl: { name:'Filipino',   native:'Filipino',          flag:'üáµüá≠' },
  sw: { name:'Swahili',    native:'Kiswahili',         flag:'üáπüáø' },
  yo: { name:'Yoruba',     native:'Yor√πb√°',            flag:'üá≥üá¨' },
  ig: { name:'Igbo',       native:'Igbo',              flag:'üá≥üá¨' },
  ha: { name:'Hausa',      native:'Hausa',             flag:'üá≥üá¨' }
};

// ============================================
// i18NEXT
// ============================================

i18next.init({
  lng: 'en',
  fallbackLng: 'en',
  debug: false,
  resources: Object.keys(translationResources).reduce((acc, lang) => {
    acc[lang] = { translation: translationResources[lang] };
    return acc;
  }, {})
}, function(err) {
  if (err) return console.error('i18next:', err);
  const urlLang = new URLSearchParams(window.location.search).get('lang');
  if (urlLang && translationResources[urlLang]) changeLanguage(urlLang);
  else translatePage();
});

function translatePage() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const t = i18next.t(el.getAttribute('data-i18n'));
    if (t && t !== el.getAttribute('data-i18n')) el.textContent = t;
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const t = i18next.t(el.getAttribute('data-i18n-placeholder'));
    if (t && t !== el.getAttribute('data-i18n-placeholder')) el.placeholder = t;
  });
  document.documentElement.lang = i18next.language;
  const title = i18next.t('pageTitle');
  if (title) document.title = title;
}

function changeLanguage(lng) {
  i18next.changeLanguage(lng, err => {
    if (err) return console.error(err);
    translatePage();
    updateLanguageDisplay(lng);
    const url = new URL(window.location);
    url.searchParams.set('lang', lng);
    window.history.replaceState({}, '', url);
    localStorage.setItem('preferredLanguage', lng);
  });
}

function updateLanguageDisplay(lng) {
  const el = document.getElementById('currentLanguage');
  if (el && availableLanguages[lng]) el.textContent = `${availableLanguages[lng].flag} ${availableLanguages[lng].native}`;
}

function populateLanguageDropdown() {
  const dropdown = document.getElementById('languageDropdown');
  if (!dropdown) return;
  const sorted = Object.entries(availableLanguages).sort((a, b) => a[1].native.localeCompare(b[1].native));
  dropdown.innerHTML = sorted.map(([code, lang]) =>
    `<div class="language-option ${code === i18next.language ? 'active' : ''}" onclick="changeLanguage('${code}')">
      ${lang.flag} ${lang.native} <span style="color:#94a3b8;">(${lang.name})</span>
    </div>`
  ).join('');
}

function toggleLanguageDropdown() {
  document.getElementById('languageDropdown').classList.toggle('show');
}

// ============================================
// INIT
// ============================================

document.addEventListener('DOMContentLoaded', async () => {
  populateLanguageDropdown();

  // Apply saved language preference synchronously before session check
  const savedLang = localStorage.getItem('preferredLanguage');
  if (savedLang && translationResources[savedLang] && savedLang !== i18next.language) {
    await new Promise(resolve => i18next.changeLanguage(savedLang, resolve));
    translatePage();
    updateLanguageDisplay(savedLang);
  }

  // Redirect to app if session already active
  await checkExistingSession();
});

document.addEventListener('click', e => {
  const dropdown = document.getElementById('languageDropdown');
  const btn = document.querySelector('.language-btn');
  if (btn && !btn.contains(e.target) && !dropdown.contains(e.target)) {
    dropdown.classList.remove('show');
  }
});

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') document.getElementById('languageDropdown').classList.remove('show');
});
</script>
</body>
</html>
