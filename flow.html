<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<!-- Security Meta Tags (ADD THESE) -->
<!-- Security Meta Tags (ADD THESE) -->
<meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
<title>Flux On Customer Manager</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
<link rel="shortcut icon" href="favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png">
<link rel="icon" type="image/png" sizes="512x512" href="android-chrome-512x512.png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<!-- i18next Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/i18next/23.7.6/i18next.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/i18next-browser-languagedetector/7.1.0/i18nextBrowserLanguageDetector.min.js"></script>
<style>
  :root {
    /* Modern Palette */
    --bg-body: #ffffff;
    --bg-surface: #ffffff;
    --bg-subtle: #f7f7f7;
    --bg-hover: #f3f4f6;
    
    --text-main: #111111;
    --text-secondary: #5f6368;
    --text-tertiary: #888888;
    
    --border-light: #e0e0e0;
    --border-strong: #000000;
    
    --color-green-bg: #dcfce7;
    --color-green-text: #166534;
    --color-yellow-bg: #fef9c3;
    --color-yellow-text: #854d0e;
    --color-red-bg: #fee2e2;
    --color-red-text: #991b1b;
    --color-blue-bg: #dbeafe;
    --color-blue-text: #1e40af;
    --whatsapp-green: #25D366;
    --whatsapp-dark: #075E54;
    --accent-blue: #2563eb;
    --email-sent: #8b5cf6;
    --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    --font-mono: 'Space Mono', monospace;
    
    --sidebar-width: 260px;
    --header-height: 70px;
    --radius-sm: 4px;
    --radius-md: 6px;
    --radius-lg: 12px;
  }
  
  * { 
    box-sizing: border-box; 
    outline: none; 
    -webkit-tap-highlight-color: transparent; 
  }
  
  body {
    margin: 0;
    padding: 0;
    font-family: var(--font-sans);
    background-color: var(--bg-body);
    color: var(--text-main);
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
  }
  
  /* --- Layout --- */
  .app-container {
    display: flex;
    min-height: 100vh;
    width: 100%;
  }
  
  /* --- Sidebar (Desktop) --- */
  .sidebar {
    width: var(--sidebar-width);
    background: var(--bg-surface);
    border-right: 1px solid var(--border-light);
    display: flex;
    flex-direction: column;
    position: fixed;
    height: 100vh;
    z-index: 1000;
    padding: 24px 16px;
    transition: transform 0.3s ease;
  }
  
  .logo-area {
    margin-bottom: 40px;
    padding: 0 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  
  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 800;
    font-size: 20px;
    letter-spacing: -0.5px;
    color: var(--text-main);
  }
  
  .logo img {
    width: 32px;
    height: 32px;
  }
  
  .nav-menu {
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex: 1;
  }
  
  .nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    color: var(--text-secondary);
    text-decoration: none;
    border-radius: var(--radius-md);
    font-weight: 500;
    font-size: 14px;
    transition: all 0.15s ease;
    cursor: pointer;
    background: transparent;
    border: none;
    width: 100%;
    text-align: left;
  }
  
  .nav-item:hover {
    background-color: var(--bg-subtle);
    color: var(--text-main);
  }
  
  .nav-item.active {
    background-color: var(--bg-subtle);
    color: var(--text-main);
    font-weight: 600;
  }
  
  .nav-item.active .nav-icon { 
    color: var(--text-main); 
  }
  
  .nav-icon { 
    font-size: 16px; 
    color: var(--text-tertiary); 
    width: 20px; 
    text-align: center; 
  }
  
  /* Sidebar Status Indicators */
  .sidebar-status-indicator {
    font-size: 12px;
    padding: 8px 12px;
    margin: 4px 0;
    color: var(--text-tertiary);
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
    background: var(--bg-subtle);
    border-radius: var(--radius-md);
  }
  
  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: currentColor;
    flex-shrink: 0;
  }
  
  /* Sidebar Legal */
  .sidebar-legal {
    margin-top: auto;
    padding-top: 12px;
    border-top: 1px solid var(--border-light);
    margin-bottom: 10px;
  }
  
  .legal-link {
    display: block;
    font-size: 12px;
    color: var(--text-tertiary);
    text-decoration: none;
    padding: 6px 12px;
    transition: color 0.2s;
  }
  
  .legal-link:hover { 
    color: var(--text-main); 
    text-decoration: underline; 
  }
  
  /* Auth Status */
  .auth-status {
    display: flex;
    flex-direction: column;
    margin: 8px 0;
    padding: 8px 12px;
    border-radius: var(--radius-md);
    background: var(--bg-subtle);
  }
  
  .auth-status-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 0;
    color: var(--text-secondary);
    font-size: 13px;
  }
  
  .auth-status-item .auth-icon {
    font-size: 14px;
    color: var(--text-tertiary);
  }
  
  /* --- Main Content --- */
  .main-content {
    flex: 1;
    margin-left: var(--sidebar-width);
    display: flex;
    flex-direction: column;
    background: var(--bg-body);
    min-height: 100vh;
    width: calc(100% - var(--sidebar-width));
  }
  
  /* --- Header --- */
  .top-header {
    height: var(--header-height);
    border-bottom: 1px solid var(--border-light);
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(5px);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 40px;
    position: sticky;
    top: 0;
    z-index: 100;
    width: 100%;
  }
  
  .header-title span { 
    font-size: 18px; 
    font-weight: 700; 
    letter-spacing: -0.5px; 
  }
  
  .header-actions { 
    display: flex; 
    align-items: center; 
    gap: 20px; 
  }
  
  /* Language Selector */
  .language-selector {
    position: relative;
    margin-right: 10px;
  }
  
  .language-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--bg-subtle);
    border: 1px solid var(--border-light);
    border-radius: 20px;
    padding: 6px 12px;
    font-size: 13px;
    cursor: pointer;
    color: var(--text-main);
    transition: all 0.2s;
  }
  
  .language-btn:hover {
    background: var(--bg-hover);
    border-color: var(--border-strong);
  }
  
  .language-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    background: #fff;
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    max-height: 400px;
    overflow-y: auto;
    width: 280px;
    display: none;
    margin-top: 5px;
  }
  
  .language-dropdown.show {
    display: block;
  }
  
  .language-option {
    padding: 10px 15px;
    cursor: pointer;
    transition: background 0.2s;
    font-size: 13px;
    border-bottom: 1px solid var(--border-light);
  }
  
  .language-option:last-child {
    border-bottom: none;
  }
  
  .language-option:hover {
    background: var(--bg-subtle);
  }
  
  .language-option.active {
    background: var(--color-blue-bg);
    color: var(--color-blue-text);
    font-weight: 600;
  }
  
  .language-dropdown::-webkit-scrollbar {
    width: 6px;
  }
  
  .language-dropdown::-webkit-scrollbar-track {
    background: var(--bg-subtle);
  }
  
  .language-dropdown::-webkit-scrollbar-thumb {
    background: var(--text-tertiary);
    border-radius: 3px;
  }
  
  .language-dropdown::-webkit-scrollbar-thumb:hover {
    background: var(--text-secondary);
  }
  
  /* Header Status Pills */
  .legal-pill {
    font-size: 11px;
    font-weight: 600;
    text-decoration: none;
    color: var(--text-secondary);
    background: var(--bg-subtle);
    padding: 6px 12px;
    border-radius: 20px;
    transition: all 0.2s;
    border: 1px solid transparent;
    white-space: nowrap;
  }
  
  .status-pill-connected {
    background: var(--color-green-bg) !important;
    color: var(--color-green-text) !important;
    border-color: var(--color-green-text) !important;
    cursor: default !important;
  }
  
  /* --- Notification Bell --- */
  .notification-btn {
    position: relative; 
    cursor: pointer; 
    padding: 8px; 
    border-radius: 50%;
    color: var(--text-secondary); 
    transition: background 0.2s; 
    display: flex; 
    align-items: center; 
    justify-content: center;
  }
  
  .notification-btn:hover { 
    background: var(--bg-subtle); 
    color: var(--text-main); 
  }
  
  .notification-icon { 
    width: 20px; 
    height: 20px; 
    stroke-width: 2px; 
  }
  
  .notification-badge {
    position: absolute; 
    top: 4px; 
    right: 4px;
    background: var(--color-red-text); 
    color: white;
    font-size: 10px; 
    font-weight: 700;
    min-width: 16px; 
    height: 16px; 
    border-radius: 8px;
    display: flex; 
    align-items: center; 
    justify-content: center;
    border: 2px solid #fff; 
    transform: scale(0); 
    transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  
  .notification-badge.show { 
    transform: scale(1); 
  }
  
  /* Profile Area */
  .profile-area {
    display: flex; 
    align-items: center; 
    gap: 10px; 
    cursor: pointer;
    padding: 4px 8px; 
    border-radius: var(--radius-md); 
    transition: background 0.2s;
  }
  
  .profile-area:hover { 
    background: var(--bg-subtle); 
  }
  
  .profile-avatar {
    width: 32px; 
    height: 32px; 
    background: var(--bg-subtle);
    border: 1px solid var(--border-light); 
    border-radius: 50%;
    display: flex; 
    align-items: center; 
    justify-content: center;
    font-size: 12px; 
    font-weight: 700;
    flex-shrink: 0;
  }
  
  .profile-info { 
    text-align: left; 
  }
  
  .profile-name { 
    font-size: 13px; 
    font-weight: 600; 
    line-height: 1.2; 
  }
  
  /* --- Page Content --- */
  .page-content { 
    padding: 40px; 
    max-width: 1200px; 
    margin: 0 auto; 
    width: 100%; 
    flex: 1; 
  }
  
  .section-content { 
    animation: fadeIn 0.3s ease-out; 
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  /* --- Cards --- */
  .welcome-card { 
    margin-bottom: 40px; 
  }
  
  .welcome-card h1 { 
    font-size: 32px; 
    font-weight: 800; 
    letter-spacing: -1px; 
    margin-bottom: 12px; 
    color: var(--text-main); 
  }
  
  .welcome-card p { 
    color: var(--text-secondary); 
    font-size: 16px; 
    max-width: 600px; 
    margin-bottom: 24px; 
  }
  
  /* Dashboard Grid */
  .dashboard-cards {
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
    gap: 24px; 
    margin-bottom: 40px;
  }
  
  .dashboard-card {
    background: #fff; 
    border: 1px solid var(--border-light); 
    padding: 24px;
    border-radius: var(--radius-md); 
    transition: all 0.2s;
    cursor: pointer;
  }
  
  .dashboard-card:hover { 
    border-color: var(--border-strong); 
    transform: translateY(-2px); 
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  }
  
  .card-header { 
    display: flex; 
    justify-content: space-between; 
    margin-bottom: 16px; 
  }
  
  .card-title { 
    font-size: 12px; 
    font-weight: 700; 
    text-transform: uppercase; 
    letter-spacing: 0.5px; 
    color: var(--text-secondary); 
  }
  
  .card-count { 
    font-size: 36px; 
    font-weight: 800; 
    line-height: 1; 
    margin-bottom: 8px; 
    letter-spacing: -1px; 
  }
  
  .card-desc { 
    font-size: 13px; 
    color: var(--text-tertiary); 
  }
  
  /* --- Buttons --- */
  .btn {
    display: inline-flex; 
    align-items: center; 
    justify-content: center; 
    gap: 8px;
    padding: 0 20px; 
    height: 48px; 
    border-radius: 4px; 
    font-weight: 600; 
    font-size: 15px;
    cursor: pointer; 
    transition: all 0.15s ease; 
    border: 1px solid transparent; 
    white-space: nowrap;
    position: relative;
    background: #fff;
  }
  
  .btn-primary { 
    background: #000; 
    color: #fff; 
    border-color: #000; 
  }
  
  .btn-primary:hover { 
    background: #333; 
    transform: translateY(-1px); 
    box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
  }
  
  .btn-secondary { 
    background: #fff; 
    color: #000; 
    border: 1px solid #ddd; 
  }
  
  .btn-secondary:hover { 
    border-color: #000; 
    background: #fcfcfc; 
  }
  
  .btn-success { 
    background: #fff; 
    color: var(--text-main); 
    border: 1px solid #ddd; 
  }
  
  .btn-success:hover { 
    border-color: #000; 
    background: var(--bg-subtle); 
  }
  
  .btn-danger-outline { 
    background: #fff; 
    color: var(--color-red-text); 
    border: 1px solid var(--color-red-bg); 
  }
  
  .btn-danger-outline:hover { 
    background: var(--color-red-bg); 
    border-color: var(--color-red-text); 
  }
  
  .btn-whatsapp { 
    background: var(--whatsapp-green); 
    color: #fff; 
    border-color: var(--whatsapp-green); 
  }
  
  .btn-whatsapp:hover { 
    background: var(--whatsapp-dark); 
    transform: translateY(-1px); 
    box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3); 
  }
  
  .btn-icon-only { 
    width: 36px; 
    height: 36px; 
    padding: 0; 
    font-size: 16px; 
    color: var(--text-secondary); 
    border: none; 
    background: transparent; 
  }
  
  .btn-icon-only:hover { 
    color: var(--color-red-text); 
    background: var(--bg-subtle); 
    border-radius: 4px; 
  }
  
  .action-buttons { 
    display: flex; 
    gap: 12px; 
    flex-wrap: wrap; 
  }
  
  /* --- Tables & Lists --- */
  .automation-card { 
    border: 1px solid var(--border-light); 
    border-radius: var(--radius-md); 
    background: #fff; 
    overflow: hidden; 
  }
  
  .automation-header { 
    padding: 24px; 
    border-bottom: 1px solid var(--border-light); 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    background: #fff; 
    flex-wrap: wrap;
    gap: 16px;
  }
  
  .automation-content { 
    padding: 24px; 
  }
  
  .simple-table { 
    width: 100%; 
    border-collapse: collapse; 
    font-size: 14px; 
  }
  
  .simple-table th { 
    text-align: left; 
    padding: 12px 16px; 
    font-weight: 600; 
    color: var(--text-secondary); 
    border-bottom: 2px solid var(--border-light); 
    font-size: 12px; 
    text-transform: uppercase; 
  }
  
  .simple-table td { 
    padding: 12px 16px; 
    border-bottom: 1px solid var(--border-light); 
    vertical-align: middle; 
  }
  
  .table-input { 
    width: 100%; 
    border: 1px solid transparent; 
    background: transparent; 
    padding: 6px; 
    border-radius: 4px; 
    font-family: inherit; 
    font-size: 14px; 
  }
  
  .table-input:hover { 
    border-color: #ddd; 
    background: #fff; 
  }
  
  .table-input:focus { 
    border-color: #000; 
    background: #fff; 
  }
  
  /* --- Forms --- */
  .message-form { 
    display: grid; 
    grid-template-columns: repeat(2, 1fr); 
    gap: 24px; 
  }
  
  .form-group { 
    margin-bottom: 20px; 
  }
  
  .form-group.full-width { 
    grid-column: 1 / -1; 
  }
  
  .form-label { 
    display: block; 
    margin-bottom: 8px; 
    font-size: 13px; 
    font-weight: 700; 
    color: var(--text-main); 
  }
  
  .form-label.required:after { 
    content: " *"; 
    color: var(--color-red-text); 
  }
  
  .form-control { 
    width: 100%; 
    padding: 12px 16px; 
    font-size: 15px; 
    border: 1px solid var(--border-light); 
    border-radius: var(--radius-sm); 
    background: #fff; 
    color: var(--text-main); 
    font-family: var(--font-sans); 
  }
  
  .form-control:focus { 
    border-color: #000; 
    box-shadow: 0 0 0 1px #000; 
  }
  
  /* --- Email List --- */
  .email-list-section { 
    border: 1px solid var(--border-light); 
    border-radius: var(--radius-md); 
    background: #fff; 
    margin-top: 24px;
  }
  
  .select-all { 
    padding: 16px 20px; 
    border-bottom: 1px solid var(--border-light); 
    background: var(--bg-subtle); 
    display: flex; 
    align-items: center; 
    gap: 12px; 
  }
  
  .email-list { 
    max-height: 400px; 
    overflow-y: auto; 
  }
  
  .email-item { 
    display: flex; 
    align-items: center; 
    gap: 16px; 
    padding: 12px 20px; 
    border-bottom: 1px solid var(--border-light); 
  }
  
  .email-checkbox { 
    width: 18px; 
    height: 18px; 
    accent-color: #000; 
    cursor: pointer; 
    flex-shrink: 0;
  }
  
  .email-info { 
    flex: 1; 
    min-width: 0;
  }
  
  .email-address { 
    font-weight: 500; 
    font-size: 14px; 
    word-break: break-all; 
  }
  
  .email-customer { 
    font-size: 12px; 
    color: var(--text-secondary); 
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .email-status { 
    font-size: 11px; 
    font-weight: 600; 
    padding: 4px 10px; 
    border-radius: 12px; 
    text-transform: uppercase; 
    white-space: nowrap;
    flex-shrink: 0;
  }
  
  .status-active { 
    background: var(--color-green-bg); 
    color: var(--color-green-text); 
  }
  
  .status-inactive { 
    background: var(--color-red-bg); 
    color: var(--color-red-text); 
  }
  
  .status-pending { 
    background: var(--color-yellow-bg); 
    color: var(--color-yellow-text); 
  }
  
  /* --- Templates --- */
  .template-selector { 
    display: flex; 
    gap: 10px; 
    margin-bottom: 24px; 
    flex-wrap: wrap; 
  }
  
  .template-btn { 
    padding: 8px 16px; 
    background: #fff; 
    border: 1px solid var(--border-light); 
    border-radius: 20px; 
    font-size: 13px; 
    font-weight: 500; 
    cursor: pointer; 
    transition: all 0.2s; 
  }
  
  .template-btn:hover { 
    border-color: #999; 
  }
  
  .template-btn.active { 
    background: #000; 
    color: #fff; 
    border-color: #000; 
  }
  
  .templates-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
    gap: 24px; 
  }
  
  .template-card { 
    border: 1px solid var(--border-light); 
    border-radius: var(--radius-md); 
    overflow: hidden; 
    background: #fff; 
    transition: all 0.2s; 
    display: flex; 
    flex-direction: column; 
  }
  
  .template-card:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
    border-color: var(--border-strong); 
  }
  
  .template-card-header { 
    padding: 16px; 
    background: var(--bg-subtle); 
    border-bottom: 1px solid var(--border-light); 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
  }
  
  .template-name { 
    font-weight: 700; 
    font-size: 15px; 
  }
  
  .template-tag { 
    font-size: 11px; 
    padding: 2px 8px; 
    border-radius: 10px; 
    background: #e5e7eb; 
    color: #374151; 
    font-weight: 600; 
  }
  
  .template-body { 
    padding: 16px; 
    flex: 1; 
    font-size: 14px; 
    color: var(--text-secondary); 
    display: -webkit-box; 
    -webkit-line-clamp: 3; 
    -webkit-box-orient: vertical; 
    overflow: hidden; 
  }
  
  .template-footer { 
    padding: 16px; 
    border-top: 1px solid var(--border-light); 
    display: flex; 
    gap: 8px; 
  }
  
  /* --- Analytics --- */
  .chart-container { 
    margin-top: 24px; 
    height: 200px; 
    display: flex; 
    align-items: flex-end; 
    gap: 12px; 
    padding-bottom: 24px; 
    border-bottom: 1px solid var(--border-light); 
  }
  
  .chart-bar-group { 
    flex: 1; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    gap: 8px; 
    height: 100%; 
    justify-content: flex-end; 
  }
  
  .chart-bar { 
    width: 100%; 
    background: #000; 
    border-radius: 4px 4px 0 0; 
    min-height: 4px; 
    transition: height 0.5s ease-out; 
  }
  
  .chart-label { 
    font-size: 12px; 
    color: var(--text-tertiary); 
  }
  
  .chart-value { 
    font-size: 12px; 
    font-weight: 700; 
    margin-bottom: 4px; 
  }
  
  .analytics-summary { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
    gap: 24px; 
    margin-bottom: 32px; 
  }
  
  .metric-box { 
    padding: 20px; 
    background: var(--bg-subtle); 
    border-radius: var(--radius-md); 
  }
  
  .metric-label { 
    font-size: 13px; 
    color: var(--text-secondary); 
    margin-bottom: 4px; 
  }
  
  .metric-value { 
    font-size: 24px; 
    font-weight: 800; 
    color: var(--text-main); 
  }
  
  .metric-trend { 
    font-size: 12px; 
    font-weight: 600; 
    margin-top: 8px; 
    display: flex; 
    align-items: center; 
    gap: 4px; 
  }
  
  .trend-up { 
    color: var(--color-green-text); 
  }
  
  .trend-down { 
    color: var(--color-red-text); 
  }
  
  /* --- Connection Cards --- */
  .google-connect-card,
  .whatsapp-connect-card {
    background: #fff;
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: 24px;
    margin-bottom: 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    transition: border-color 0.2s;
    flex-wrap: wrap;
    gap: 20px;
  }
  
  .google-connect-card:hover,
  .whatsapp-connect-card:hover { 
    border-color: var(--border-strong); 
  }
  
  .google-info,
  .whatsapp-info { 
    flex: 1;
    min-width: 250px;
  }
  
  .google-info h3,
  .whatsapp-info h3 { 
    margin: 0 0 6px 0; 
    font-size: 16px; 
    font-weight: 700; 
    color: var(--text-main); 
  }
  
  .google-info p,
  .whatsapp-info p { 
    margin: 0; 
    font-size: 13px; 
    color: var(--text-secondary); 
    max-width: 400px; 
  }
  
  .connection-status {
    margin-top: 12px; 
    font-size: 12px; 
    font-weight: 600; 
    display: inline-flex;
    align-items: center; 
    gap: 8px; 
    padding: 6px 12px; 
    border-radius: 20px;
  }
  
  .status-disconnected { 
    background: var(--color-red-bg); 
    color: var(--color-red-text); 
  }
  
  .status-connected { 
    background: var(--color-green-bg); 
    color: var(--color-green-text); 
  }
  
  /* --- Inbox Styles --- */
  .inbox-layout {
    display: grid;
    grid-template-columns: 320px 1fr;
    height: calc(100vh - 180px);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    background: #fff;
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
  }
  
  .inbox-list {
    border-right: 1px solid var(--border-light);
    overflow-y: auto;
    background: #fff;
    display: flex;
    flex-direction: column;
  }
  
  .inbox-item {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-light);
    cursor: pointer;
    transition: background 0.1s;
    position: relative;
  }
  
  .inbox-item:hover { 
    background: var(--bg-hover); 
  }
  
  .inbox-item.selected { 
    background: var(--bg-subtle); 
    border-left: 3px solid #000; 
    padding-left: 17px; 
  }
  
  .inbox-item.unread .inbox-sender,
  .inbox-item.unread .inbox-subject { 
    font-weight: 700; 
    color: #000; 
  }
  
  .inbox-item.unread::after { 
    content: ''; 
    position: absolute; 
    top: 20px; 
    right: 20px; 
    width: 8px; 
    height: 8px; 
    background: var(--accent-blue); 
    border-radius: 50%; 
  }
  
  .inbox-item-header { 
    display: flex; 
    justify-content: space-between; 
    margin-bottom: 6px; 
    align-items: baseline; 
    gap: 8px;
  }
  
  .inbox-sender { 
    font-size: 14px; 
    color: var(--text-main); 
    font-weight: 500; 
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis; 
  }
  
  .inbox-date { 
    font-size: 11px; 
    color: var(--text-tertiary); 
    font-feature-settings: "tnum"; 
    white-space: nowrap;
  }
  
  .inbox-subject { 
    font-size: 13px; 
    color: var(--text-secondary); 
    margin-bottom: 4px; 
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis; 
  }
  
  .inbox-snippet { 
    font-size: 12px; 
    color: var(--text-tertiary); 
    display: -webkit-box; 
    -webkit-line-clamp: 2; 
    -webkit-box-orient: vertical; 
    overflow: hidden; 
    line-height: 1.4; 
  }
  
  .inbox-view {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: #fff;
    height: 100%;
  }
  
  .inbox-empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-tertiary);
    gap: 16px;
    padding: 20px;
    text-align: center;
  }
  
  .empty-icon { 
    font-size: 48px; 
    opacity: 0.5; 
  }
  
  .inbox-toolbar { 
    padding: 12px 24px; 
    border-bottom: 1px solid var(--border-light); 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    background: #fff; 
    flex-wrap: wrap;
    gap: 12px;
  }
  
  .inbox-view-content { 
    overflow-y: auto; 
    flex: 1; 
  }
  
  .inbox-view-header {
    padding: 32px 32px 24px 32px;
    border-bottom: 1px solid var(--bg-subtle);
  }
  
  .view-subject { 
    font-size: 24px; 
    font-weight: 700; 
    margin-bottom: 20px; 
    line-height: 1.2; 
    letter-spacing: -0.5px; 
    word-break: break-word;
  }
  
  .view-meta { 
    display: flex; 
    align-items: flex-start; 
    gap: 16px; 
    flex-wrap: wrap;
  }
  
  .view-avatar { 
    width: 48px; 
    height: 48px; 
    background: linear-gradient(135deg, #e0e0e0, #f5f5f5); 
    color: #000; 
    border-radius: 50%; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    font-weight: 700; 
    font-size: 16px; 
    border: 1px solid var(--border-light); 
    flex-shrink: 0;
  }
  
  .view-info { 
    flex: 1; 
    min-width: 200px;
  }
  
  .view-sender-name { 
    font-weight: 600; 
    font-size: 15px; 
    color: var(--text-main); 
  }
  
  .view-sender-email { 
    font-size: 13px; 
    color: var(--text-tertiary); 
    margin-top: 2px; 
    word-break: break-all;
  }
  
  .view-timestamp { 
    font-size: 12px; 
    color: var(--text-tertiary); 
    background: var(--bg-subtle); 
    padding: 4px 8px; 
    border-radius: 4px; 
    white-space: nowrap;
  }
  
  .inbox-view-body { 
    padding: 32px; 
    line-height: 1.7; 
    font-size: 15px; 
    color: var(--text-main); 
    max-width: 800px; 
    word-break: break-word;
  }
  
  .inbox-view-body img { 
    max-width: 100%; 
    height: auto; 
    border-radius: 4px; 
  }
  
  /* --- Sent Emails Styles --- */
  .sent-emails-list {
    max-height: 500px;
    overflow-y: auto;
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
  }
  
  .sent-email-item {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-light);
    transition: background 0.2s;
  }
  
  .sent-email-item:last-child {
    border-bottom: none;
  }
  
  .sent-email-item:hover {
    background: var(--bg-subtle);
  }
  
  .sent-email-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-weight: 600;
  }
  
  .sent-email-subject {
    color: var(--text-main);
  }
  
  .sent-email-date {
    font-size: 12px;
    color: var(--text-tertiary);
  }
  
  .sent-email-recipients {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }
  
  .recipient-tag {
    background: var(--bg-subtle);
    padding: 2px 8px;
    border-radius: 16px;
    font-size: 11px;
    color: var(--text-secondary);
    border: 1px solid var(--border-light);
  }
  
  .sent-email-campaign {
    font-size: 12px;
    color: var(--text-tertiary);
    display: inline-block;
    background: var(--color-blue-bg);
    color: var(--color-blue-text);
    padding: 2px 8px;
    border-radius: 16px;
    margin-top: 4px;
  }
  
  .empty-sent {
    padding: 40px;
    text-align: center;
    color: var(--text-tertiary);
  }
  
  /* --- Settings --- */
  .settings-container { 
    max-width: 800px; 
  }
  
  .settings-group { 
    margin-bottom: 32px; 
    padding-bottom: 32px; 
    border-bottom: 1px solid var(--border-light); 
  }
  
  .settings-group:last-child { 
    border-bottom: none; 
  }
  
  .settings-title { 
    font-size: 18px; 
    font-weight: 700; 
    margin-bottom: 16px; 
  }
  
  .toggle-row { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    padding: 12px 0; 
    gap: 20px;
    flex-wrap: wrap;
  }
  
  .toggle-label { 
    font-weight: 500; 
    font-size: 15px; 
  }
  
  .toggle-desc { 
    font-size: 13px; 
    color: var(--text-tertiary); 
  }
  
  /* Toggle Switch */
  .switch { 
    position: relative; 
    display: inline-block; 
    width: 44px; 
    height: 24px; 
    flex-shrink: 0;
  }
  
  .switch input { 
    opacity: 0; 
    width: 0; 
    height: 0; 
  }
  
  .slider { 
    position: absolute; 
    cursor: pointer; 
    top: 0; 
    left: 0; 
    right: 0; 
    bottom: 0; 
    background-color: #ccc; 
    transition: .4s; 
    border-radius: 24px; 
  }
  
  .slider:before { 
    position: absolute; 
    content: ""; 
    height: 18px; 
    width: 18px; 
    left: 3px; 
    bottom: 3px; 
    background-color: white; 
    transition: .4s; 
    border-radius: 50%; 
  }
  
  input:checked + .slider { 
    background-color: #000; 
  }
  
  input:checked + .slider:before { 
    transform: translateX(20px); 
  }
  
  /* --- WhatsApp Styles --- */
  .whatsapp-connect-prompt {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
    text-align: center;
    background: #fff;
    border-radius: var(--radius-lg);
    border: 1px dashed var(--border-light);
  }
  
  .whatsapp-connect-icon {
    font-size: 64px;
    margin-bottom: 24px;
    opacity: 0.7;
    color: var(--whatsapp-green);
  }
  
  .whatsapp-connect-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 12px;
    color: var(--text-main);
  }
  
  .whatsapp-connect-description {
    color: var(--text-secondary);
    margin-bottom: 24px;
    max-width: 500px;
    line-height: 1.6;
  }
  
  .whatsapp-instructions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin: 40px 0;
  }
  
  .instruction-card {
    background: var(--bg-subtle);
    border-radius: var(--radius-md);
    padding: 24px;
    text-align: center;
  }
  
  .instruction-card h3 {
    font-size: 18px;
    margin-bottom: 15px;
    color: var(--text-main);
  }
  
  .qr-code {
    background: #fff;
    padding: 20px;
    border-radius: var(--radius-md);
    display: inline-block;
    margin-bottom: 15px;
    border: 1px solid var(--border-light);
  }
  
  .qr-code img {
    width: 200px;
    height: 200px;
    max-width: 100%;
    height: auto;
  }
  
  .whatsapp-number {
    background: #fff;
    padding: 15px;
    border-radius: var(--radius-md);
    margin: 15px 0;
    border: 1px solid var(--border-light);
  }
  
  .whatsapp-number code {
    font-family: var(--font-mono);
    font-size: 20px;
    font-weight: 700;
    color: var(--whatsapp-dark);
    word-break: break-all;
  }
  
  .message-example {
    background: #e5f5e9;
    border-left: 4px solid var(--whatsapp-green);
    padding: 15px;
    border-radius: var(--radius-sm);
    font-family: var(--font-mono);
    font-size: 14px;
    margin-top: 10px;
    word-break: break-all;
  }
  
  .whatsapp-header-connected {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 16px 20px;
    background: #e5f5e9;
    border-radius: var(--radius-md);
    color: var(--whatsapp-dark);
    border: 1px solid var(--whatsapp-green);
    flex-wrap: wrap;
    gap: 12px;
  }
  
  .whatsapp-header-connected .btn-link {
    background: transparent;
    border: 1px solid var(--whatsapp-dark);
    color: var(--whatsapp-dark);
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  
  .whatsapp-header-connected .btn-link:hover {
    background: var(--whatsapp-dark);
    color: white;
  }
  
  /* --- Modal --- */
  .modal { 
    display: none; 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(255,255,255,0.8); 
    backdrop-filter: blur(4px); 
    z-index: 2000; 
    align-items: center; 
    justify-content: center; 
    padding: 20px;
  }
  
  .modal-content { 
    background: #fff; 
    width: 100%; 
    max-width: 550px; 
    padding: 40px; 
    border: 1px solid var(--border-light); 
    border-radius: var(--radius-lg); 
    box-shadow: 0 20px 40px rgba(0,0,0,0.1); 
    animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); 
    max-height: 90vh; 
    overflow-y: auto; 
  }
  
  @keyframes slideUp { 
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; } 
  }
  
  /* --- Loading States --- */
  @keyframes spin { 
    0% { transform: rotate(0deg); } 
    100% { transform: rotate(360deg); } 
  }
  
  .btn-spinner {
    width: 16px; 
    height: 16px;
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 0.8s linear infinite;
    display: inline-block;
    margin-right: 8px;
    vertical-align: middle;
  }
  
  .btn-secondary .btn-spinner,
  .btn-success .btn-spinner {
    border-color: rgba(0,0,0,0.1);
    border-top-color: #000;
  }
  
  .loader-overlay {
    position: fixed;
    top: 0; 
    left: 0; 
    width: 100vw; 
    height: 100vh;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(5px);
    z-index: 3000;
    display: none;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }
  
  .loader-spinner {
    width: 50px; 
    height: 50px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #000;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 16px;
  }
  
  .loader-text {
    font-weight: 600;
    color: var(--text-main);
  }
  
  /* Mobile Menu Elements */
  .mobile-menu-btn {
    display: none;
    background: transparent;
    border: none;
    padding: 8px;
    margin-right: 12px;
    cursor: pointer;
    color: var(--text-main);
  }
  
  .mobile-close-btn {
    display: none;
    background: transparent;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-secondary);
    line-height: 1;
    padding: 0 4px;
  }
  
  .mobile-close-btn:hover {
    color: var(--text-main);
  }
  
  .mobile-overlay {
    position: fixed;
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 900;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
    backdrop-filter: blur(2px);
  }
  
  .mobile-overlay.active {
    opacity: 1;
    pointer-events: auto;
  }
  
  .mobile-back-btn {
    display: none;
  }
  
  /* Login Required Modal */
  .login-required-modal .modal-content {
    max-width: 400px;
    text-align: center;
  }
  
  .login-required-icon {
    font-size: 48px;
    margin-bottom: 16px;
  }
  
  .login-required-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 12px;
  }
  
  .login-required-text {
    color: var(--text-secondary);
    margin-bottom: 24px;
  }
  
  .login-required-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
  }
  
  .login-required-buttons .btn {
    flex: 1;
  }
  
  /* Stats Grid */
  .stats-grid {
    display: flex;
    gap: 24px;
  }
  
  .stat-item {
    text-align: center;
  }
  
  .stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-main);
  }
  
  .stat-label {
    font-size: 12px;
    color: var(--text-secondary);
  }
  
  /* Form Actions */
  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 24px;
  }
  
  /* Data Count */
  .data-count {
    color: var(--text-tertiary);
    margin-left: 8px;
  }
  
  /* Responsive Styles */
  @media (max-width: 1024px) {
    .page-content {
      padding: 30px 20px;
    }
    
    .inbox-layout {
      height: calc(100vh - 160px);
    }
  }
  
  @media (max-width: 768px) {
    /* Layout Reset */
    .app-container { 
      flex-direction: column; 
    }
    
    .main-content { 
      margin-left: 0; 
      width: 100%; 
    }
    
    /* Header Adjustments */
    .top-header { 
      padding: 0 16px; 
      height: 60px; 
      position: sticky;
      top: 0;
      background: rgba(255,255,255,0.95);
      z-index: 100;
    }
    
    .mobile-menu-btn { 
      display: block; 
    }
    
    /* Hide non-essential header items on mobile */
    #btnRefresh, 
    .profile-info, 
    #headerGoogleStatus,
    #headerWhatsAppStatus { 
      display: none !important; 
    }
    
    /* Sidebar Mobile Styles */
    .sidebar { 
      position: fixed;
      top: 0;
      left: -280px;
      width: 280px;
      height: 100vh;
      z-index: 1100;
      box-shadow: none;
      border-right: none;
      padding: 20px 16px;
      background: #fff;
    }
    
    .sidebar.active {
      transform: translateX(280px);
      box-shadow: 4px 0 15px rgba(0,0,0,0.1);
    }
    
    .mobile-close-btn { 
      display: block; 
    }
    
    .logo-area {
      margin-bottom: 20px;
      padding: 0;
    }
    
    /* Page Content Mobile */
    .page-content { 
      padding: 20px 16px; 
    }
    
    .welcome-card h1 { 
      font-size: 24px; 
    }
    
    .welcome-card p { 
      font-size: 14px; 
    }
    
    .card-count { 
      font-size: 28px; 
    }
    
    .dashboard-cards { 
      grid-template-columns: 1fr; 
      gap: 16px; 
    }
    
    .action-buttons { 
      flex-direction: column; 
      width: 100%; 
      gap: 12px; 
    }
    
    .btn { 
      width: 100%; 
    }
    
    .stats-grid { 
      gap: 16px; 
      justify-content: space-between; 
    }
    
    .message-form { 
      grid-template-columns: 1fr; 
      gap: 16px; 
    }
    
    .automation-header { 
      flex-direction: column; 
      align-items: flex-start; 
      gap: 16px; 
    }
    
    .automation-header .action-buttons,
    .automation-header .btn { 
      width: 100%; 
    }
    
    /* Modal Mobile */
    .modal { 
      align-items: flex-end; 
      padding: 0;
    }
    
    .modal-content { 
      width: 100%; 
      border-radius: 12px 12px 0 0; 
      padding: 24px; 
      max-height: 85vh;
      animation: slideUpMobile 0.3s ease-out;
    }
    
    @keyframes slideUpMobile { 
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; } 
    }
    
    .modal-content .form-actions { 
      display: flex; 
      flex-direction: column-reverse; 
      gap: 12px; 
      margin-top: 24px; 
    }
    
    .modal-content .form-actions .btn { 
      margin-left: 0 !important; 
    }
    
    /* Templates Mobile */
    .templates-grid { 
      grid-template-columns: 1fr; 
    }
    
    /* Inbox Mobile */
    .inbox-layout { 
      grid-template-columns: 1fr; 
      border: none; 
      height: calc(100vh - 120px); 
      box-shadow: none; 
    }
    
    .inbox-list { 
      border-right: none; 
      height: 100%; 
    }
    
    .inbox-view { 
      position: fixed; 
      top: 60px; 
      left: 0; 
      width: 100%; 
      height: calc(100vh - 60px); 
      z-index: 950; 
      transform: translateX(100%); 
      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); 
      display: flex; 
      background: #fff;
    }
    
    .inbox-view.active { 
      transform: translateX(0); 
    }
    
    .mobile-back-btn { 
      display: inline-flex !important; 
      margin-right: 12px; 
    }
    
    .inbox-toolbar { 
      padding: 8px 16px; 
    }
    
    .inbox-view-header {
      padding: 20px;
    }
    
    .view-subject {
      font-size: 20px;
    }
    
    .inbox-view-body {
      padding: 20px;
    }
    
    /* Connection Cards Mobile */
    .google-connect-card,
    .whatsapp-connect-card { 
      flex-direction: column; 
      align-items: flex-start; 
      gap: 20px; 
    }
    
    .google-connect-card .btn,
    .whatsapp-connect-card .btn { 
      width: 100%; 
      justify-content: center; 
    }
    
    /* WhatsApp Mobile */
    .whatsapp-instructions { 
      grid-template-columns: 1fr; 
      gap: 20px;
    }
    
    .whatsapp-connect-prompt {
      padding: 30px 20px;
    }
    
    .whatsapp-connect-title {
      font-size: 20px;
    }
    
    .qr-code img {
      width: 150px;
      height: 150px;
    }
    
    .whatsapp-number code {
      font-size: 16px;
    }
    
    .whatsapp-header-connected {
      flex-direction: column;
      align-items: flex-start;
    }
    
    /* Email List Mobile */
    .email-item {
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .email-info {
      width: calc(100% - 34px);
    }
    
    .email-status {
      margin-left: 34px;
    }
    
    /* Tables Mobile */
    .simple-table {
      display: block;
      overflow-x: auto;
      white-space: nowrap;
    }
    
    .simple-table td,
    .simple-table th {
      white-space: nowrap;
    }
    
    /* Settings Mobile */
    .toggle-row {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .switch {
      align-self: flex-start;
    }
  }
  
  /* Small phones */
  @media (max-width: 480px) {
    .page-content {
      padding: 16px 12px;
    }
    
    .inbox-item {
      padding: 12px 16px;
    }
    
    .inbox-item.unread::after {
      top: 16px;
      right: 16px;
    }
    
    .view-meta {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .view-avatar {
      width: 40px;
      height: 40px;
      font-size: 14px;
    }
    
    .view-timestamp {
      align-self: flex-start;
    }
    
    .instruction-card {
      padding: 16px;
    }
    
    .qr-code {
      padding: 15px;
    }
    
    .qr-code img {
      width: 120px;
      height: 120px;
    }
  }
</style>
<!-- Security Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>
</head>
<body>

<div class="loader-overlay" id="globalLoader">
    <div class="loader-spinner"></div>
    <div class="loader-text" id="loaderText">Processing...</div>
</div>

<div class="app-container">
  
  <div class="mobile-overlay" id="mobileOverlay" onclick="toggleMobileMenu()"></div>

  <aside class="sidebar" id="mainSidebar" aria-label="Main navigation">
    <div class="logo-area">
      <div class="logo" style="column-gap: 2px;">
        <div style="background-color: transparent; width: fit-content;" aria-hidden="true"><img src="favicon.ico"></div>
        <span>Flux On</span>
      </div>
      <button class="mobile-close-btn" onclick="toggleMobileMenu()">√ó</button>
    </div>
    
    <nav class="nav-menu" aria-label="Primary navigation">
      <a href="#dashboard" class="nav-item active" onclick="showSection('dashboard'); closeMobileMenu();" aria-current="page" data-i18n="nav.dashboard">
        <span class="nav-icon">üìä</span>
        <span>Dashboard</span>
      </a>
      <a href="#customers" class="nav-item" onclick="showSection('customers'); closeMobileMenu();" data-i18n="nav.customers">
        <span class="nav-icon">üë•</span>
        <span>Customers</span>
      </a>
      <a href="#inbox" class="nav-item" onclick="showSection('inbox'); closeMobileMenu();" data-i18n="nav.inbox">
        <span class="nav-icon">üì•</span>
        <span>Inbox</span>
      </a>
      <a href="#automation" class="nav-item" onclick="showSection('automation'); closeMobileMenu();" data-i18n="nav.automation">
        <span class="nav-icon">‚ö°</span>
        <span>Automation</span>
      </a>
      <a href="#whatsapp" class="nav-item" onclick="showSection('whatsapp'); closeMobileMenu();" data-i18n="nav.whatsapp">
        <span class="nav-icon">üì±</span>
        <span>WhatsApp</span>
      </a>
      <a href="#sent" class="nav-item" onclick="showSection('sent'); closeMobileMenu();" data-i18n="nav.sent">
        <span class="nav-icon">üì§</span>
        <span>Sent Emails</span>
      </a>
      <a href="#analytics" class="nav-item" onclick="showSection('analytics'); closeMobileMenu();" data-i18n="nav.analytics">
        <span class="nav-icon">üìà</span>
        <span>Analytics</span>
      </a>
      <a href="#templates" class="nav-item" onclick="showSection('templates'); closeMobileMenu();" data-i18n="nav.templates">
        <span class="nav-icon">üìù</span>
        <span>Templates</span>
      </a>
      <a href="#settings" class="nav-item" onclick="showSection('settings'); closeMobileMenu();" data-i18n="nav.settings">
        <span class="nav-icon">‚öôÔ∏è</span>
        <span>Settings</span>
      </a>
    </nav>
    
    <div class="auth-status" id="mobileAuthStatus">
      <div class="auth-status-item">
        <span class="auth-icon">üîí</span>
        <span data-i18n="auth.notSignedIn">Not signed in</span>
      </div>
    </div>
    
    <div id="sidebarGoogleStatus" class="sidebar-status-indicator">
        <div style="width: 8px; height: 8px; border-radius: 50%; background: #ccc;"></div>
        <span data-i18n="status.gmailNotLinked">Gmail: Not Linked</span>
    </div>
    
    <div id="sidebarWhatsAppStatus" class="sidebar-status-indicator" style="margin-top: 5px;">
        <div style="width: 8px; height: 8px; border-radius: 50%; background: #ccc;"></div>
        <span data-i18n="status.whatsappNotConnected">WhatsApp: Not Connected</span>
    </div>
    
    <div id="sidebarSentCount" class="sidebar-status-indicator" style="margin-top: 5px; background: var(--color-blue-bg); color: var(--color-blue-text);">
        <span class="nav-icon">üì§</span>
        <span id="sentCountDisplay">0 Sent</span>
    </div>
    
    <div class="sidebar-legal">
        <a href="https://seraphielspark.github.io/flowon/privacy.html" target="_blank" class="legal-link" data-i18n="legal.privacy">Privacy Policy</a>
        <a href="https://seraphielspark.github.io/flowon/terms.html" target="_blank" class="legal-link" data-i18n="legal.terms">Terms of Service</a>
    </div>
    <div class="nav-menu" style="flex: 0; margin-top: 2px;">
      <a href="#" id="logoutauth" class="nav-item" style="font-size: 12px; height: fit-content; margin: 0 0 0 0; padding: 0 0 0 0;" onclick="confirmLogout()" data-i18n="auth.logOut">
        <span class="nav-icon">‚Ü™</span>
        <span>Log Out</span>
      </a>
      <div id="signupauth">
        <a href="signup.html" class="nav-item" style="font-size: 12px; height: fit-content; margin: 0 0 0 0; padding: 0 0 0 0;" data-i18n="auth.login">
          <span class="nav-icon">‚Ü™</span>
          <span>Login To Existing Account</span>
        </a>
        <a href="signup.html" class="nav-item" style="font-size: 12px; height: fit-content; margin: 0 0 0 0; padding: 0 0 0 0;" data-i18n="auth.register">
          <span class="nav-icon">‚Ü™</span>
          <span>Register New Account</span>
        </a>
      </div>
    </div>
  </aside>
  
  <main class="main-content">
    
    <header class="top-header" role="banner">
      <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Open menu">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>

      <div class="header-title" id="pageTitle">
        <span data-i18n="titles.dashboard">Dashboard</span>
      </div>
      
      <div class="header-actions">
        <!-- Language Selector -->
        <div class="language-selector">
          <button class="language-btn" onclick="toggleLanguageDropdown()">
            <span>üåê</span>
            <span id="currentLanguage">English</span>
            <span>‚ñº</span>
          </button>
          <div class="language-dropdown" id="languageDropdown"></div>
        </div>
        
        <div id="headerGoogleStatus" class="legal-pill status-pill-connected" style="display: none;" data-i18n="status.gmailLinked">
            ‚úì Gmail Linked
        </div>
        <div id="headerWhatsAppStatus" class="legal-pill" style="display: none; background: #e5f5e9; color: var(--whatsapp-dark);" data-i18n="status.whatsappConnected">
            üì± WhatsApp Connected
        </div>
        <div class="notification-btn" onclick="showSection('inbox')" title="Notifications">
            <svg class="notification-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
            <div class="notification-badge" id="notificationBadge">0</div>
        </div>
        <button class="btn btn-secondary" id="btnRefresh" style="height: 36px; padding: 0 12px; font-size: 13px;" onclick="refreshData()" aria-label="Refresh data" data-i18n="buttons.refresh">
            Refresh
        </button>
        <div class="profile-area" onclick="showSection('settings')" role="button" tabindex="0" aria-label="User profile">
          <div class="profile-avatar" id="userInitials" aria-hidden="true">U</div>
          <div class="profile-info">
            <div class="profile-name" id="profileName">User</div>
          </div>
        </div>
      </div>
    </header>
    
    <div class="page-content">
      
      <!-- Dashboard Section -->
      <section id="dashboardSection" class="section-content" aria-labelledby="dashboardTitle">
        <div class="welcome-card">
          <h1 id="dashboardTitle"><span data-i18n="dashboard.hello">Hello,</span> <span id="userGreeting">User</span>.</h1>
          <p data-i18n="dashboard.description">Here is your overview. Manage customers and automate flows.</p>
          <div class="action-buttons">
            <button class="btn btn-primary" onclick="requireAuth('automation')" data-i18n="dashboard.startAutomation">
              Start Automation
            </button>
            <button class="btn btn-secondary" onclick="requireAuth('customers')" data-i18n="dashboard.manageCustomers">
              Manage Customers
            </button>
          </div>
        </div>
        
        <div class="dashboard-cards">
          <div class="dashboard-card" onclick="requireAuth('customers')" style="cursor: pointer;">
            <div class="card-header">
              <div class="card-title" data-i18n="dashboard.totalCustomers">Total Customers</div>
              <div class="card-icon">üë•</div>
            </div>
            <div class="card-count" id="totalCustomers" aria-live="polite">0</div>
            <div class="card-desc" data-i18n="dashboard.activeInDatabase">Active in database</div>
          </div>
          
          <div class="dashboard-card" onclick="requireAuth('inbox')" style="cursor: pointer;">
            <div class="card-header">
              <div class="card-title" data-i18n="dashboard.inbox">Inbox</div>
              <div class="card-icon">üì•</div>
            </div>
            <div class="card-count" id="unreadStats" aria-live="polite">0</div>
            <div class="card-desc" data-i18n="dashboard.unreadMessages">Unread messages</div>
          </div>
          
          <div class="dashboard-card" onclick="requireAuth('automation')" style="cursor: pointer;">
            <div class="card-header">
              <div class="card-title" data-i18n="dashboard.activeCampaigns">Active Campaigns</div>
              <div class="card-icon">‚ö°</div>
            </div>
            <div class="card-count" id="activeCampaigns" aria-live="polite">0</div>
            <div class="card-desc" data-i18n="dashboard.workflowsRunning">Workflows running</div>
          </div>
          
          <div class="dashboard-card" onclick="requireAuth('sent')" style="cursor: pointer;">
            <div class="card-header">
              <div class="card-title" data-i18n="dashboard.sentEmails">Sent Emails</div>
              <div class="card-icon">üì§</div>
            </div>
            <div class="card-count" id="sentEmailsCount" aria-live="polite">0</div>
            <div class="card-desc" data-i18n="dashboard.totalSent">Total sent</div>
          </div>
        </div>
        
        <div class="automation-card">
          <div class="automation-header">
            <h2 data-i18n="dashboard.quickActions">Quick Actions</h2>
          </div>
          <div class="automation-content">
            <div class="action-buttons">
              <button class="btn btn-secondary" onclick="requireAuth('automation')" data-i18n="dashboard.createWelcomeSeries">
                üéâ Create Welcome Series
              </button>
              <button class="btn btn-secondary" onclick="requireAuth('automation')" data-i18n="dashboard.sendFollowUp">
                üîÑ Send Follow-up
              </button>
            </div>
          </div>
        </div>
      </section>
      
      <!-- Customers Section -->
      <section id="customersSection" class="section-content" aria-labelledby="customersTitle" style="display: none;">
        <div class="welcome-card">
          <div style="display: flex; flex-direction: column; gap: 16px;">
            <div>
              <h1 id="customersTitle" data-i18n="titles.customers">Customers</h1>
              <p data-i18n="customers.description">View and manage your subscriber database.</p>
            </div>
            <div class="action-buttons">
               <button class="btn btn-secondary" onclick="exportCustomers()" data-i18n="customers.exportCSV">Export CSV</button>
               <button class="btn btn-secondary" onclick="importCustomers()" data-i18n="customers.importCSV">Import CSV</button>
               <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
               <button class="btn btn-primary" onclick="addNewCustomer()" data-i18n="customers.addCustomer">+ Add Customer</button>
            </div>
          </div>
        </div>
        
        <div class="automation-card">
          <div class="automation-header">
            <span class="card-title" style="margin: 0; font-size: 14px;"><span data-i18n="customers.allRecords">All Records</span> <span class="data-count" id="customerCount" style="color: var(--text-tertiary); margin-left: 8px;">(0)</span></span>
            <button class="btn btn-success" id="btnSaveChanges" style="height: 36px;" onclick="saveAllChanges()" data-i18n="customers.saveChanges">
              Save Changes
            </button>
          </div>
          
          <div id="tableContainer" style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
            <div style="padding: 40px; text-align: center; color: var(--text-tertiary);" data-i18n="customers.loading">
              Loading data...
            </div>
          </div>
        </div>
      </section>
      
      <!-- Inbox Section -->
      <section id="inboxSection" class="section-content" aria-labelledby="inboxTitle" style="display: none;">
        <div class="welcome-card" style="margin-bottom: 24px;">
           <h1 id="inboxTitle" data-i18n="inbox.title">Inbox</h1>
           <p data-i18n="inbox.description">Messages from your audience.</p>
        </div>
        
        <!-- Google Connection Status & Prompt -->
        <div id="inboxConnectContainer" style="display: none;">
          <div class="google-connect-card" style="border-color: var(--color-red-bg);">
            <div class="google-info">
              <h3 data-i18n="inbox.connectGmail">Connect Your Gmail Account</h3>
              <p data-i18n="inbox.connectGmailDesc">To view and manage your inbox messages, you need to connect your Gmail account.</p>
              
              <div id="inboxConnectionStatus" class="connection-status status-disconnected">
                <span class="status-dot"></span>
                <span data-i18n="inbox.disconnected">Disconnected</span>
              </div>
            </div>
            
            <button id="btnConnectGmailInbox" class="btn btn-secondary" onclick="connectGoogle()">
              <svg style="width:18px; height:18px;" viewBox="0 0 24 24">
                <path fill="currentColor" d="M21.35,11.1H12.18V13.83H17.45C17.19,15.3 16.34,16.58 15.19,17.38V19.51H18.38C20.25,17.79 21.33,15.24 21.33,12.28C21.33,11.9 21.27,11.5 21.18,11.13V11.1M12.18,21.36C14.75,21.36 16.91,20.5 18.38,19.14L15.19,17.01C14.33,17.58 13.25,17.9 12.18,17.9C9.7,17.9 7.6,16.22 6.84,13.93H3.55V16.48C5.07,19.5 8.35,21.36 12.18,21.36M6.84,13.93C6.64,13.36 6.54,12.75 6.54,12.14C6.54,11.53 6.64,10.92 6.84,10.34V7.8H3.55C2.26,10.37 2.26,13.9 3.55,16.48H6.84M12.18,6.38C13.56,6.38 14.81,6.86 15.79,7.79L18.42,5.16C16.91,3.75 14.75,2.92 12.18,2.92C8.35,2.92 5.07,4.78 3.55,7.8L6.84,10.34C7.6,8.05 9.7,6.38 12.18,6.38Z" />
              </svg>
              <span data-i18n="buttons.connectGmail">Connect Gmail</span>
            </button>
          </div>
        </div>
        
        <!-- Inbox Layout -->
        <div class="inbox-layout" id="inboxLayout">
           <div class="inbox-list" id="inboxList">
               <div style="padding: 32px; text-align: center; color: var(--text-tertiary);" data-i18n="inbox.loading">Loading messages...</div>
           </div>
           <div class="inbox-view" id="inboxView">
               <div class="inbox-empty-state" id="inboxEmptyState">
                   <div class="empty-icon">üì®</div>
                   <div data-i18n="inbox.selectMessage">Select a message to read</div>
               </div>
               
               <div id="inboxContent" style="display: none; height: 100%; flex-direction: column;">
                   <div class="inbox-toolbar">
                       <div style="display: flex; align-items: center;">
                           <button class="btn btn-secondary mobile-back-btn" style="display:none; height: 32px; padding: 0 10px;" onclick="closeMobileInbox()" data-i18n="buttons.back">‚Üê Back</button>
                           <span style="font-size: 13px; color: var(--text-tertiary);" id="viewMetaToolbar" data-i18n="inbox.readingMessage">Reading Message</span>
                       </div>
                       <div style="display: flex; gap: 8px;">
                           <button class="btn btn-icon-only" onclick="sendToWhatsApp()" title="Send to WhatsApp" id="whatsappNotifyBtn" style="color: var(--whatsapp-green);" data-i18n="inbox.sendToWhatsApp">
                               <svg style="width: 18px; height: 18px;" viewBox="0 0 24 24" fill="currentColor">
                                   <path d="M19.05 4.91A9.816 9.816 0 0 0 12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.45 1.32 4.95L2.05 22l5.25-1.38c1.45.79 3.08 1.21 4.74 1.21 5.46 0 9.91-4.45 9.91-9.91 0-2.65-1.03-5.14-2.9-7.01zm-7.01 15.24c-1.48 0-2.93-.4-4.2-1.15l-.3-.18-3.12.82.83-3.04-.2-.32a8.26 8.26 0 0 1-1.26-4.38c0-4.54 3.7-8.24 8.24-8.24 2.2 0 4.27.86 5.82 2.42a8.183 8.183 0 0 1 2.41 5.83c.02 4.54-3.68 8.24-8.22 8.24z"/>
                                   <path d="M16.5 13.5c-.25-.12-1.48-.73-1.71-.81-.23-.08-.4-.12-.56.12-.16.25-.64.81-.78.98-.15.17-.29.19-.54.06-.25-.12-1.05-.39-2-1.23-.74-.66-1.24-1.47-1.38-1.72-.15-.25-.02-.38.11-.5.11-.11.25-.29.37-.44.12-.15.16-.25.25-.41.08-.16.04-.31-.02-.43-.06-.12-.56-1.35-.77-1.85-.2-.49-.4-.42-.56-.43-.14-.01-.31-.01-.48-.01-.17 0-.44.06-.67.31-.23.25-.88.86-.88 2.1 0 1.24.9 2.44 1.03 2.61.12.17 1.77 2.71 4.29 3.8.6.26 1.07.41 1.43.53.6.19 1.15.16 1.58.1.48-.07 1.48-.61 1.69-1.19.21-.58.21-1.08.15-1.19-.06-.1-.22-.16-.47-.28z"/>
                               </svg>
                           </button>
                           <button class="btn btn-icon-only" onclick="deleteCurrentMessage()" title="Delete Message" data-i18n="inbox.delete">
                               <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                           </button>
                       </div>
                   </div>
                   
                   <div class="inbox-view-content">
                       <div class="inbox-view-header">
                           <div class="view-subject" id="viewSubject"><span data-i18n="inbox.subject">Subject</span></div>
                           <div class="view-meta">
                               <div class="view-avatar" id="viewAvatar">U</div>
                               <div class="view-info">
                                   <div class="view-sender-name" id="viewSender"><span data-i18n="inbox.senderName">Sender Name</span></div>
                                   <div class="view-sender-email" id="viewEmail">sender@email.com</div>
                               </div>
                               <div class="view-timestamp" id="viewDate"><span data-i18n="inbox.today">Today</span></div>
                           </div>
                       </div>
                       <div class="inbox-view-body" id="viewBody"></div>
                   </div>
               </div>
           </div>
        </div>
      </section>
      
      <!-- Automation Section -->
      <section id="automationSection" class="section-content" aria-labelledby="automationTitle" style="display: none;">
        <div class="welcome-card">
           <h1 data-i18n="automation.title">Automation Center</h1>
           <p data-i18n="automation.description">Compose and schedule email campaigns.</p>
        </div>
        
        <div class="automation-card">
          <div class="automation-header">
            <h2 data-i18n="automation.newCampaign">New Campaign</h2>
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-value" id="selectedCount">0</div>
                <div class="stat-label" data-i18n="automation.recipients">Recipients</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="totalEmails">0</div>
                <div class="stat-label" data-i18n="automation.totalList">Total List</div>
              </div>
            </div>
          </div>
          
          <div class="automation-content">
            
            <div class="google-connect-card">
                <div class="google-info">
                    <h3 data-i18n="automation.connectGoogle">Connect Google Account</h3>
                    <p data-i18n="automation.connectGoogleDesc">Link your account to send automated emails directly via your Gmail.</p>
                    
                    <div id="connectionStatus" class="connection-status status-disconnected">
                        <span class="status-dot"></span>
                        <span data-i18n="automation.disconnected">Disconnected</span>
                    </div>
                </div>
                
                <button id="btnConnectGoogle" class="btn btn-secondary" onclick="connectGoogle()">
                    <svg style="width:18px; height:18px;" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M21.35,11.1H12.18V13.83H17.45C17.19,15.3 16.34,16.58 15.19,17.38V19.51H18.38C20.25,17.79 21.33,15.24 21.33,12.28C21.33,11.9 21.27,11.5 21.18,11.13V11.1M12.18,21.36C14.75,21.36 16.91,20.5 18.38,19.14L15.19,17.01C14.33,17.58 13.25,17.9 12.18,17.9C9.7,17.9 7.6,16.22 6.84,13.93H3.55V16.48C5.07,19.5 8.35,21.36 12.18,21.36M6.84,13.93C6.64,13.36 6.54,12.75 6.54,12.14C6.54,11.53 6.64,10.92 6.84,10.34V7.8H3.55C2.26,10.37 2.26,13.9 3.55,16.48H6.84M12.18,6.38C13.56,6.38 14.81,6.86 15.79,7.79L18.42,5.16C16.91,3.75 14.75,2.92 12.18,2.92C8.35,2.92 5.07,4.78 3.55,7.8L6.84,10.34C7.6,8.05 9.7,6.38 12.18,6.38Z" />
                    </svg>
                    <span data-i18n="buttons.connectGmail">Connect Gmail</span>
                </button>
            </div>
            
            <!-- WhatsApp Notification Toggle -->
            <div class="google-connect-card" style="margin-top: 16px; border-color: var(--whatsapp-green);">
                <div class="google-info">
                    <h3 data-i18n="automation.whatsappNotifications">WhatsApp Notifications</h3>
                    <p data-i18n="automation.whatsappDesc">Get notified on WhatsApp when you receive new emails.</p>
                    
                    <div id="whatsappStatus" class="connection-status status-disconnected">
                        <span class="status-dot"></span>
                        <span data-i18n="automation.notConnected">Not Connected</span>
                    </div>
                </div>
                
                <button id="btnSetupWhatsApp" class="btn btn-whatsapp" onclick="showSection('whatsapp')">
                    <svg style="width:18px; height:18px;" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19.05 4.91A9.816 9.816 0 0 0 12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.45 1.32 4.95L2.05 22l5.25-1.38c1.45.79 3.08 1.21 4.74 1.21 5.46 0 9.91-4.45 9.91-9.91 0-2.65-1.03-5.14-2.9-7.01zm-7.01 15.24c-1.48 0-2.93-.4-4.2-1.15l-.3-.18-3.12.82.83-3.04-.2-.32a8.26 8.26 0 0 1-1.26-4.38c0-4.54 3.7-8.24 8.24-8.24 2.2 0 4.27.86 5.82 2.42a8.183 8.183 0 0 1 2.41 5.83c.02 4.54-3.68 8.24-8.22 8.24z"/>
                    </svg>
                    <span data-i18n="automation.setupWhatsApp">Setup WhatsApp</span>
                </button>
            </div>
            
            <div class="email-list-section">
              <div class="select-all">
                <input type="checkbox" id="selectAllEmails" class="select-all-checkbox" onchange="toggleAllEmails()" aria-label="Select all customers">
                <label for="selectAllEmails" style="font-size: 14px; font-weight: 600;" data-i18n="automation.selectAll">Select All Customers</label>
              </div>
              
              <div class="email-list" id="emailList">
                <div style="padding: 24px; text-align: center;" data-i18n="customers.loading">Loading...</div>
              </div>
            </div>
            
            <div style="margin-top: 40px;">
              <h3 style="font-size: 18px; margin-bottom: 16px;" data-i18n="automation.composeMessage">Compose Message</h3>
              
              <div class="template-selector" id="automationTemplateSelector">
                <button class="template-btn" onclick="loadTemplate('custom')" data-i18n="automation.blank">Blank</button>
              </div>
              
              <form id="messageForm" class="message-form" aria-label="Message composition form">
                <div class="form-group">
                  <label class="form-label required" for="campaignName" data-i18n="automation.campaignName">Campaign Name</label>
                  <input type="text" class="form-control" id="campaignName" required placeholder="e.g. Q1 Newsletter">
                </div>
                
                <div class="form-group">
                  <label class="form-label" for="scheduleType" data-i18n="automation.schedule">Schedule</label>
                  <select class="form-control" id="scheduleType">
                    <option value="now" data-i18n="automation.sendImmediately">Send Immediately</option>
                    <option value="scheduled" data-i18n="automation.scheduleLater">Schedule for later</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label class="form-label required" for="fromName" data-i18n="automation.fromName">From Name</label>
                  <input type="text" class="form-control" id="fromName" required placeholder="Your Name">
                </div>
                
                <div class="form-group">
                  <label class="form-label required" for="fromEmail" data-i18n="automation.fromEmail">From Email</label>
                  <input type="email" class="form-control" id="fromEmail" required placeholder="you@company.com">
                </div>
                <div class="form-group" style="display: none;">
                   <label class="form-label" for="replyToEmail" data-i18n="automation.replyTo">Reply To</label>
                   <input type="email" class="form-control" id="replyToEmail">
                </div>
                
                <div class="form-group full-width">
                  <label class="form-label required" for="emailSubject" data-i18n="automation.subjectLine">Subject Line</label>
                  <input type="text" class="form-control" id="emailSubject" required placeholder="Enter a catchy subject">
                </div>
                
                <div class="form-group full-width">
                  <label class="form-label required" for="emailBody" data-i18n="automation.emailBody">Email Body</label>
                  <textarea class="form-control" id="emailBody" required placeholder="Write your message..." style="min-height: 200px;"></textarea>
                  <div style="margin-top: 8px; font-size: 12px; color: var(--text-tertiary); font-family: var(--font-mono);" data-i18n="automation.variables">
                    Variables: {name}, {email}, {company}
                  </div>
                </div>
                
                <div class="form-group" id="scheduleDateGroup" style="display: none;">
                  <label class="form-label" for="scheduleDateTime" data-i18n="automation.dateTime">Date & Time</label>
                  <input type="datetime-local" class="form-control" id="scheduleDateTime">
                </div>
                
                <div class="form-group full-width form-actions" style="display: flex; justify-content: flex-end; gap: 12px; border-top: 1px solid var(--border-light); padding-top: 24px; margin-top: 10px;">
                  <button type="button" class="btn btn-secondary" onclick="clearForm()" data-i18n="buttons.reset">Reset</button>
                  <button type="submit" class="btn btn-primary" data-i18n="buttons.previewSend">Preview & Send</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </section>
      
      <!-- WhatsApp Automation Section -->
      <section id="whatsappSection" class="section-content" aria-labelledby="whatsappTitle" style="display: none;">
        <div class="welcome-card">
          <h1 id="whatsappTitle" data-i18n="whatsapp.title">WhatsApp Automation</h1>
          <p data-i18n="whatsapp.description">Receive email notifications directly on your WhatsApp.</p>
        </div>
        
        <div class="automation-card">
          <div class="automation-header">
            <h2 data-i18n="whatsapp.connect">Connect WhatsApp</h2>
          </div>
          <div class="automation-content">
            
            <!-- Connection Status Card -->
            <div id="whatsappStatusCard">
              <div id="whatsappNotConnected" style="display: block;">
                <div class="whatsapp-connect-prompt">
                  <div class="whatsapp-connect-icon">üì±</div>
                  <div class="whatsapp-connect-title" data-i18n="whatsapp.connectTitle">Connect Your WhatsApp</div>
                  <div class="whatsapp-connect-description" data-i18n="whatsapp.connectDesc">
                    Get instant notifications on WhatsApp whenever you receive a new email. 
                    Choose one of the methods below to connect.
                  </div>
                </div>
              </div>
              
              <div id="whatsappConnected" style="display: none;">
                <div class="whatsapp-header-connected">
                  <div style="display: flex; align-items: center; gap: 12px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M19.05 4.91A9.816 9.816 0 0 0 12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.45 1.32 4.95L2.05 22l5.25-1.38c1.45.79 3.08 1.21 4.74 1.21 5.46 0 9.91-4.45 9.91-9.91 0-2.65-1.03-5.14-2.9-7.01zm-7.01 15.24c-1.48 0-2.93-.4-4.2-1.15l-.3-.18-3.12.82.83-3.04-.2-.32a8.26 8.26 0 0 1-1.26-4.38c0-4.54 3.7-8.24 8.24-8.24 2.2 0 4.27.86 5.82 2.42a8.183 8.183 0 0 1 2.41 5.83c.02 4.54-3.68 8.24-8.22 8.24z"/>
                    </svg>
                    <span style="font-weight: 600;" data-i18n="whatsapp.connected">WhatsApp Connected</span>
                    <span style="font-size: 14px;" id="whatsappNumberDisplay"></span>
                  </div>
                  <button class="btn-link" onclick="disconnectWhatsApp()" data-i18n="whatsapp.disconnect">Disconnect</button>
                </div>
              </div>
            </div>
            
            <!-- QR Code and Instructions -->
            <div class="whatsapp-instructions">
              <div class="instruction-card">
                <h3 data-i18n="whatsapp.option1">Option 1: Scan QR Code</h3>
                <div class="qr-code">
                  <img src="https://seraphielspark.github.io/flowon/download.svg" alt="WhatsApp QR Code">
                </div>
                <p style="color: var(--text-secondary); font-size: 14px;" data-i18n="whatsapp.option1Desc">
                  Open WhatsApp on your phone, tap Menu (Android) or Settings (iOS), then WhatsApp Web, and scan this QR code.
                </p>
              </div>
              
              <div class="instruction-card">
                <h3 data-i18n="whatsapp.option2">Option 2: Send Message</h3>
                <div class="whatsapp-number">
                  <code>+14155238886</code>
                </div>
                <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 10px;" data-i18n="whatsapp.option2Desc">
                  Send this exact message to the number above:
                </p>
                <div class="message-example">
                  <code>join ride-image</code>
                </div>
                <p style="color: var(--text-secondary); font-size: 12px; margin-top: 15px;" data-i18n="whatsapp.option2Note">
                  After sending the message, your WhatsApp will be automatically connected.
                </p>
              </div>
            </div>
            
            <!-- Phone Number Form -->
            <div style="margin-top: 40px; border-top: 1px solid var(--border-light); padding-top: 30px;">
              <h3 style="font-size: 18px; margin-bottom: 20px;" data-i18n="whatsapp.manualTitle">Or enter your WhatsApp number manually</h3>
              <div style="display: flex; gap: 16px; align-items: flex-end; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 250px;">
                  <label class="form-label" for="whatsappNumber" data-i18n="whatsapp.numberLabel">WhatsApp Number (with country code)</label>
                  <input type="tel" class="form-control" id="whatsappNumber" placeholder="e.g., +1234567890">
                </div>
                <button class="btn btn-whatsapp" onclick="registerWhatsApp()" style="height: 48px;">
                  <svg style="width:18px; height:18px; margin-right: 8px;" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19.05 4.91A9.816 9.816 0 0 0 12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.45 1.32 4.95L2.05 22l5.25-1.38c1.45.79 3.08 1.21 4.74 1.21 5.46 0 9.91-4.45 9.91-9.91 0-2.65-1.03-5.14-2.9-7.01zm-7.01 15.24c-1.48 0-2.93-.4-4.2-1.15l-.3-.18-3.12.82.83-3.04-.2-.32a8.26 8.26 0 0 1-1.26-4.38c0-4.54 3.7-8.24 8.24-8.24 2.2 0 4.27.86 5.82 2.42a8.183 8.183 0 0 1 2.41 5.83c.02 4.54-3.68 8.24-8.22 8.24z"/>
                  </svg>
                  <span data-i18n="buttons.register">Register Number</span>
                </button>
              </div>
              <p style="font-size: 12px; color: var(--text-tertiary); margin-top: 10px;" data-i18n="whatsapp.numberFormat">
                Use international format: +[country code][number] (e.g., +1234567890)
              </p>
            </div>
          </div>
        </div>
        
        <!-- Test Notification Card -->
        <div class="automation-card" style="margin-top: 24px;">
          <div class="automation-header">
            <h2 data-i18n="whatsapp.testTitle">Test Notification</h2>
          </div>
          <div class="automation-content">
            <p style="margin-bottom: 20px; color: var(--text-secondary);" data-i18n="whatsapp.testDesc">
              Send a test WhatsApp notification to verify your connection is working.
            </p>
            <button class="btn btn-secondary" onclick="testWhatsApp()" id="testWhatsAppBtn" data-i18n="buttons.sendTest">
              Send Test Notification
            </button>
          </div>
        </div>
      </section>
      
      <!-- Sent Emails Section -->
      <section id="sentSection" class="section-content" aria-labelledby="sentTitle" style="display: none;">
        <div class="welcome-card">
          <h1 id="sentTitle" data-i18n="sent.title">Sent Emails</h1>
          <p data-i18n="sent.description">View all emails you've sent through automation.</p>
        </div>
        
        <div class="automation-card">
          <div class="automation-header">
            <h2 data-i18n="sent.history">Email History</h2>
            <span class="data-count" id="totalSentCount" style="color: var(--text-tertiary);">0 total</span>
          </div>
          <div class="automation-content">
            <div id="sentEmailsList" class="sent-emails-list">
              <div class="empty-sent" data-i18n="sent.noEmails">No sent emails yet. Start sending automated messages!</div>
            </div>
          </div>
        </div>
      </section>
      
      <!-- Analytics Section -->
      <section id="analyticsSection" class="section-content" aria-labelledby="analyticsTitle" style="display: none;">
        <div class="welcome-card">
          <h1 id="analyticsTitle" data-i18n="analytics.title">Analytics</h1>
          <p data-i18n="analytics.description">Campaign performance and engagement metrics.</p>
        </div>
        
        <div class="analytics-summary">
            <div class="metric-box">
                <div class="metric-label" data-i18n="analytics.avgOpenRate">Avg. Open Rate</div>
                <div class="metric-value">42.5%</div>
                <div class="metric-trend trend-up" data-i18n="analytics.trendUp">‚Üë 5% vs last week</div>
            </div>
            <div class="metric-box">
                <div class="metric-label" data-i18n="analytics.clickRate">Click Rate</div>
                <div class="metric-value">18.2%</div>
                <div class="metric-trend trend-up" data-i18n="analytics.trendUp">‚Üë 2% vs last week</div>
            </div>
            <div class="metric-box">
                <div class="metric-label" data-i18n="analytics.bounceRate">Bounce Rate</div>
                <div class="metric-value">0.8%</div>
                <div class="metric-trend trend-down" data-i18n="analytics.trendDown">‚Üì 0.2% vs last week</div>
            </div>
        </div>
        <div class="automation-card">
            <div class="automation-header">
                <h2 data-i18n="analytics.emailPerformance">Email Performance (Last 7 Days)</h2>
            </div>
            <div class="automation-content">
                <div class="chart-container" id="analyticsChart"></div>
            </div>
        </div>
      </section>
      
      <!-- Templates Section -->
      <section id="templatesSection" class="section-content" aria-labelledby="templatesTitle" style="display: none;">
        <div class="welcome-card">
          <div style="display: flex; flex-direction: column; gap: 16px;">
            <div>
                <h1 id="templatesTitle" data-i18n="templates.title">Templates</h1>
                <p data-i18n="templates.description">Manage your saved message layouts and quick responses.</p>
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="createNewTemplate()" data-i18n="templates.newTemplate">+ New Template</button>
             </div>
          </div>
        </div>
        
        <div class="templates-grid" id="templatesGrid"></div>
      </section>
      
      <!-- Settings Section -->
      <section id="settingsSection" class="section-content" aria-labelledby="settingsTitle" style="display: none;">
        <div class="welcome-card">
          <h1 id="settingsTitle" data-i18n="settings.title">Settings</h1>
          <p data-i18n="settings.description">Configure your account preferences and notifications.</p>
        </div>
        
        <div class="settings-container">
            <div class="automation-card">
                <div class="automation-content">
                    <div class="settings-group">
                        <div class="settings-title" data-i18n="settings.profile">Profile Information</div>
                        <form id="profileForm" onsubmit="event.preventDefault(); saveSettings(this);">
                            <div class="message-form">
                                <div class="form-group">
                                    <label class="form-label" for="settingsName" data-i18n="settings.fullName">Full Name</label>
                                    <input type="text" class="form-control" id="settingsName">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="settingsEmail" data-i18n="settings.email">Email Address</label>
                                    <input type="email" class="form-control" id="settingsEmail">
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <div class="settings-group">
                        <div class="settings-title" data-i18n="settings.whatsappIntegration">WhatsApp Integration</div>
                        <div class="toggle-row">
                            <div>
                                <div class="toggle-label" data-i18n="settings.whatsappToggle">Email Notifications on WhatsApp</div>
                                <div class="toggle-desc" data-i18n="settings.whatsappDesc">Receive WhatsApp notifications for new emails</div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="whatsappToggle" onchange="toggleWhatsAppNotifications()">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="whatsappSettingsNumber" style="margin-top: 16px; padding: 16px; background: var(--bg-subtle); border-radius: var(--radius-md); display: none;">
                            <span style="font-weight: 600;" data-i18n="settings.connectedNumber">Connected Number: </span>
                            <span id="settingsWhatsAppNumber"></span>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <div class="settings-title" data-i18n="settings.notifications">Notifications</div>
                        <div class="toggle-row">
                            <div>
                                <div class="toggle-label" data-i18n="settings.campaignSummary">Email Campaign Summary</div>
                                <div class="toggle-desc" data-i18n="settings.campaignSummaryDesc">Receive a weekly summary of your campaign stats</div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="toggle-row">
                            <div>
                                <div class="toggle-label" data-i18n="settings.newCustomerAlert">New Customer Alert</div>
                                <div class="toggle-desc" data-i18n="settings.newCustomerAlertDesc">Get notified when a new customer is added</div>
                            </div>
                            <label class="switch">
                                <input type="checkbox">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <div class="settings-title" data-i18n="settings.security">Security</div>
                        <div class="action-buttons">
                            <button class="btn btn-secondary" data-i18n="settings.changePassword">Change Password</button>
                            <button class="btn btn-danger-outline" onclick="confirmLogout()" data-i18n="settings.logOutEverywhere">Log Out Everywhere</button>
                        </div>
                    </div>
                    
                    <div style="text-align: right;">
                        <button class="btn btn-primary" onclick="saveSettings(this)" data-i18n="buttons.saveChanges">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
      </section>
      
      <footer style="text-align: center; padding: 40px 20px; color: var(--text-tertiary); font-size: 13px; margin-top: auto; border-top: 1px solid var(--border-light); background: #fafafa; border-radius: var(--radius-md);">
        <p style="margin-bottom: 8px;">
            &copy; 2025 Flux On. <span data-i18n="footer.allRightsReserved">All rights reserved.</span>
        </p>
        <p>
            <a href="https://seraphielspark.github.io/flowon/privacy.html" target="_blank" style="color: var(--text-secondary); text-decoration: none; margin: 0 10px; font-weight: 500;" data-i18n="legal.privacy">Privacy Policy</a>
            ‚Ä¢
            <a href="https://seraphielspark.github.io/flowon/terms.html" target="_blank" style="color: var(--text-secondary); text-decoration: none; margin: 0 10px; font-weight: 500;" data-i18n="legal.terms">Terms of Service</a>
        </p>
      </footer>
    </div>
  </main>
</div>

<!-- Login Required Modal -->
<div class="modal login-required-modal" id="loginRequiredModal" role="dialog" aria-labelledby="loginRequiredTitle" aria-hidden="true">
  <div class="modal-content">
    <div class="login-required-icon">üîí</div>
    <div class="login-required-title" id="loginRequiredTitle" data-i18n="auth.loginRequired">Login Required</div>
    <div class="login-required-text" data-i18n="auth.loginRequiredDesc">Please sign in or create an account to access this feature.</div>
    <div class="login-required-buttons">
      <button class="btn btn-secondary" onclick="closeModal('loginRequiredModal')" data-i18n="buttons.cancel">Cancel</button>
      <button class="btn btn-primary" onclick="redirectToSignup()" data-i18n="auth.signInUp">Sign In / Sign Up</button>
    </div>
  </div>
</div>

<!-- Add Customer Modal -->
<div class="modal" id="addCustomerModal" role="dialog" aria-labelledby="modalTitle" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle" data-i18n="customers.addCustomer">Add Customer</h3>
    </div>
    <form id="customerForm" onsubmit="event.preventDefault(); saveNewCustomer();">
      <div class="form-group">
        <label class="form-label required" for="newCustomerName" data-i18n="customers.fullName">Full Name</label>
        <input type="text" class="form-control" id="newCustomerName" required placeholder="Jane Doe">
      </div>
      <div class="form-group">
        <label class="form-label" for="newCustomerEmail" data-i18n="customers.email">Email</label>
        <input type="email" class="form-control" id="newCustomerEmail" placeholder="jane@example.com">
      </div>
      <div class="form-group">
        <label class="form-label" for="newCustomerPhone" data-i18n="customers.phone">Phone</label>
        <input type="tel" class="form-control" id="newCustomerPhone" placeholder="+1 (555) 000-0000">
      </div>
      <div class="form-group">
        <label class="form-label" for="newCustomerCompany" data-i18n="customers.company">Company</label>
        <input type="text" class="form-control" id="newCustomerCompany" placeholder="Acme Inc.">
      </div>
      <div class="form-group">
        <label class="form-label" for="newCustomerStatus" data-i18n="customers.status">Status</label>
        <select class="form-control" id="newCustomerStatus">
          <option value="Active" data-i18n="customers.active">Active</option>
          <option value="Inactive" data-i18n="customers.inactive">Inactive</option>
          <option value="Pending" data-i18n="customers.pending">Pending</option>
        </select>
      </div>
      <div class="form-actions" style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
        <button type="button" class="btn btn-secondary" onclick="closeModal('addCustomerModal')" data-i18n="buttons.cancel">Cancel</button>
        <button type="submit" id="btnSaveCustomer" class="btn btn-primary" data-i18n="buttons.saveRecord">Save Record</button>
      </div>
    </form>
  </div>
</div>

<!-- Template Modal -->
<div class="modal" id="templateModal" role="dialog" aria-labelledby="templateModalTitle" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="templateModalTitle" data-i18n="templates.addNew">Add New Template</h3>
    </div>
    <form id="templateForm" onsubmit="event.preventDefault(); saveTemplate();">
      <input type="hidden" id="templateIndex">
      <div class="form-group">
        <label class="form-label required" for="templateName" data-i18n="templates.name">Template Name</label>
        <input type="text" class="form-control" id="templateName" required placeholder="e.g. Welcome Series">
      </div>
      <div class="form-group">
        <label class="form-label" for="templateTag" data-i18n="templates.tag">Tag (Category)</label>
        <input type="text" class="form-control" id="templateTag" placeholder="e.g. Sales, Onboarding">
      </div>
      <div class="form-group full-width">
        <label class="form-label required" for="templateSubject" data-i18n="templates.subject">Subject Line</label>
        <input type="text" class="form-control" id="templateSubject" required placeholder="Email Subject">
      </div>
      <div class="form-group full-width">
        <label class="form-label required" for="templateBody" data-i18n="templates.body">Email Body</label>
        <textarea class="form-control" id="templateBody" required placeholder="Hi {name}..." style="min-height: 200px;"></textarea>
      </div>
      <div class="form-actions" style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
        <button type="button" class="btn btn-secondary" onclick="closeModal('templateModal')" data-i18n="buttons.cancel">Cancel</button>
        <button type="submit" id="btnSaveTemplate" class="btn btn-primary" data-i18n="buttons.saveTemplate">Save Template</button>
      </div>
    </form>
  </div>
</div>

<!-- Preview Modal -->
<div class="modal" id="previewModal" role="dialog" aria-labelledby="previewTitle" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="previewTitle" data-i18n="preview.title">Message Preview</h3>
    </div>
    <div style="margin-bottom: 24px; padding: 16px; background: var(--bg-subtle); border-radius: var(--radius-sm);">
      <div style="font-size: 12px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 4px;" data-i18n="preview.subject">Subject</div>
      <div id="previewSubject" style="font-weight: 600; font-size: 16px;"></div>
    </div>
    <div style="padding: 24px; border: 1px solid var(--border-light); border-radius: var(--radius-sm); font-family: var(--font-sans); min-height: 200px; max-height: 400px; overflow-y: auto; line-height: 1.6; white-space: pre-wrap;" id="previewBody">
    </div>
    <div class="form-actions" style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
      <button type="button" class="btn btn-secondary" onclick="closeModal('previewModal')" data-i18n="buttons.backToEdit">Back to Edit</button>
      <button type="button" id="btnConfirmSend" class="btn btn-primary" onclick="sendAutomatedMessages()" data-i18n="buttons.confirmSend">Confirm & Send</button>
    </div>
  </div>
</div>

<script>
// ============================================
// SECURITY ENHANCEMENTS - MUST BE FIRST
// ============================================

// DOMPurify for XSS prevention
const DOMPurify = window.DOMPurify || {
    sanitize: function(html) {
        // Basic sanitization if DOMPurify not loaded
        const div = document.createElement('div');
        div.textContent = html;
        return div.innerHTML;
    }
};

// CSRF Token management
let csrfToken = null;

// Fetch wrapper with CSRF and authentication
async function secureFetch(url, options = {}) {
    const defaultOptions = {
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
            ...options.headers
        }
    };

    if (options.method && options.method !== 'GET' && csrfToken) {
        defaultOptions.headers['X-CSRF-Token'] = csrfToken;
    }

    const fetchOptions = { ...defaultOptions, ...options };
    
    try {
        const response = await fetch(url, fetchOptions);
        
        if (response.status === 401) {
            sessionStorage.removeItem('authenticated');
            sessionStorage.removeItem('userId');
            showLoginRequired();
            throw new Error('Session expired');
        }
        
        return response;
    } catch (error) {
        console.error('Fetch error:', error);
        throw error;
    }
}

// Session check
async function checkSession() {
    try {
        const response = await fetch(`${API_BASE_URL}/session`, {
            credentials: 'include'
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.authenticated) {
                sessionStorage.setItem('authenticated', 'true');
                sessionStorage.setItem('userId', data.userId);
                await refreshCsrfToken();
                return true;
            }
        }
        
        sessionStorage.removeItem('authenticated');
        sessionStorage.removeItem('userId');
        return false;
    } catch (error) {
        console.error('Session check failed:', error);
        return false;
    }
}

// Refresh CSRF token
async function refreshCsrfToken() {
    try {
        const response = await fetch('/api/csrf-token', {
            credentials: 'include'
        });
        
        if (response.ok) {
            const data = await response.json();
            csrfToken = data.csrfToken;
        }
    } catch (error) {
        console.error('Failed to get CSRF token:', error);
    }
}

// Login function
async function login(email, password) {
    try {
        const response = await fetch('/api/login', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });
        
        if (response.ok) {
            const data = await response.json();
            sessionStorage.setItem('authenticated', 'true');
            sessionStorage.setItem('userId', data.userId);
            await refreshCsrfToken();
            return { success: true, data };
        } else {
            const error = await response.json();
            return { success: false, error: error.error };
        }
    } catch (error) {
        console.error('Login error:', error);
        return { success: false, error: 'Network error' };
    }
}

// Logout function
async function logout() {
    try {
        await fetch('/api/logout', {
            method: 'POST',
            credentials: 'include',
            headers: { 'X-CSRF-Token': csrfToken }
        });
    } catch (error) {
        console.error('Logout error:', error);
    } finally {
        sessionStorage.removeItem('authenticated');
        sessionStorage.removeItem('userId');
        csrfToken = null;
        localStorage.removeItem('flowid');
        window.location.href = 'index.html';
    }
}

// Show login required modal
function showLoginRequired() {
    document.getElementById('loginRequiredModal').style.display = 'flex';
}

// Secure version of checkAuth
async function checkAuth() {
    const isAuthenticated = await checkSession();
    
    if (!isAuthenticated) {
        showLoginRequired();
        return false;
    }
    
    flowId = sessionStorage.getItem('userId');
    if (!flowId) {
        showLoginRequired();
        return false;
    }
    
    return true;
}

// Secure version of requireAuth
async function requireAuth(section) {
    const auth = await checkAuth();
    if (!auth) {
        sessionStorage.setItem('redirectAfterLogin', section);
        return false;
    }
    showSection(section);
    return true;
}

// Sanitize HTML before rendering
function sanitizeHTML(html) {
    if (!html) return '';
    return DOMPurify.sanitize(html, {
        ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'a', 'p', 'br', 'div', 'span', 'ul', 'ol', 'li', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'img', 'blockquote', 'pre', 'code'],
        ALLOWED_ATTR: ['href', 'target', 'rel', 'src', 'alt', 'title', 'class']
    });
}

// Input validation helpers
function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
}

function validatePhone(phone) {
    const re = /^\+?[1-9]\d{1,14}$/;
    return re.test(phone.replace(/\s/g, ''));
}

function sanitizeInput(input) {
    if (typeof input !== 'string') return input;
    return input.replace(/[<>]/g, '');
}

// ============================================
// TRANSLATION DICTIONARY - 50+ LANGUAGES
// ============================================

const translationResources = {
  en: {
    nav: {
      dashboard: 'Dashboard',
      customers: 'Customers',
      inbox: 'Inbox',
      automation: 'Automation',
      whatsapp: 'WhatsApp',
      sent: 'Sent Emails',
      analytics: 'Analytics',
      templates: 'Templates',
      settings: 'Settings'
    },
    auth: {
      notSignedIn: 'Not signed in',
      signIn: 'Sign in',
      or: 'or',
      register: 'Register',
      logOut: 'Log Out',
      login: 'Login To Existing Account',
      loginRequired: 'Login Required',
      loginRequiredDesc: 'Please sign in or create an account to access this feature.',
      signInUp: 'Sign In / Sign Up',
      signedIn: 'Signed in',
      confirmLogout: 'Log out?'
    },
    status: {
      gmailNotLinked: 'Gmail: Not Linked',
      gmailLinked: '‚úì Gmail Linked',
      whatsappNotConnected: 'WhatsApp: Not Connected',
      whatsappConnected: 'üì± WhatsApp Connected'
    },
    legal: {
      privacy: 'Privacy Policy',
      terms: 'Terms of Service'
    },
    titles: {
      dashboard: 'Dashboard',
      customers: 'Customer Management',
      inbox: 'Inbox',
      automation: 'Automation Center',
      whatsapp: 'WhatsApp Automation',
      sent: 'Sent Emails',
      analytics: 'Analytics',
      templates: 'Templates',
      settings: 'Settings'
    },
    buttons: {
      refresh: 'Refresh',
      connectGmail: 'Connect Gmail',
      back: '‚Üê Back',
      reset: 'Reset',
      previewSend: 'Preview & Send',
      register: 'Register Number',
      sendTest: 'Send Test Notification',
      saveChanges: 'Save Changes',
      cancel: 'Cancel',
      saveRecord: 'Save Record',
      saveTemplate: 'Save Template',
      backToEdit: 'Back to Edit',
      confirmSend: 'Confirm & Send',
      refreshing: 'Refreshing...'
    },
    dashboard: {
      hello: 'Hello,',
      description: 'Here is your overview. Manage customers and automate flows.',
      startAutomation: 'Start Automation',
      manageCustomers: 'Manage Customers',
      totalCustomers: 'Total Customers',
      activeInDatabase: 'Active in database',
      inbox: 'Inbox',
      unreadMessages: 'Unread messages',
      activeCampaigns: 'Active Campaigns',
      workflowsRunning: 'Workflows running',
      responseRate: 'Response Rate',
      averageEngagement: 'Average engagement',
      quickActions: 'Quick Actions',
      createWelcomeSeries: 'üéâ Create Welcome Series',
      sendFollowUp: 'üîÑ Send Follow-up',
      sentEmails: 'Sent Emails',
      totalSent: 'Total sent',
      googleConnected: 'Google Account Connected Successfully!'
    },
    customers: {
      description: 'View and manage your subscriber database.',
      exportCSV: 'Export CSV',
      importCSV: 'Import CSV',
      addCustomer: '+ Add Customer',
      allRecords: 'All Records',
      saveChanges: 'Save Changes',
      loading: 'Loading data...',
      fullName: 'Full Name',
      email: 'Email',
      phone: 'Phone',
      company: 'Company',
      status: 'Status',
      active: 'Active',
      inactive: 'Inactive',
      pending: 'Pending',
      noCustomers: 'No Customers Yet',
      startAdding: 'Start by adding or importing customers.',
      addFirst: 'Add First Customer',
      name: 'Name',
      actions: 'Actions',
      save: 'Save',
      delete: 'Delete',
      nameRequired: 'Name is required',
      saving: 'Saving...',
      saved: 'Data saved to cloud',
      saveError: 'Error saving data',
      parsing: 'Parsing CSV...',
      csvError: 'CSV file is too short or empty.',
      noEmailColumn: 'Could not detect an Email column. Please check your CSV.',
      importSuccess: 'Successfully imported {count} customers!',
      confirmDelete: 'Are you sure you want to delete this customer?',
      invalidEmail: 'Invalid email format',
      invalidPhone: 'Invalid phone format. Use international format (e.g., +1234567890)',
      exported: 'Customers exported successfully!'
    },
    inbox: {
      title: 'Inbox',
      description: 'Messages from your audience.',
      connectGmail: 'Connect Your Gmail Account',
      connectGmailDesc: 'To view and manage your inbox messages, you need to connect your Gmail account.',
      disconnected: 'Disconnected',
      connected: 'Connected',
      loading: 'Loading messages...',
      noMessages: 'No messages in your inbox',
      selectMessage: 'Select a message to read',
      readingMessage: 'Reading Message',
      subject: 'Subject',
      senderName: 'Sender Name',
      today: 'Today',
      sendToWhatsApp: 'Send to WhatsApp',
      delete: 'Delete',
      noPreview: 'No preview available',
      unknownDate: 'Unknown date',
      noContent: 'No content',
      confirmDelete: 'Delete this message permanently?',
      deleted: 'Message deleted',
      deleteFailed: 'Error deleting message',
      sentToWhatsApp: 'Message sent to your WhatsApp!',
      sendFailed: 'Failed to send to WhatsApp'
    },
    automation: {
      title: 'Automation Center',
      description: 'Compose and schedule email campaigns.',
      newCampaign: 'New Campaign',
      recipients: 'Recipients',
      totalList: 'Total List',
      connectGoogle: 'Connect Google Account',
      connectGoogleDesc: 'Link your account to send automated emails directly via your Gmail.',
      disconnected: 'Disconnected',
      whatsappNotifications: 'WhatsApp Notifications',
      whatsappDesc: 'Get notified on WhatsApp when you receive new emails.',
      notConnected: 'Not Connected',
      setupWhatsApp: 'Setup WhatsApp',
      selectAll: 'Select All Customers',
      composeMessage: 'Compose Message',
      blank: 'Blank',
      campaignName: 'Campaign Name',
      schedule: 'Schedule',
      sendImmediately: 'Send Immediately',
      scheduleLater: 'Schedule for later',
      fromName: 'From Name',
      fromEmail: 'From Email',
      replyTo: 'Reply To',
      subjectLine: 'Subject Line',
      emailBody: 'Email Body',
      variables: 'Variables: {name}, {email}, {company}',
      dateTime: 'Date & Time',
      noRecipients: 'No recipients selected',
      googleRequired: 'Action Blocked: You must connect your Google Account to send automated messages.',
      sending: 'Sending...',
      sent: 'Sent to {count} recipients',
      sendFailed: 'Failed to send messages',
      noValidEmails: 'No valid email addresses found.',
      confirmReset: 'Reset form?'
    },
    whatsapp: {
      title: 'WhatsApp Automation',
      description: 'Receive email notifications directly on your WhatsApp.',
      connect: 'Connect WhatsApp',
      connectTitle: 'Connect Your WhatsApp',
      connectDesc: 'Get instant notifications on WhatsApp whenever you receive a new email. Choose one of the methods below to connect.',
      connected: 'WhatsApp Connected',
      disconnect: 'Disconnect',
      option1: 'Option 1: Scan QR Code',
      option1Desc: 'Open WhatsApp on your phone, tap Menu (Android) or Settings (iOS), then WhatsApp Web, and scan this QR code.',
      option2: 'Option 2: Send Message',
      option2Desc: 'Send this exact message to the number above:',
      option2Note: 'After sending the message, your WhatsApp will be automatically connected.',
      manualTitle: 'Or enter your WhatsApp number manually',
      numberLabel: 'WhatsApp Number (with country code)',
      numberFormat: 'Use international format: +[country code][number] (e.g., +1234567890)',
      testTitle: 'Test Notification',
      testDesc: 'Send a test WhatsApp notification to verify your connection is working.',
      enterNumber: 'Please enter your WhatsApp number',
      invalidFormat: 'Invalid phone number format. Please use international format (e.g., +1234567890)',
      registered: 'WhatsApp number registered successfully!',
      registrationFailed: 'Failed to register WhatsApp number',
      confirmDisconnect: 'Disconnect WhatsApp? You will stop receiving notifications.',
      disconnected: 'WhatsApp disconnected',
      connectFirst: 'Please connect WhatsApp first',
      testMessage: 'This is a test notification from Flux On',
      testSubject: 'Test Notification',
      testSent: 'Test notification sent to your WhatsApp!',
      testFailed: 'Failed to send test notification',
      notificationsEnabled: 'WhatsApp notifications enabled',
      notificationsDisabled: 'WhatsApp notifications disabled',
      connectPrompt: 'WhatsApp not connected. Would you like to connect now?'
    },
    sent: {
      title: 'Sent Emails',
      description: 'View all emails you\'ve sent through automation.',
      history: 'Email History',
      noEmails: 'No sent emails yet. Start sending automated messages!',
      from: 'From',
      to: 'To',
      subject: 'Subject',
      date: 'Date',
      campaign: 'Campaign',
      recipients: 'Recipients'
    },
    analytics: {
      title: 'Analytics',
      description: 'Campaign performance and engagement metrics.',
      avgOpenRate: 'Avg. Open Rate',
      clickRate: 'Click Rate',
      bounceRate: 'Bounce Rate',
      trendUp: '‚Üë 5% vs last week',
      trendDown: '‚Üì 0.2% vs last week',
      emailPerformance: 'Email Performance (Last 7 Days)',
      day: 'Day'
    },
    templates: {
      title: 'Templates',
      description: 'Manage your saved message layouts and quick responses.',
      newTemplate: '+ New Template',
      addNew: 'Add New Template',
      name: 'Template Name',
      tag: 'Tag (Category)',
      subject: 'Subject Line',
      body: 'Email Body',
      use: 'Use',
      edit: 'Edit',
      delete: 'Del',
      general: 'General',
      noTemplates: 'No templates found.',
      confirmDelete: 'Delete template?'
    },
    settings: {
      title: 'Settings',
      description: 'Configure your account preferences and notifications.',
      profile: 'Profile Information',
      fullName: 'Full Name',
      email: 'Email Address',
      whatsappIntegration: 'WhatsApp Integration',
      whatsappToggle: 'Email Notifications on WhatsApp',
      whatsappDesc: 'Receive WhatsApp notifications for new emails',
      connectedNumber: 'Connected Number:',
      notifications: 'Notifications',
      campaignSummary: 'Email Campaign Summary',
      campaignSummaryDesc: 'Receive a weekly summary of your campaign stats',
      newCustomerAlert: 'New Customer Alert',
      newCustomerAlertDesc: 'Get notified when a new customer is added',
      security: 'Security',
      changePassword: 'Change Password',
      logOutEverywhere: 'Log Out Everywhere',
      saved: 'Settings saved successfully!'
    },
    preview: {
      title: 'Message Preview',
      subject: 'Subject'
    },
    footer: {
      allRightsReserved: 'All rights reserved.'
    },
    errors: {
      loadFailed: 'Failed to load data. Please refresh.'
    }
  },
  es: {
    nav: {
      dashboard: 'Panel',
      customers: 'Clientes',
      inbox: 'Bandeja',
      automation: 'Automatizaci√≥n',
      whatsapp: 'WhatsApp',
      sent: 'Correos Enviados',
      analytics: 'Anal√≠ticas',
      templates: 'Plantillas',
      settings: 'Ajustes'
    },
    auth: {
      notSignedIn: 'No has iniciado sesi√≥n',
      signIn: 'Iniciar sesi√≥n',
      or: 'o',
      register: 'Registrarse',
      logOut: 'Cerrar sesi√≥n',
      login: 'Iniciar sesi√≥n',
      loginRequired: 'Inicio de sesi√≥n requerido',
      loginRequiredDesc: 'Por favor inicia sesi√≥n o crea una cuenta para acceder a esta funci√≥n.',
      signInUp: 'Iniciar sesi√≥n / Registrarse',
      signedIn: 'Sesi√≥n iniciada',
      confirmLogout: '¬øCerrar sesi√≥n?'
    },
    status: {
      gmailNotLinked: 'Gmail: No vinculado',
      gmailLinked: '‚úì Gmail Vinculado',
      whatsappNotConnected: 'WhatsApp: No conectado',
      whatsappConnected: 'üì± WhatsApp Conectado'
    },
    legal: {
      privacy: 'Pol√≠tica de Privacidad',
      terms: 'T√©rminos de Servicio'
    },
    titles: {
      dashboard: 'Panel',
      customers: 'Gesti√≥n de Clientes',
      inbox: 'Bandeja de Entrada',
      automation: 'Centro de Automatizaci√≥n',
      whatsapp: 'Automatizaci√≥n WhatsApp',
      sent: 'Correos Enviados',
      analytics: 'Anal√≠ticas',
      templates: 'Plantillas',
      settings: 'Ajustes'
    },
    buttons: {
      refresh: 'Actualizar',
      connectGmail: 'Conectar Gmail',
      back: '‚Üê Atr√°s',
      reset: 'Reiniciar',
      previewSend: 'Vista Previa y Enviar',
      register: 'Registrar N√∫mero',
      sendTest: 'Enviar Notificaci√≥n de Prueba',
      saveChanges: 'Guardar Cambios',
      cancel: 'Cancelar',
      saveRecord: 'Guardar Registro',
      saveTemplate: 'Guardar Plantilla',
      backToEdit: 'Volver a Editar',
      confirmSend: 'Confirmar y Enviar',
      refreshing: 'Actualizando...'
    },
    dashboard: {
      hello: 'Hola,',
      description: 'Aqu√≠ est√° tu resumen. Gestiona clientes y automatiza flujos.',
      startAutomation: 'Iniciar Automatizaci√≥n',
      manageCustomers: 'Gestionar Clientes',
      totalCustomers: 'Total Clientes',
      activeInDatabase: 'Activos en base de datos',
      inbox: 'Bandeja',
      unreadMessages: 'Mensajes no le√≠dos',
      activeCampaigns: 'Campa√±as Activas',
      workflowsRunning: 'Flujos activos',
      responseRate: 'Tasa de Respuesta',
      averageEngagement: 'Participaci√≥n promedio',
      quickActions: 'Acciones R√°pidas',
      createWelcomeSeries: 'üéâ Crear Serie de Bienvenida',
      sendFollowUp: 'üîÑ Enviar Seguimiento',
      sentEmails: 'Correos Enviados',
      totalSent: 'Total enviados',
      googleConnected: '¬°Cuenta de Google conectada exitosamente!'
    },
    customers: {
      description: 'Ver y gestionar tu base de datos de suscriptores.',
      exportCSV: 'Exportar CSV',
      importCSV: 'Importar CSV',
      addCustomer: '+ Agregar Cliente',
      allRecords: 'Todos los Registros',
      saveChanges: 'Guardar Cambios',
      loading: 'Cargando datos...',
      fullName: 'Nombre Completo',
      email: 'Correo Electr√≥nico',
      phone: 'Tel√©fono',
      company: 'Empresa',
      status: 'Estado',
      active: 'Activo',
      inactive: 'Inactivo',
      pending: 'Pendiente',
      noCustomers: 'No hay clientes a√∫n',
      startAdding: 'Comienza agregando o importando clientes.',
      addFirst: 'Agregar Primer Cliente',
      name: 'Nombre',
      actions: 'Acciones',
      save: 'Guardar',
      delete: 'Eliminar',
      nameRequired: 'El nombre es requerido',
      saving: 'Guardando...',
      saved: 'Datos guardados en la nube',
      saveError: 'Error al guardar datos',
      parsing: 'Analizando CSV...',
      csvError: 'El archivo CSV est√° vac√≠o o es demasiado corto.',
      noEmailColumn: 'No se pudo detectar una columna de Email. Verifica tu CSV.',
      importSuccess: '¬°{count} clientes importados exitosamente!',
      confirmDelete: '¬øEst√°s seguro de que quieres eliminar este cliente?',
      invalidEmail: 'Formato de email inv√°lido',
      invalidPhone: 'Formato de tel√©fono inv√°lido. Usa formato internacional (ej., +1234567890)',
      exported: '¬°Clientes exportados exitosamente!'
    },
    inbox: {
      title: 'Bandeja de Entrada',
      description: 'Mensajes de tu audiencia.',
      connectGmail: 'Conecta tu Cuenta de Gmail',
      connectGmailDesc: 'Para ver y gestionar los mensajes de tu bandeja de entrada, necesitas conectar tu cuenta de Gmail.',
      disconnected: 'Desconectado',
      connected: 'Conectado',
      loading: 'Cargando mensajes...',
      noMessages: 'No hay mensajes en tu bandeja de entrada',
      selectMessage: 'Selecciona un mensaje para leer',
      readingMessage: 'Leyendo Mensaje',
      subject: 'Asunto',
      senderName: 'Nombre del Remitente',
      today: 'Hoy',
      sendToWhatsApp: 'Enviar a WhatsApp',
      delete: 'Eliminar',
      noPreview: 'No hay vista previa disponible',
      unknownDate: 'Fecha desconocida',
      noContent: 'Sin contenido',
      confirmDelete: '¬øEliminar este mensaje permanentemente?',
      deleted: 'Mensaje eliminado',
      deleteFailed: 'Error al eliminar mensaje',
      sentToWhatsApp: '¬°Mensaje enviado a tu WhatsApp!',
      sendFailed: 'Error al enviar a WhatsApp'
    },
    automation: {
      title: 'Centro de Automatizaci√≥n',
      description: 'Redacta y programa campa√±as de correo electr√≥nico.',
      newCampaign: 'Nueva Campa√±a',
      recipients: 'Destinatarios',
      totalList: 'Lista Total',
      connectGoogle: 'Conectar Cuenta de Google',
      connectGoogleDesc: 'Vincula tu cuenta para enviar correos automatizados directamente a trav√©s de Gmail.',
      disconnected: 'Desconectado',
      whatsappNotifications: 'Notificaciones de WhatsApp',
      whatsappDesc: 'Recibe notificaciones en WhatsApp cuando recibas nuevos correos.',
      notConnected: 'No Conectado',
      setupWhatsApp: 'Configurar WhatsApp',
      selectAll: 'Seleccionar Todos los Clientes',
      composeMessage: 'Redactar Mensaje',
      blank: 'En Blanco',
      campaignName: 'Nombre de la Campa√±a',
      schedule: 'Programar',
      sendImmediately: 'Enviar Inmediatamente',
      scheduleLater: 'Programar para despu√©s',
      fromName: 'Nombre del Remitente',
      fromEmail: 'Correo del Remitente',
      replyTo: 'Responder a',
      subjectLine: 'L√≠nea de Asunto',
      emailBody: 'Cuerpo del Correo',
      variables: 'Variables: {name}, {email}, {company}',
      dateTime: 'Fecha y Hora',
      noRecipients: 'No hay destinatarios seleccionados',
      googleRequired: 'Acci√≥n bloqueada: Debes conectar tu cuenta de Google para enviar mensajes automatizados.',
      sending: 'Enviando...',
      sent: 'Enviado a {count} destinatarios',
      sendFailed: 'Error al enviar mensajes',
      noValidEmails: 'No se encontraron direcciones de email v√°lidas.',
      confirmReset: '¬øReiniciar formulario?'
    },
    whatsapp: {
      title: 'Automatizaci√≥n de WhatsApp',
      description: 'Recibe notificaciones de correo directamente en tu WhatsApp.',
      connect: 'Conectar WhatsApp',
      connectTitle: 'Conecta tu WhatsApp',
      connectDesc: 'Recibe notificaciones instant√°neas en WhatsApp cada vez que recibas un nuevo correo. Elige uno de los m√©todos a continuaci√≥n para conectar.',
      connected: 'WhatsApp Conectado',
      disconnect: 'Desconectar',
      option1: 'Opci√≥n 1: Escanear C√≥digo QR',
      option1Desc: 'Abre WhatsApp en tu tel√©fono, toca Men√∫ (Android) o Configuraci√≥n (iOS), luego WhatsApp Web y escanea este c√≥digo QR.',
      option2: 'Opci√≥n 2: Enviar Mensaje',
      option2Desc: 'Env√≠a este mensaje exacto al n√∫mero de arriba:',
      option2Note: 'Despu√©s de enviar el mensaje, tu WhatsApp se conectar√° autom√°ticamente.',
      manualTitle: 'O ingresa tu n√∫mero de WhatsApp manualmente',
      numberLabel: 'N√∫mero de WhatsApp (con c√≥digo de pa√≠s)',
      numberFormat: 'Usa formato internacional: +[c√≥digo de pa√≠s][n√∫mero] (ej., +1234567890)',
      testTitle: 'Notificaci√≥n de Prueba',
      testDesc: 'Env√≠a una notificaci√≥n de prueba a WhatsApp para verificar que tu conexi√≥n funciona.',
      enterNumber: 'Por favor ingresa tu n√∫mero de WhatsApp',
      invalidFormat: 'Formato de n√∫mero inv√°lido. Usa formato internacional (ej., +1234567890)',
      registered: '¬°N√∫mero de WhatsApp registrado exitosamente!',
      registrationFailed: 'Error al registrar n√∫mero de WhatsApp',
      confirmDisconnect: '¬øDesconectar WhatsApp? Dejar√°s de recibir notificaciones.',
      disconnected: 'WhatsApp desconectado',
      connectFirst: 'Por favor conecta WhatsApp primero',
      testMessage: 'Esta es una notificaci√≥n de prueba de Flux On',
      testSubject: 'Notificaci√≥n de Prueba',
      testSent: '¬°Notificaci√≥n de prueba enviada a tu WhatsApp!',
      testFailed: 'Error al enviar notificaci√≥n de prueba',
      notificationsEnabled: 'Notificaciones de WhatsApp activadas',
      notificationsDisabled: 'Notificaciones de WhatsApp desactivadas',
      connectPrompt: 'WhatsApp no est√° conectado. ¬øQuieres conectarlo ahora?'
    },
    sent: {
      title: 'Correos Enviados',
      description: 'Ver todos los correos que has enviado mediante automatizaci√≥n.',
      history: 'Historial de Correos',
      noEmails: '¬°A√∫n no hay correos enviados. Comienza a enviar mensajes automatizados!',
      from: 'De',
      to: 'Para',
      subject: 'Asunto',
      date: 'Fecha',
      campaign: 'Campa√±a',
      recipients: 'Destinatarios'
    },
    analytics: {
      title: 'Anal√≠ticas',
      description: 'Rendimiento de campa√±as y m√©tricas de participaci√≥n.',
      avgOpenRate: 'Tasa de Apertura Prom.',
      clickRate: 'Tasa de Clics',
      bounceRate: 'Tasa de Rebote',
      trendUp: '‚Üë 5% vs semana pasada',
      trendDown: '‚Üì 0.2% vs semana pasada',
      emailPerformance: 'Rendimiento de Correos (√öltimos 7 D√≠as)',
      day: 'D√≠a'
    },
    templates: {
      title: 'Plantillas',
      description: 'Gestiona tus dise√±os de mensajes guardados y respuestas r√°pidas.',
      newTemplate: '+ Nueva Plantilla',
      addNew: 'Agregar Nueva Plantilla',
      name: 'Nombre de la Plantilla',
      tag: 'Etiqueta (Categor√≠a)',
      subject: 'L√≠nea de Asunto',
      body: 'Cuerpo del Correo',
      use: 'Usar',
      edit: 'Editar',
      delete: 'Eliminar',
      general: 'General',
      noTemplates: 'No se encontraron plantillas.',
      confirmDelete: '¬øEliminar plantilla?'
    },
    settings: {
      title: 'Ajustes',
      description: 'Configura tus preferencias de cuenta y notificaciones.',
      profile: 'Informaci√≥n de Perfil',
      fullName: 'Nombre Completo',
      email: 'Correo Electr√≥nico',
      whatsappIntegration: 'Integraci√≥n de WhatsApp',
      whatsappToggle: 'Notificaciones de Correo en WhatsApp',
      whatsappDesc: 'Recibe notificaciones de WhatsApp para nuevos correos',
      connectedNumber: 'N√∫mero Conectado:',
      notifications: 'Notificaciones',
      campaignSummary: 'Resumen de Campa√±as de Correo',
      campaignSummaryDesc: 'Recibe un resumen semanal de tus estad√≠sticas de campa√±a',
      newCustomerAlert: 'Alerta de Nuevo Cliente',
      newCustomerAlertDesc: 'Recibe notificaci√≥n cuando se agregue un nuevo cliente',
      security: 'Seguridad',
      changePassword: 'Cambiar Contrase√±a',
      logOutEverywhere: 'Cerrar Sesi√≥n en Todas Partes',
      saved: '¬°Ajustes guardados exitosamente!'
    },
    preview: {
      title: 'Vista Previa del Mensaje',
      subject: 'Asunto'
    },
    footer: {
      allRightsReserved: 'Todos los derechos reservados.'
    },
    errors: {
      loadFailed: 'Error al cargar datos. Por favor actualiza.'
    }
  }
  // Add more languages as needed...
};

// ============================================
// SENT EMAILS ARRAY
// ============================================

let sentEmails = [];

// ============================================
// LANGUAGE DETECTION & URL HANDLING
// ============================================

// Available languages for dropdown
const availableLanguages = {
  en: { name: 'English', native: 'English', flag: 'üá∫üá∏' },
  es: { name: 'Spanish', native: 'Espa√±ol', flag: 'üá™üá∏' },
  fr: { name: 'French', native: 'Fran√ßais', flag: 'üá´üá∑' },
  de: { name: 'German', native: 'Deutsch', flag: 'üá©üá™' },
  it: { name: 'Italian', native: 'Italiano', flag: 'üáÆüáπ' },
  pt: { name: 'Portuguese', native: 'Portugu√™s', flag: 'üáµüáπ' },
  ru: { name: 'Russian', native: '–†—É—Å—Å–∫–∏–π', flag: 'üá∑üá∫' },
  zh: { name: 'Chinese', native: '‰∏≠Êñá', flag: 'üá®üá≥' },
  ja: { name: 'Japanese', native: 'Êó•Êú¨Ë™û', flag: 'üáØüáµ' },
  ko: { name: 'Korean', native: 'ÌïúÍµ≠Ïñ¥', flag: 'üá∞üá∑' },
  ar: { name: 'Arabic', native: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', flag: 'üá∏üá¶' },
  hi: { name: 'Hindi', native: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä', flag: 'üáÆüá≥' },
  bn: { name: 'Bengali', native: '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ', flag: 'üáßüá©' },
  pa: { name: 'Punjabi', native: '‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä', flag: 'üáÆüá≥' },
  te: { name: 'Telugu', native: '‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å', flag: 'üáÆüá≥' },
  mr: { name: 'Marathi', native: '‡§Æ‡§∞‡§æ‡§†‡•Ä', flag: 'üáÆüá≥' },
  ta: { name: 'Tamil', native: '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç', flag: 'üáÆüá≥' },
  ur: { name: 'Urdu', native: 'ÿßÿ±ÿØŸà', flag: 'üáµüá∞' },
  fa: { name: 'Persian', native: 'ŸÅÿßÿ±ÿ≥€å', flag: 'üáÆüá∑' },
  tr: { name: 'Turkish', native: 'T√ºrk√ße', flag: 'üáπüá∑' },
  nl: { name: 'Dutch', native: 'Nederlands', flag: 'üá≥üá±' },
  pl: { name: 'Polish', native: 'Polski', flag: 'üáµüá±' },
  uk: { name: 'Ukrainian', native: '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞', flag: 'üá∫üá¶' },
  el: { name: 'Greek', native: 'ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨', flag: 'üá¨üá∑' },
  cs: { name: 'Czech', native: 'ƒåe≈°tina', flag: 'üá®üáø' },
  sv: { name: 'Swedish', native: 'Svenska', flag: 'üá∏üá™' },
  da: { name: 'Danish', native: 'Dansk', flag: 'üá©üá∞' },
  fi: { name: 'Finnish', native: 'Suomi', flag: 'üá´üáÆ' },
  no: { name: 'Norwegian', native: 'Norsk', flag: 'üá≥üá¥' },
  he: { name: 'Hebrew', native: '◊¢◊ë◊®◊ô◊™', flag: 'üáÆüá±' },
  th: { name: 'Thai', native: '‡πÑ‡∏ó‡∏¢', flag: 'üáπüá≠' },
  vi: { name: 'Vietnamese', native: 'Ti·∫øng Vi·ªát', flag: 'üáªüá≥' },
  id: { name: 'Indonesian', native: 'Bahasa Indonesia', flag: 'üáÆüá©' },
  ms: { name: 'Malay', native: 'Bahasa Melayu', flag: 'üá≤üáæ' },
  tl: { name: 'Filipino', native: 'Filipino', flag: 'üáµüá≠' },
  sw: { name: 'Swahili', native: 'Kiswahili', flag: 'üáπüáø' },
  yo: { name: 'Yoruba', native: 'Yor√πb√°', flag: 'üá≥üá¨' },
  ig: { name: 'Igbo', native: 'Igbo', flag: 'üá≥üá¨' },
  ha: { name: 'Hausa', native: 'Hausa', flag: 'üá≥üá¨' },
  zu: { name: 'Zulu', native: 'isiZulu', flag: 'üáøüá¶' },
  xh: { name: 'Xhosa', native: 'isiXhosa', flag: 'üáøüá¶' }
};

let currentLang = 'en';

// Initialize i18next
i18next.init({
  lng: 'en',
  fallbackLng: 'en',
  debug: false,
  resources: Object.keys(translationResources).reduce((acc, lang) => {
    acc[lang] = { translation: translationResources[lang] };
    return acc;
  }, {}),
  detection: {
    order: ['querystring'],
    lookupQuerystring: 'lang'
  }
}, function(err, t) {
  if (err) return console.error('i18next init error:', err);
  
  const urlParams = new URLSearchParams(window.location.search);
  const urlLang = urlParams.get('lang');
  
  if (urlLang && translationResources[urlLang]) {
    changeLanguage(urlLang);
  } else {
    translatePage();
  }
});

function translatePage() {
  document.querySelectorAll('[data-i18n]').forEach(element => {
    const key = element.getAttribute('data-i18n');
    const translation = i18next.t(key);
    
    if (translation && translation !== key) {
      if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
        element.placeholder = translation;
      } else if (element.tagName === 'OPTION') {
        element.textContent = translation;
      } else {
        element.textContent = translation;
      }
    }
  });
  
  document.documentElement.lang = i18next.language;
}

function changeLanguage(lng) {
  i18next.changeLanguage(lng, (err, t) => {
    if (err) return console.error('Language change error:', err);
    
    translatePage();
    updateLanguageDisplay(lng);
    updateURLWithLanguage(lng);
    
    localStorage.setItem('preferredLanguage', lng);
  });
}

function updateLanguageDisplay(lng) {
  const currentLangEl = document.getElementById('currentLanguage');
  if (currentLangEl && availableLanguages[lng]) {
    currentLangEl.innerHTML = `${availableLanguages[lng].flag} ${availableLanguages[lng].native}`;
  }
}

function updateURLWithLanguage(lng) {
  const url = new URL(window.location);
  url.searchParams.set('lang', lng);
  window.history.replaceState({}, '', url);
}

function populateLanguageDropdown() {
  const dropdown = document.getElementById('languageDropdown');
  if (!dropdown) return;
  
  let html = '';
  const sortedLangs = Object.entries(availableLanguages).sort((a, b) => 
    a[1].native.localeCompare(b[1].native)
  );
  
  for (const [code, lang] of sortedLangs) {
    const isActive = code === i18next.language ? 'active' : '';
    html += `<div class="language-option ${isActive}" onclick="changeLanguage('${code}')">
      ${lang.flag} ${lang.native} (${lang.name})
    </div>`;
  }
  
  dropdown.innerHTML = html;
}

function toggleLanguageDropdown() {
  document.getElementById('languageDropdown').classList.toggle('show');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
  const dropdown = document.getElementById('languageDropdown');
  const btn = document.querySelector('.language-btn');
  if (btn && dropdown && !btn.contains(event.target) && !dropdown.contains(event.target)) {
    dropdown.classList.remove('show');
  }
});

// ============================================
// SENT EMAILS FUNCTIONS
// ============================================

// Save sent email to n8n webhook
async function saveSentEmail(emailData) {
  try {
    const payload = {
      userId: flowId,
      emailData: emailData
    };
    
    const response = await secureFetch('https://kingoftech.app.n8n.cloud/webhook/save-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    if (response.ok) {
      console.log('Email saved successfully to n8n');
    } else {
      console.error('Failed to save email to n8n');
    }
  } catch (error) {
    console.error('Error saving email to n8n:', error);
  }
}

// Add sent email to local array and update UI
function addSentEmail(emailData) {
  const emailRecord = {
    id: Date.now().toString(),
    campaignName: emailData.campaignName,
    subject: emailData.subject,
    body: emailData.body,
    fromName: emailData.fromName,
    fromEmail: emailData.fromEmail,
    recipients: emailData.recipients,
    recipientCount: emailData.recipients.length,
    sentAt: new Date().toISOString()
  };
  
  sentEmails.unshift(emailRecord);
  
  updateSentCounts();
  
  if (document.getElementById('sentSection').style.display !== 'none') {
    renderSentEmails();
  }
  
  saveSentEmail(emailRecord);
}

// Update sent email counts in UI
function updateSentCounts() {
  const count = sentEmails.length;
  const sentEmailsCountEl = document.getElementById('sentEmailsCount');
  const totalSentCountEl = document.getElementById('totalSentCount');
  const sentCountDisplayEl = document.getElementById('sentCountDisplay');
  
  if (sentEmailsCountEl) sentEmailsCountEl.textContent = count;
  if (totalSentCountEl) totalSentCountEl.textContent = count + ' total';
  if (sentCountDisplayEl) sentCountDisplayEl.textContent = count + ' Sent';
}

// Render sent emails list
function renderSentEmails() {
  const container = document.getElementById('sentEmailsList');
  if (!container) return;
  
  if (sentEmails.length === 0) {
    container.innerHTML = `<div class="empty-sent" data-i18n="sent.noEmails">No sent emails yet. Start sending automated messages!</div>`;
    return;
  }
  
  let html = '';
  sentEmails.forEach(email => {
    const date = new Date(email.sentAt).toLocaleString();
    const recipientsList = email.recipients.map(r => 
      `<span class="recipient-tag">${escapeHtml(r)}</span>`
    ).join('');
    
    html += `
      <div class="sent-email-item">
        <div class="sent-email-header">
          <span class="sent-email-subject">${escapeHtml(email.subject)}</span>
          <span class="sent-email-date">${date}</span>
        </div>
        <div class="sent-email-recipients">
          <strong>${i18next.t('sent.to')}:</strong> ${recipientsList}
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span class="sent-email-campaign">${escapeHtml(email.campaignName)}</span>
          <span style="font-size: 12px; color: var(--text-tertiary);">
            ${email.recipientCount} ${email.recipientCount === 1 ? 'recipient' : 'recipients'}
          </span>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

// ============================================
// MODIFIED SEND AUTOMATED MESSAGES FUNCTION
// ============================================

async function sendAutomatedMessages() {
    const auth = await checkAuth();
    if (!auth) return;
    
    if(selectedEmails.size === 0) { 
        alert(i18next.t('automation.noRecipients') || 'No recipients selected'); 
        return; 
    }
    
    if (!isGoogleConnected) {
        alert(i18next.t('automation.googleRequired') || "Action Blocked: You must connect your Google Account to send automated messages.");
        closeModal('previewModal');
        document.querySelector('.google-connect-card').scrollIntoView({ behavior: 'smooth' });
        return;
    }
    
    const btn = document.getElementById('btnConfirmSend');
    setButtonLoading(btn, true, i18next.t('automation.sending') || 'Sending...');
    
    const payload = {
        userId: flowId,
        campaignName: document.getElementById('campaignName').value,
        recipients: Array.from(selectedEmails),
        subject: document.getElementById('emailSubject').value,
        body: document.getElementById('emailBody').value,
        fromName: document.getElementById('fromName').value,
        fromEmail: document.getElementById('fromEmail').value
    };
    
    console.log('Sending payload:', payload);
    
    try {
        const res = await secureFetch(`${API_BASE_URL}/send-automated-messages`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        
        if(!res.ok) {
            const error = await res.json();
            throw new Error(error.error || 'Send failed');
        }
        
        const result = await res.json();
        
        addSentEmail(payload);
        
        showMessage(i18next.t('automation.sent', { count: selectedEmails.size }) || `Sent to ${selectedEmails.size} recipients`, 'success');
        closeModal('previewModal');
        selectedEmails.clear();
        renderEmailList();
    } catch(e) {
        console.error(e);
        showMessage(i18next.t('automation.sendFailed') || 'Failed to send messages', 'error');
    } finally {
        setButtonLoading(btn, false);
    }
}

// ============================================
// CONFIGURATION & GLOBAL STATE
// ============================================
const API_BASE_URL = 'https://flowon.onrender.com/api'; 
let flowId = null;

// Global Variables
let currentUser = null;
let customers = [];
let templates = [];
let inboxMessages = [];
let currentMessageIndex = -1;
let selectedEmails = new Set();
let isGoogleConnected = false;
let isWhatsAppConnected = false;
let whatsAppNumber = '';
let userEmail = '';

const defaultTemplates = [
    { name: "Welcome Email", tag: "Onboarding", subject: "Welcome to our community!", body: "Welcome to our community! We're excited to have you..." },
    { name: "Product Update", tag: "News", subject: "New features just launched!", body: "Check out the latest features we've just released..." },
    { name: "Black Friday Promo", tag: "Sales", subject: "50% OFF Everything!", body: "Get 50% off everything this weekend only!" },
    { name: "Feedback Request", tag: "Support", subject: "We'd love your feedback", body: "We'd love to hear your thoughts on your recent purchase..." }
];

// ============================================
// REDIRECT TO SIGNUP
// ============================================

function redirectToSignup() {
    window.location.href = 'signup.html';
}

// ============================================
// INITIALIZATION
// ============================================

document.addEventListener('DOMContentLoaded', async function() {
  populateLanguageDropdown();
  
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('status') === 'connected') {
      window.history.replaceState({}, document.title, window.location.pathname);
      updateGoogleConnectionUI(true);
      showMessage(i18next.t('dashboard.googleConnected') || 'Google Account Connected Successfully!', 'success');
      showSection('automation');
  }

  const isAuthenticated = await checkSession();

  if (!isAuthenticated) {
    document.getElementById('logoutauth').style.display = 'none';
    document.getElementById('signupauth').style.display = 'flex';
    document.getElementById('loginRequiredModal').style.display = 'flex';
    
    const mobileAuthStatus = document.getElementById('mobileAuthStatus');
    if (mobileAuthStatus) {
      mobileAuthStatus.innerHTML = `
        <div class="auth-status-item">
          <span class="auth-icon">üîí</span>
          <span>${i18next.t('auth.notSignedIn')}</span>
        </div>
        <div class="auth-status-item" style="margin-top: 8px;">
          <a href="signup.html" style="color: var(--text-main); text-decoration: none; font-weight: 600;">${i18next.t('auth.signIn')}</a>
          <span style="margin: 0 4px;">${i18next.t('auth.or')}</span>
          <a href="signup.html" style="color: var(--text-main); text-decoration: none; font-weight: 600;">${i18next.t('auth.register')}</a>
        </div>
      `;
    }
    return;
  } else {
    flowId = sessionStorage.getItem('userId');
    
    document.getElementById('logoutauth').style.display = 'flex';
    document.getElementById('signupauth').style.display = 'none';
    
    const mobileAuthStatus = document.getElementById('mobileAuthStatus');
    if (mobileAuthStatus) {
      mobileAuthStatus.innerHTML = `
        <div class="auth-status-item">
          <span class="auth-icon">‚úì</span>
          <span>${i18next.t('auth.signedIn') || 'Signed in'}</span>
        </div>
      `;
    }
  }
  
  await loadUserData();
  checkWhatsAppStatus();
  setupEventListeners();
  setInterval(loadInboxMessages, 30000);
});

function setupEventListeners() {
  const scheduleSelect = document.getElementById('scheduleType');
  if(scheduleSelect) {
      scheduleSelect.addEventListener('change', function() {
        const scheduleDateGroup = document.getElementById('scheduleDateGroup');
        if (scheduleDateGroup) {
          scheduleDateGroup.style.display = this.value === 'scheduled' ? 'block' : 'none';
        }
      });
  }
  
  const msgForm = document.getElementById('messageForm');
  if(msgForm) {
      msgForm.addEventListener('submit', function(e) {
        e.preventDefault();
        previewMessage();
      });
  }
}

// ============================================
// GOOGLE INTEGRATION LOGIC
// ============================================

async function connectGoogle() {
   const auth = await checkAuth();
   if (!auth) return;
   
   const userId = sessionStorage.getItem('userId'); 
   
   if (!userId) {
       alert("User ID is missing. Please log in again.");
       return;
   }
   
   const targetUrl = `${API_BASE_URL}/google/connect`;
   window.location.href = targetUrl;
}

function updateGoogleConnectionUI(isConnected) {
    isGoogleConnected = isConnected;
    
    const statusEl = document.getElementById('connectionStatus');
    const btn = document.getElementById('btnConnectGoogle');
    const inboxStatusEl = document.getElementById('inboxConnectionStatus');
    const inboxConnectContainer = document.getElementById('inboxConnectContainer');
    const inboxLayout = document.getElementById('inboxLayout');
    
    if (isConnected) {
        if (statusEl) {
            statusEl.className = 'connection-status status-connected';
            statusEl.innerHTML = '<span class="status-dot"></span><span>' + i18next.t('inbox.connected') + '</span>';
        }
        if (btn) {
            btn.innerHTML = '‚úì ' + (i18next.t('inbox.connected') || 'Account Linked') + ' (Reconnect?)';
            btn.className = 'btn btn-success';
            btn.onclick = function() {
                if(confirm('Do you want to reconnect your Google Account?')) {
                    connectGoogle();
                }
            };
        }
        if (inboxStatusEl) {
            inboxStatusEl.className = 'connection-status status-connected';
            inboxStatusEl.innerHTML = '<span class="status-dot"></span><span>' + i18next.t('inbox.connected') + '</span>';
        }
        if (inboxConnectContainer) inboxConnectContainer.style.display = 'none';
        if (inboxLayout) inboxLayout.style.display = 'grid';
        
        loadInboxMessages();
    } else {
        if (statusEl) {
            statusEl.className = 'connection-status status-disconnected';
            statusEl.innerHTML = '<span class="status-dot"></span><span>' + i18next.t('inbox.disconnected') + '</span>';
        }
        if (btn) {
            btn.innerHTML = i18next.t('buttons.connectGmail') || 'Connect Gmail';
            btn.className = 'btn btn-secondary';
            btn.onclick = connectGoogle;
        }
        if (inboxStatusEl) {
            inboxStatusEl.className = 'connection-status status-disconnected';
            inboxStatusEl.innerHTML = '<span class="status-dot"></span><span>' + i18next.t('inbox.disconnected') + '</span>';
        }
        if (inboxConnectContainer) inboxConnectContainer.style.display = 'block';
        if (inboxLayout) inboxLayout.style.display = 'none';
    }
    
    const headerStatus = document.getElementById('headerGoogleStatus');
    if(headerStatus) {
        headerStatus.style.display = isConnected ? 'inline-flex' : 'none';
    }
    
    const sidebarStatus = document.getElementById('sidebarGoogleStatus');
    if(sidebarStatus) {
        sidebarStatus.innerHTML = isConnected 
            ? '<div style="width: 8px; height: 8px; border-radius: 50%; background: var(--color-green-text);"></div> ' + i18next.t('status.gmailLinked')
            : '<div style="width: 8px; height: 8px; border-radius: 50%; background: #ccc;"></div> ' + i18next.t('status.gmailNotLinked');
    }
}

// ============================================
// WHATSAPP INTEGRATION LOGIC
// ============================================

async function checkWhatsAppStatus() {
    const auth = await checkAuth();
    if (!auth) return;
    
    try {
        const res = await secureFetch(`${API_BASE_URL}/whatsapp/status`);
        if (res.ok) {
            const data = await res.json();
            updateWhatsAppUI(data.connected, data.phoneNumber);
        }
    } catch (e) {
        console.error("Failed to check WhatsApp status", e);
    }
}

function updateWhatsAppUI(connected, number = '') {
    isWhatsAppConnected = connected;
    whatsAppNumber = number;
    
    const notConnectedDiv = document.getElementById('whatsappNotConnected');
    const connectedDiv = document.getElementById('whatsappConnected');
    const numberDisplay = document.getElementById('whatsappNumberDisplay');
    const statusEl = document.getElementById('whatsappStatus');
    const settingsNumberDiv = document.getElementById('whatsappSettingsNumber');
    const settingsNumberSpan = document.getElementById('settingsWhatsAppNumber');
    const headerStatus = document.getElementById('headerWhatsAppStatus');
    const sidebarStatus = document.getElementById('sidebarWhatsAppStatus');
    const whatsappToggle = document.getElementById('whatsappToggle');
    
    if (connected) {
        if (notConnectedDiv) notConnectedDiv.style.display = 'none';
        if (connectedDiv) connectedDiv.style.display = 'block';
        if (numberDisplay) numberDisplay.textContent = `(${number})`;
        if (statusEl) {
            statusEl.className = 'connection-status status-connected';
            statusEl.innerHTML = '<span class="status-dot"></span><span>' + i18next.t('whatsapp.connected') + '</span>';
        }
        if (settingsNumberDiv) {
            settingsNumberDiv.style.display = 'block';
            if (settingsNumberSpan) settingsNumberSpan.textContent = number;
        }
        if (headerStatus) headerStatus.style.display = 'inline-flex';
        if (sidebarStatus) {
            sidebarStatus.innerHTML = `<div style="width: 8px; height: 8px; border-radius: 50%; background: var(--whatsapp-green);"></div> ` + i18next.t('status.whatsappConnected');
        }
        if (whatsappToggle) whatsappToggle.checked = true;
    } else {
        if (notConnectedDiv) notConnectedDiv.style.display = 'block';
        if (connectedDiv) connectedDiv.style.display = 'none';
        if (statusEl) {
            statusEl.className = 'connection-status status-disconnected';
            statusEl.innerHTML = '<span class="status-dot"></span><span>' + i18next.t('automation.notConnected') + '</span>';
        }
        if (settingsNumberDiv) settingsNumberDiv.style.display = 'none';
        if (headerStatus) headerStatus.style.display = 'none';
        if (sidebarStatus) {
            sidebarStatus.innerHTML = '<div style="width: 8px; height: 8px; border-radius: 50%; background: #ccc;"></div> ' + i18next.t('status.whatsappNotConnected');
        }
        if (whatsappToggle) whatsappToggle.checked = false;
    }
}

async function registerWhatsApp() {
    const auth = await checkAuth();
    if (!auth) return;
    
    const phoneNumber = document.getElementById('whatsappNumber').value.trim();
    if (!phoneNumber) {
        alert(i18next.t('whatsapp.enterNumber') || 'Please enter your WhatsApp number');
        return;
    }
    
    const phoneRegex = /^\+?[1-9]\d{1,14}$/;
    if (!phoneRegex.test(phoneNumber.replace(/\s/g, ''))) {
        alert(i18next.t('whatsapp.invalidFormat') || 'Invalid phone number format. Please use international format (e.g., +1234567890)');
        return;
    }
    
    const btn = document.getElementById('testWhatsAppBtn') || document.querySelector('.btn-whatsapp');
    setButtonLoading(btn, true, 'Registering...');
    
    try {
        const res = await secureFetch(`${API_BASE_URL}/whatsapp/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phoneNumber })
        });
        
        if (res.ok) {
            showMessage(i18next.t('whatsapp.registered') || 'WhatsApp number registered successfully!', 'success');
            updateWhatsAppUI(true, phoneNumber);
        } else {
            const error = await res.json();
            throw new Error(error.error || 'Registration failed');
        }
    } catch (e) {
        console.error(e);
        showMessage(i18next.t('whatsapp.registrationFailed') || 'Failed to register WhatsApp number', 'error');
    } finally {
        setButtonLoading(btn, false);
    }
}

async function disconnectWhatsApp() {
    if (!confirm(i18next.t('whatsapp.confirmDisconnect') || 'Disconnect WhatsApp? You will stop receiving notifications.')) return;
    
    updateWhatsAppUI(false);
    showMessage(i18next.t('whatsapp.disconnected') || 'WhatsApp disconnected', 'success');
}

async function testWhatsApp() {
    const auth = await checkAuth();
    if (!auth || !isWhatsAppConnected) {
        alert(i18next.t('whatsapp.connectFirst') || 'Please connect WhatsApp first');
        return;
    }
    
    const btn = document.getElementById('testWhatsAppBtn');
    setButtonLoading(btn, true, 'Sending...');
    
    try {
        const res = await secureFetch(`${API_BASE_URL}/whatsapp/notify`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: flowId,
                message: i18next.t('whatsapp.testMessage') || 'This is a test notification from Flux On',
                from: 'Flux On System',
                subject: i18next.t('whatsapp.testSubject') || 'Test Notification'
            })
        });
        
        if (res.ok) {
            showMessage(i18next.t('whatsapp.testSent') || 'Test notification sent to your WhatsApp!', 'success');
        } else {
            throw new Error('Failed to send test');
        }
    } catch (e) {
        console.error(e);
        showMessage(i18next.t('whatsapp.testFailed') || 'Failed to send test notification', 'error');
    } finally {
        setButtonLoading(btn, false);
    }
}

function toggleWhatsAppNotifications() {
    const toggle = document.getElementById('whatsappToggle');
    if (toggle && toggle.checked && !isWhatsAppConnected) {
        alert(i18next.t('whatsapp.connectFirst') || 'Please connect WhatsApp first in the WhatsApp section');
        toggle.checked = false;
        showSection('whatsapp');
    } else if (toggle && toggle.checked) {
        showMessage(i18next.t('whatsapp.notificationsEnabled') || 'WhatsApp notifications enabled', 'success');
    } else {
        showMessage(i18next.t('whatsapp.notificationsDisabled') || 'WhatsApp notifications disabled', 'info');
    }
}

async function sendToWhatsApp() {
    const auth = await checkAuth();
    if (!auth) return;
    if (currentMessageIndex === -1) return;
    
    if (!isWhatsAppConnected) {
        if (confirm(i18next.t('whatsapp.connectPrompt') || 'WhatsApp not connected. Would you like to connect now?')) {
            showSection('whatsapp');
        }
        return;
    }
    
    const msg = inboxMessages[currentMessageIndex];
    
    const btn = document.getElementById('whatsappNotifyBtn');
    setButtonLoading(btn, true, '');
    
    try {
        const res = await secureFetch(`${API_BASE_URL}/whatsapp/notify-new-message`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: flowId,
                messageId: msg.id,
                from: msg.from_name || msg.from_email,
                subject: msg.subject,
                snippet: msg.snippet
            })
        });
        
        if (res.ok) {
            showMessage(i18next.t('inbox.sentToWhatsApp') || 'Message sent to your WhatsApp!', 'success');
        } else {
            throw new Error('Failed to send');
        }
    } catch (e) {
        console.error(e);
        showMessage(i18next.t('inbox.sendFailed') || 'Failed to send to WhatsApp', 'error');
    } finally {
        setButtonLoading(btn, false);
    }
}

// ============================================
// DATA LOADING ENGINE
// ============================================

function parseAndFlattenCustomers(input) {
    if (!input) return [];
    if (typeof input === 'string') {
        try { input = JSON.parse(input); } catch (e) { return []; }
    }
    if (!Array.isArray(input)) {
        if (typeof input === 'object' && input !== null) return [input];
        return [];
    }
    let flatList = [];
    input.forEach(item => {
        if (typeof item === 'string') {
            try {
                const parsed = JSON.parse(item);
                if (Array.isArray(parsed)) flatList = flatList.concat(parsed);
                else if (typeof parsed === 'object' && parsed !== null) flatList.push(parsed);
            } catch (e) {}
        } 
        else if (Array.isArray(item)) flatList = flatList.concat(item);
        else if (typeof item === 'object' && item !== null) flatList.push(item);
    });
    return flatList;
}

function normalizeCustomerData(flatList) {
    const seenEmails = new Set();
    const uniqueList = [];
    flatList.forEach(c => {
        if (!c || typeof c !== 'object') return;
        const customer = {
            name: c.name || 'Unknown',
            email: c.email || '',
            phone: c.phone || '',
            company: c.company || '',
            status: c.status || 'Active',
            createdAt: c.createdAt || new Date().toISOString()
        };
        if (customer.email && customer.email.includes('@')) {
            if (!seenEmails.has(customer.email.toLowerCase())) {
                seenEmails.add(customer.email.toLowerCase());
                uniqueList.push(customer);
            }
        } else {
            uniqueList.push(customer); 
        }
    });
    return uniqueList;
}

function safeParseTemplates(input) {
    if (Array.isArray(input)) return input;
    if (typeof input === 'string') {
        try { return JSON.parse(input); } catch(e) { return []; }
    }
    return [];
}

async function loadUserData() {
  const auth = await checkAuth();
  if (!auth) return;
  
  try {
    showGlobalLoader(true, 'Loading Dashboard...');
    
    const response = await secureFetch(`${API_BASE_URL}/userdata/${flowId}`);
    if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
    const userData = await response.json();
    currentUser = userData;
    
    const username = userData.username || userData.email || 'User';
    updateText('userGreeting', username.split(' ')[0]);
    updateText('profileName', username);
    updateText('userInitials', getInitials(username));
    updateValue('settingsName', username);
    updateValue('settingsEmail', userData.email || '');
    userEmail = userData.email || '';
    
    const hasTokens = userData.google_access_token && userData.google_refresh_token;
    updateGoogleConnectionUI(hasTokens);
    
    const rawFlattened = parseAndFlattenCustomers(userData.customers);
    customers = normalizeCustomerData(rawFlattened);
    
    const rawTemplates = safeParseTemplates(userData.templates);
    templates = rawTemplates.length > 0 ? rawTemplates : [...defaultTemplates];
    
    if (userData.email_save) {
        try {
            const outerArray = JSON.parse(userData.email_save);
            console.log('Outer array:', outerArray);
            
            let allEmails = [];
            
            outerArray.forEach(item => {
                try {
                    const emailArray = JSON.parse(item);
                    if (Array.isArray(emailArray) && emailArray.length > 0) {
                        allEmails.push(emailArray[0]);
                    }
                } catch (innerError) {
                    console.error('Error parsing inner email:', innerError);
                }
            });
            
            sentEmails = allEmails;
            console.log('Loaded sent emails:', sentEmails);
            
        } catch (e) {
            console.error('Error parsing email_save:', e);
            sentEmails = [];
        }
    } else {
        sentEmails = [];
    }
    
    updateSentCounts();
    
    updateDashboardStats();
    renderCustomerTable();
    renderEmailList();
    renderTemplates();
    renderTemplateSelector();
    renderAnalytics();
    
    if (hasTokens) {
        await loadInboxMessages();
    }
    
    await checkWhatsAppStatus();
    
  } catch (error) {
    console.error('CRITICAL ERROR loading data:', error);
    showMessage(i18next.t('errors.loadFailed') || 'Failed to load data. Please refresh.', 'error');
  } finally {
    showGlobalLoader(false);
  }
}

// ============================================
// INBOX API FUNCTIONS
// ============================================

function cleanN8nValue(val) {
    if (!val) return '';
    if (typeof val === 'string' && val.startsWith('=')) {
        return val.substring(1);
    }
    return val;
}

async function loadInboxMessages() {
    const auth = await checkAuth();
    if (!auth || !isGoogleConnected) return;
    
    try {
        const res = await secureFetch(`${API_BASE_URL}/inbox`);
        if (res.ok) {
            inboxMessages = await res.json();
            updateNotificationCount();
            renderInboxList();
        } else if (res.status === 401) {
            updateGoogleConnectionUI(false);
        }
    } catch (e) {
        console.error("Failed to load inbox", e);
    }
}

function updateNotificationCount() {
    const unread = inboxMessages.filter(m => !m.read).length;
    const badge = document.getElementById('notificationBadge');
    const unreadStatsEl = document.getElementById('unreadStats');
    
    if (badge) {
        badge.textContent = unread;
        if (unread > 0) {
            badge.classList.add('show');
        } else {
            badge.classList.remove('show');
        }
    }
    
    if (unreadStatsEl) {
        updateText('unreadStats', unread);
    }
}

function renderInboxList() {
    const listContainer = document.getElementById('inboxList');
    if (!listContainer) return;
    
    if (inboxMessages.length === 0) {
        listContainer.innerHTML = `<div style="padding: 40px 24px; text-align: center; color: var(--text-tertiary);">
            <div style="font-size: 24px; margin-bottom: 8px;">üì≠</div>
            ${i18next.t('inbox.noMessages')}
        </div>`;
        return;
    }
    
    let html = '';
    inboxMessages.forEach((msg, index) => {
        const from = msg.from_name || msg.from_email || 'Unknown';
        const subject = msg.subject || '(No Subject)';
        
        let dateDisplay = i18next.t('inbox.today');
        if(msg.date) {
            const d = new Date(msg.date);
            if(!isNaN(d.getTime())) dateDisplay = d.toLocaleDateString();
        }
        
        const snippet = msg.snippet || i18next.t('inbox.noPreview');
        
        const isReadClass = msg.read ? '' : 'unread';
        const selectedClass = index === currentMessageIndex ? 'selected' : '';
        
        html += `
            <div class="inbox-item ${isReadClass} ${selectedClass}" onclick="viewEmail(${index})">
                <div class="inbox-item-header">
                    <span class="inbox-sender">${escapeHtml(from)}</span>
                    <span class="inbox-date">${dateDisplay}</span>
                </div>
                <div class="inbox-subject">${escapeHtml(subject)}</div>
                <div class="inbox-snippet">${escapeHtml(snippet)}</div>
            </div>
        `;
    });
    listContainer.innerHTML = html;
}

async function viewEmail(index) {
    const auth = await checkAuth();
    if (!auth || !isGoogleConnected) return;
    
    const msg = inboxMessages[index];
    if (!msg) return;
    
    currentMessageIndex = index;
    
    if (!msg.read) {
        msg.read = true;
        updateNotificationCount();
        
        try {
            await secureFetch(`${API_BASE_URL}/inbox/read/${msg.id}`, { 
                method: 'POST' 
            });
        } catch(e) {
            console.error('Failed to mark as read', e);
        }
    }
    
    renderInboxList();
    
    document.getElementById('inboxEmptyState').style.display = 'none';
    const content = document.getElementById('inboxContent');
    content.style.display = 'flex';
    
    const fromName = msg.from_name || 'Unknown';
    const fromEmail = msg.from_email || '';
    const subject = msg.subject || i18next.t('inbox.subject');
    
    let dateStr = i18next.t('inbox.unknownDate');
    if (msg.date) {
         const d = new Date(msg.date);
         if(!isNaN(d.getTime())) dateStr = d.toLocaleString();
    }
    
    updateText('viewSubject', subject);
    updateText('viewSender', fromName);
    updateText('viewEmail', fromEmail);
    updateText('viewDate', dateStr);
    updateText('viewAvatar', getInitials(fromName));
    
    const bodyContainer = document.getElementById('viewBody');
    const htmlContent = msg.body_html;
    const textContent = msg.body_text;
    
    if (htmlContent && !htmlContent.startsWith('=')) {
        bodyContainer.innerHTML = sanitizeHTML(htmlContent);
    } else {
        bodyContainer.innerHTML = `<pre style="font-family: inherit; white-space: pre-wrap;">${escapeHtml(textContent || i18next.t('inbox.noContent'))}</pre>`;
    }
    
    if(window.innerWidth <= 768) {
        document.getElementById('inboxView').classList.add('active');
    }
}

async function deleteCurrentMessage() {
    const auth = await checkAuth();
    if (!auth || !isGoogleConnected) return;
    if (currentMessageIndex === -1) return;
    
    if(!confirm(i18next.t('inbox.confirmDelete') || 'Delete this message permanently?')) return;
    
    const msg = inboxMessages[currentMessageIndex];
    
    try {
        await secureFetch(`${API_BASE_URL}/inbox/${msg.id}`, { 
            method: 'DELETE' 
        });
        
        inboxMessages.splice(currentMessageIndex, 1);
        currentMessageIndex = -1;
        
        document.getElementById('inboxContent').style.display = 'none';
        document.getElementById('inboxEmptyState').style.display = 'flex';
        
        if(window.innerWidth <= 768) closeMobileInbox();
        renderInboxList();
        updateNotificationCount();
        
        showMessage(i18next.t('inbox.deleted') || 'Message deleted', 'success');
    } catch (e) {
        console.error("Delete failed", e);
        showMessage(i18next.t('inbox.deleteFailed') || 'Error deleting message', 'error');
    }
}

function closeMobileInbox() {
    document.getElementById('inboxView').classList.remove('active');
    currentMessageIndex = -1;
    renderInboxList();
}

// ============================================
// UI RENDERING FUNCTIONS
// ============================================

function updateDashboardStats() {
  const total = customers.length;
  updateText('totalCustomers', total);
  updateText('totalEmails', total); 
  updateText('activeCampaigns', '2'); 
  updateText('responseRate', '18%'); 
  updateText('customerCount', `(${total})`);
}

function renderCustomerTable() {
  const container = document.getElementById('tableContainer');
  if (!container) return;
  
  if (customers.length === 0) {
    container.innerHTML = `
      <div style="padding: 40px; text-align: center;">
        <h3 style="margin-top:0;">${i18next.t('customers.noCustomers') || 'No Customers Yet'}</h3>
        <p style="color: var(--text-secondary); margin-bottom: 20px;">${i18next.t('customers.startAdding') || 'Start by adding or importing customers.'}</p>
        <button class="btn btn-primary" onclick="addNewCustomer()">${i18next.t('customers.addFirst') || 'Add First Customer'}</button>
      </div>`;
    return;
  }
  
  let html = `
    <table class="simple-table">
      <thead>
        <tr>
          <th width="40">#</th>
          <th>${i18next.t('customers.name') || 'Name'}</th>
          <th>${i18next.t('customers.email')}</th>
          <th>${i18next.t('customers.phone')}</th>
          <th>${i18next.t('customers.company')}</th>
          <th>${i18next.t('customers.status')}</th>
          <th width="100">${i18next.t('customers.actions') || 'Actions'}</th>
        </tr>
      </thead>
      <tbody>`;
  
  customers.forEach((c, i) => {
    const status = c.status || 'Active';
    html += `
      <tr>
        <td style="color: var(--text-tertiary);">${i + 1}</td>
        <td><input class="table-input" value="${escapeHtml(c.name)}" onchange="updateCustomerField(${i}, 'name', this.value)"></td>
        <td><input class="table-input" value="${escapeHtml(c.email)}" onchange="updateCustomerField(${i}, 'email', this.value)"></td>
        <td><input class="table-input" value="${escapeHtml(c.phone)}" onchange="updateCustomerField(${i}, 'phone', this.value)"></td>
        <td><input class="table-input" value="${escapeHtml(c.company)}" onchange="updateCustomerField(${i}, 'company', this.value)"></td>
        <td>
          <select class="table-input email-status status-${status.toLowerCase()}" style="width: auto;" onchange="updateCustomerField(${i}, 'status', this.value)">
            <option value="Active" ${status === 'Active' ? 'selected' : ''}>${i18next.t('customers.active')}</option>
            <option value="Inactive" ${status === 'Inactive' ? 'selected' : ''}>${i18next.t('customers.inactive')}</option>
            <option value="Pending" ${status === 'Pending' ? 'selected' : ''}>${i18next.t('customers.pending')}</option>
          </select>
        </td>
        <td style="display: flex; gap: 4px;">
          <button class="icon-btn btn" style="width: 32px; padding: 0;" onclick="saveCustomer(${i})" title="${i18next.t('customers.save') || 'Save'}">üíæ</button>
          <button class="icon-btn btn" style="width: 32px; padding: 0; color: var(--color-red-text);" onclick="deleteCustomer(${i})" title="${i18next.t('customers.delete') || 'Delete'}">üóëÔ∏è</button>
        </td>
      </tr>`;
  });
  
  html += `</tbody></table>`;
  container.innerHTML = html;
}

function renderEmailList() {
  const container = document.getElementById('emailList');
  if(!container) return;
  
  const validCustomers = customers.filter(c => c.email && c.email.includes('@'));
  if (validCustomers.length === 0) {
    container.innerHTML = `<div style="padding: 24px; text-align: center; color: var(--text-secondary);"><p>${i18next.t('automation.noValidEmails') || 'No valid email addresses found.'}</p></div>`;
    return;
  }
  
  let html = '';
  validCustomers.forEach((c) => {
    const isSelected = selectedEmails.has(c.email);
    const status = c.status || 'Active';
    html += `
      <div class="email-item">
        <input type="checkbox" class="email-checkbox" 
               data-email="${c.email}" 
               ${isSelected ? 'checked' : ''} 
               onchange="toggleEmailSelection(this)">
        <div class="email-info">
          <div class="email-address">${escapeHtml(c.email)}</div>
          <div class="email-customer">${escapeHtml(c.name)} ¬∑ ${escapeHtml(c.company)}</div>
        </div>
        <div class="email-status status-${status.toLowerCase()}">${i18next.t(`customers.${status.toLowerCase()}`)}</div>
      </div>`;
  });
  
  container.innerHTML = html;
  updateSelectionCount();
}

function renderTemplates() {
    const grid = document.getElementById('templatesGrid');
    if(!grid) return;
    
    if (templates.length === 0) {
        grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 40px;">${i18next.t('templates.noTemplates') || 'No templates found.'}</div>`;
        return;
    }
    
    let html = '';
    templates.forEach((t, i) => {
        html += `
            <div class="template-card">
                <div class="template-card-header">
                    <span class="template-name">${escapeHtml(t.name)}</span>
                    <span class="template-tag">${escapeHtml(t.tag || i18next.t('templates.general') || 'General')}</span>
                </div>
                <div class="template-body">${escapeHtml(t.body || '')}</div>
                <div class="template-footer">
                    <button class="btn btn-secondary" style="height: 32px; font-size: 13px; flex: 1;" onclick="useTemplate(${i})">${i18next.t('templates.use') || 'Use'}</button>
                    <button class="btn btn-secondary" style="height: 32px; font-size: 13px;" onclick="editTemplate(${i})">${i18next.t('templates.edit') || 'Edit'}</button>
                    <button class="btn btn-secondary" style="height: 32px; font-size: 13px; color: var(--color-red-text);" onclick="deleteTemplate(${i})">${i18next.t('templates.delete') || 'Del'}</button>
                </div>
            </div>`;
    });
    
    grid.innerHTML = html;
}

function renderTemplateSelector() {
    const container = document.getElementById('automationTemplateSelector');
    if(!container) return;
    
    let html = '';
    templates.forEach((t, i) => {
        html += `<button class="template-btn" onclick="loadTemplate(${i})">${escapeHtml(t.name)}</button> `;
    });
    html += `<button class="template-btn" onclick="loadTemplate('custom')">${i18next.t('automation.blank')}</button>`;
    container.innerHTML = html;
}

// ============================================
// USER ACTIONS & LOGIC
// ============================================

async function toggleEmailSelection(checkbox) {
  if (!await checkAuth()) return;
  const email = checkbox.dataset.email;
  if (checkbox.checked) selectedEmails.add(email);
  else selectedEmails.delete(email);
  updateSelectionCount();
  updateSelectAllCheckbox();
}

async function toggleAllEmails() {
  if (!await checkAuth()) return;
  const selectAll = document.getElementById('selectAllEmails');
  const checkboxes = document.querySelectorAll('.email-checkbox');
  
  if (selectAll.checked) {
    selectedEmails.clear();
    checkboxes.forEach(cb => {
        cb.checked = true;
        selectedEmails.add(cb.dataset.email);
    });
  } else {
    selectedEmails.clear();
    checkboxes.forEach(cb => cb.checked = false);
  }
  updateSelectionCount();
}

function updateSelectionCount() {
  updateText('selectedCount', selectedEmails.size);
}

function updateSelectAllCheckbox() {
  const selectAll = document.getElementById('selectAllEmails');
  const checkboxes = document.querySelectorAll('.email-checkbox');
  const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
  
  if(selectAll) {
      selectAll.checked = checkedCount === checkboxes.length && checkboxes.length > 0;
      selectAll.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
  }
}

function updateCustomerField(index, field, value) {
  if (!customers[index]) customers[index] = {};
  customers[index][field] = sanitizeInput(value);
}

async function saveCustomer(index) {
  if (!await checkAuth()) return;
  await saveAllChanges();
}

async function deleteCustomer(index) {
  if (!await checkAuth()) return;
  if (!confirm(i18next.t('customers.confirmDelete') || 'Are you sure you want to delete this customer?')) return;
  customers.splice(index, 1);
  refreshUI();
  await saveAllChanges();
}

async function addNewCustomer() {
  if (!await checkAuth()) return;
  updateValue('newCustomerName', '');
  updateValue('newCustomerEmail', '');
  updateValue('newCustomerPhone', '');
  updateValue('newCustomerCompany', '');
  updateValue('newCustomerStatus', 'Active');
  openModal('addCustomerModal');
}

async function saveNewCustomer() {
  if (!await checkAuth()) return;
  const btn = document.getElementById('btnSaveCustomer');
  setButtonLoading(btn, true, i18next.t('customers.saving') || 'Saving...');
  
  try {
      const name = document.getElementById('newCustomerName').value.trim();
      if (!name) { 
          alert(i18next.t('customers.nameRequired') || 'Name is required'); 
          setButtonLoading(btn, false); 
          return; 
      }
      
      const email = document.getElementById('newCustomerEmail').value.trim();
      if (email && !validateEmail(email)) {
          alert(i18next.t('customers.invalidEmail') || 'Invalid email format');
          setButtonLoading(btn, false);
          return;
      }
      
      const phone = document.getElementById('newCustomerPhone').value.trim();
      if (phone && !validatePhone(phone)) {
          alert(i18next.t('customers.invalidPhone') || 'Invalid phone format. Use international format (e.g., +1234567890)');
          setButtonLoading(btn, false);
          return;
      }
      
      const newC = {
          name: sanitizeInput(name),
          email: sanitizeInput(email),
          phone: sanitizeInput(phone),
          company: sanitizeInput(document.getElementById('newCustomerCompany').value.trim()),
          status: document.getElementById('newCustomerStatus').value,
          createdAt: new Date().toISOString()
      };
      
      customers.push(newC);
      closeModal('addCustomerModal');
      refreshUI();
      await saveAllChanges();
  } catch(e) {
      console.error(e);
  } finally {
      setButtonLoading(btn, false);
  }
}

async function importCustomers() {
    if (!await checkAuth()) return;
    document.getElementById('csvFileInput').click();
}

function handleFileSelect(event) {
    checkAuth().then(auth => {
        if (!auth) return;
        const file = event.target.files[0];
        if (!file) return;
        
        showGlobalLoader(true, i18next.t('customers.parsing') || 'Parsing CSV...');
        const reader = new FileReader();
        
        reader.onload = function(e) {
            setTimeout(() => processCSV(e.target.result), 100);
        };
        
        reader.readAsText(file);
        event.target.value = ''; 
    });
}

function processCSV(csvText) {
    const lines = csvText.split(/\r\n|\n/).filter(line => line.trim() !== '');
    
    if (lines.length < 2) {
        showGlobalLoader(false);
        alert(i18next.t('customers.csvError') || 'CSV file is too short or empty.');
        return;
    }
    
    function parseCSVRow(text) {
        const re_value = /(?!\s*$)\s*(?:'([^']*)'|"([^"]*)"|([^,;]*))\s*(?:[,;]|$)/g;
        const row = [];
        text.replace(re_value, (m, p1, p2, p3) => {
            if (p1 !== undefined) row.push(p1);
            else if (p2 !== undefined) row.push(p2);
            else if (p3 !== undefined) row.push(p3);
            return '';
        });
        return row;
    }
    
    const rawHeaders = parseCSVRow(lines[0]);
    const headers = rawHeaders.map(h => h.toLowerCase().trim());
    
    let emailIdx = headers.findIndex(h => h === 'email' || h.includes('primary email') || h.includes('email address'));
    let nameIdx = headers.findIndex(h => h === 'name' || h.includes('full name') || h.includes('first name'));
    let companyIdx = headers.findIndex(h => h.includes('company'));
    let phoneIdx = headers.findIndex(h => h.includes('phone') || h.includes('mobile'));
    
    if (emailIdx === -1 && lines.length > 0) {
        const firstDataRow = parseCSVRow(lines[1]);
        emailIdx = firstDataRow.findIndex(val => val && val.includes('@'));
    }
    
    if (emailIdx === -1) {
        showGlobalLoader(false);
        alert(i18next.t('customers.noEmailColumn') || 'Could not detect an Email column. Please check your CSV.');
        return;
    }
    
    let importedCount = 0;
    for (let i = 1; i < lines.length; i++) {
        const row = parseCSVRow(lines[i]);
        if (!row || row.length === 0) continue;
        
        const email = (row[emailIdx] || '').trim();
        if (email && email.includes('@')) {
            let name = 'Unknown';
            if (nameIdx > -1 && row[nameIdx]) name = sanitizeInput(row[nameIdx]);
            else if (headers.includes('first name')) {
                const fNameIdx = headers.indexOf('first name');
                const lNameIdx = headers.indexOf('last name');
                name = sanitizeInput(`${row[fNameIdx] || ''} ${row[lNameIdx] || ''}`.trim());
            } else name = email.split('@')[0].replace(/[._-]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            customers.push({
                name: name,
                email: sanitizeInput(email),
                phone: phoneIdx > -1 ? sanitizeInput(row[phoneIdx]) : '',
                company: companyIdx > -1 ? sanitizeInput(row[companyIdx]) : '',
                status: 'Active',
                createdAt: new Date().toISOString()
            });
            importedCount++;
        }
    }
    
    refreshUI();
    saveAllChanges().finally(() => {
        showGlobalLoader(false);
        showMessage(i18next.t('customers.importSuccess', { count: importedCount }) || `Successfully imported ${importedCount} customers!`, 'success');
    });
}

async function createNewTemplate() {
    if (!await checkAuth()) return;
    updateValue('templateIndex', '-1');
    document.getElementById('templateForm').reset();
    updateText('templateModalTitle', i18next.t('templates.addNew'));
    openModal('templateModal');
}

async function editTemplate(index) {
    if (!await checkAuth()) return;
    const t = templates[index];
    updateValue('templateIndex', index);
    updateValue('templateName', t.name);
    updateValue('templateTag', t.tag);
    updateValue('templateSubject', t.subject || t.name);
    updateValue('templateBody', t.body);
    updateText('templateModalTitle', i18next.t('templates.edit') || 'Edit Template');
    openModal('templateModal');
}

async function saveTemplate() {
    if (!await checkAuth()) return;
    const btn = document.getElementById('btnSaveTemplate');
    setButtonLoading(btn, true);
    
    const index = parseInt(document.getElementById('templateIndex').value);
    const newT = {
        name: sanitizeInput(document.getElementById('templateName').value),
        tag: sanitizeInput(document.getElementById('templateTag').value),
        subject: sanitizeInput(document.getElementById('templateSubject').value),
        body: document.getElementById('templateBody').value // Don't sanitize email body as it may contain HTML
    };
    
    if (index === -1) templates.push(newT);
    else templates[index] = newT;
    
    closeModal('templateModal');
    renderTemplates();
    renderTemplateSelector();
    await saveAllChanges();
    setButtonLoading(btn, false);
}

async function deleteTemplate(index) {
    if (!await checkAuth()) return;
    if(!confirm(i18next.t('templates.confirmDelete') || 'Delete template?')) return;
    templates.splice(index, 1);
    renderTemplates();
    renderTemplateSelector();
    await saveAllChanges();
}

function useTemplate(index) {
    checkAuth().then(auth => {
        if (!auth) return;
        loadTemplate(index);
        showSection('automation');
    });
}

function loadTemplate(identifier) {
    document.querySelectorAll('.template-btn').forEach(b => b.classList.remove('active'));
    if(event && event.target) event.target.classList.add('active');
    
    if(identifier === 'custom') {
        updateValue('emailSubject', '');
        updateValue('emailBody', '');
    } else {
        const t = templates[identifier];
        if(t) {
            updateValue('emailSubject', t.subject || t.name);
            updateValue('emailBody', t.body);
        }
    }
}

async function previewMessage() {
    if (!await checkAuth()) return;
    const subject = document.getElementById('emailSubject').value;
    const body = document.getElementById('emailBody').value;
    updateText('previewSubject', subject);
    updateText('previewBody', body);
    openModal('previewModal');
}

async function saveAllChanges() {
    if (!await checkAuth()) return;
    const btn = document.getElementById('btnSaveChanges');
    if(btn) setButtonLoading(btn, true, i18next.t('customers.saving') || 'Saving...');
    
    try {
        const payload = {
            customers: customers,
            templates: templates,
            sent_emails: sentEmails
        };
        
        const res = await secureFetch(`${API_BASE_URL}/updatecustomers`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        
        if (!res.ok) throw new Error('Save failed');
        
        showMessage(i18next.t('customers.saved') || 'Data saved to cloud', 'success');
    } catch(e) {
        console.error(e);
        showMessage(i18next.t('customers.saveError') || 'Error saving data', 'error');
    } finally {
        if(btn) setButtonLoading(btn, false);
    }
}

// ============================================
// UTILITIES
// ============================================

function refreshUI() {
    updateDashboardStats();
    renderCustomerTable();
    renderEmailList();
}

async function refreshData() {
    if (!await checkAuth()) return;
    const btn = document.getElementById('btnRefresh');
    setButtonLoading(btn, true, i18next.t('buttons.refreshing') || 'Refreshing...');
    loadUserData().finally(() => setButtonLoading(btn, false));
}

function showMessage(text, type) {
    const msg = document.createElement('div');
    msg.textContent = text;
    msg.style.cssText = `position:fixed; top:20px; right:20px; padding:12px 20px; background:${type==='error'?'#991b1b':'#000'}; color:#fff; border-radius:4px; z-index:3000; animation: fadeIn 0.3s;`;
    document.body.appendChild(msg);
    setTimeout(() => msg.remove(), 3000);
}

function setButtonLoading(btn, isLoading, text='Loading...') {
    if(!btn) return;
    if(isLoading) {
        btn.dataset.og = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `<span class="btn-spinner"></span> ${text}`;
    } else {
        btn.innerHTML = btn.dataset.og || btn.innerHTML;
        btn.disabled = false;
    }
}

function showGlobalLoader(show, text='Loading...') {
    const el = document.getElementById('globalLoader');
    if(el) {
        el.style.display = show ? 'flex' : 'none';
        const txt = document.getElementById('loaderText');
        if(txt) txt.textContent = text;
    }
}

function updateText(id, text) {
    const el = document.getElementById(id);
    if(el) el.textContent = text;
}

function updateValue(id, val) {
    const el = document.getElementById(id);
    if(el) el.value = val;
}

function escapeHtml(text) {
  if (!text) return "";
  return String(text)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function getInitials(name) {
    return (name || 'U').split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
}

async function showSection(id) {
    if (!await checkAuth()) return;
    
    document.querySelectorAll('.section-content').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    
    const sec = document.getElementById(id + 'Section');
    if(sec) sec.style.display = 'block';
    
    const nav = document.querySelector(`a[href="#${id}"]`);
    if(nav) nav.classList.add('active');
    
    const titles = {
        'dashboard': i18next.t('titles.dashboard'),
        'customers': i18next.t('titles.customers'),
        'inbox': i18next.t('titles.inbox'),
        'automation': i18next.t('titles.automation'),
        'whatsapp': i18next.t('titles.whatsapp'),
        'sent': i18next.t('titles.sent'),
        'analytics': i18next.t('titles.analytics'),
        'templates': i18next.t('titles.templates'),
        'settings': i18next.t('titles.settings')
    };
    updateText('pageTitle', titles[id] || i18next.t('titles.dashboard'));
    
    if (id === 'whatsapp') {
        checkWhatsAppStatus();
    }
    if (id === 'inbox' && isGoogleConnected) {
        loadInboxMessages();
    }
    if (id === 'sent') {
        renderSentEmails();
    }
}

function openModal(id) { 
    document.getElementById(id).style.display = 'flex'; 
}

function closeModal(id) { 
    document.getElementById(id).style.display = 'none'; 
}

async function clearForm() { 
    if(confirm(i18next.t('automation.confirmReset') || 'Reset form?')) 
        document.getElementById('messageForm').reset(); 
}

async function confirmLogout() { 
    if(confirm(i18next.t('auth.confirmLogout') || 'Log out?')) { 
        await logout();
    } 
}

function renderAnalytics() {
    const container = document.getElementById('analyticsChart');
    if(!container) return;
    
    const data = [10, 40, 25, 50, 30, 60, 70];
    const max = Math.max(...data);
    
    container.innerHTML = data.map((d,i) => `
        <div class="chart-bar-group">
            <div class="chart-value">${d}</div>
            <div class="chart-bar" style="height:${(d/max)*100}%"></div>
            <div class="chart-label">${i18next.t('analytics.day') || 'Day'} ${i+1}</div>
        </div>
    `).join('');
}

function toggleMobileMenu() {
    const sidebar = document.getElementById('mainSidebar');
    const overlay = document.getElementById('mobileOverlay');
    
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
    
    if (sidebar.classList.contains('active')) {
        document.body.style.overflow = 'hidden';
    } else {
        document.body.style.overflow = '';
    }
}

function closeMobileMenu() {
    const sidebar = document.getElementById('mainSidebar');
    const overlay = document.getElementById('mobileOverlay');
    
    sidebar.classList.remove('active');
    overlay.classList.remove('active');
    document.body.style.overflow = '';
}

document.addEventListener('keydown', function(event) {
    if (event.key === "Escape") {
        closeMobileMenu();
        closeModal('loginRequiredModal');
        closeModal('addCustomerModal');
        closeModal('templateModal');
        closeModal('previewModal');
        document.getElementById('userDropdown')?.classList.remove('show');
        document.getElementById('languageDropdown')?.classList.remove('show');
    }
});

function exportCustomers() {
    checkAuth().then(auth => {
        if (!auth) return;
        
        const headers = ['Name', 'Email', 'Phone', 'Company', 'Status'];
        const csvRows = [];
        
        csvRows.push(headers.join(','));
        
        customers.forEach(c => {
            const values = [
                `"${c.name}"`,
                `"${c.email}"`,
                `"${c.phone || ''}"`,
                `"${c.company || ''}"`,
                c.status
            ];
            csvRows.push(values.join(','));
        });
        
        const csvContent = csvRows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'customers.csv';
        a.click();
        window.URL.revokeObjectURL(url);
        
        showMessage(i18next.t('customers.exported') || 'Customers exported successfully!', 'success');
    });
}

function saveSettings(btn) {
    checkAuth().then(auth => {
        if (!auth) return;
        showMessage(i18next.t('settings.saved') || 'Settings saved successfully!', 'success');
    });
}

// Add CSRF token to all forms
document.addEventListener('submit', function(e) {
    const form = e.target;
    if (form.method === 'post' || form.method === 'POST') {
        let csrfInput = form.querySelector('input[name="_csrf"]');
        if (!csrfInput && csrfToken) {
            csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = '_csrf';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
        }
    }
});

document.addEventListener('input', function(e) {
    if (e.target.type === 'email') {
        const email = e.target.value;
        if (email && !validateEmail(email)) {
            e.target.setCustomValidity('Invalid email format');
        } else {
            e.target.setCustomValidity('');
        }
    } else if (e.target.type === 'tel') {
        const phone = e.target.value;
        if (phone && !validatePhone(phone)) {
            e.target.setCustomValidity('Use international format (e.g., +1234567890)');
        } else {
            e.target.setCustomValidity('');
        }
    }
});

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('languageDropdown');
    const btn = document.querySelector('.language-btn');
    if (btn && dropdown && !btn.contains(event.target) && !dropdown.contains(event.target)) {
        dropdown.classList.remove('show');
    }
    
    const userDropdown = document.getElementById('userDropdown');
    const profile = document.querySelector('.profile-area');
    if (userDropdown && profile && !profile.contains(event.target) && !userDropdown.contains(event.target)) {
        userDropdown.classList.remove('show');
    }
    
    const search = document.querySelector('.search-container');
    const results = document.getElementById('searchResults');
    if (search && results && !search.contains(event.target)) {
        results.classList.remove('show');
    }
});

</script>
</body>
</html>
