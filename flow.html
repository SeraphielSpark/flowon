<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Flux On Customer Manager</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    /* Modern Palette */
    --bg-body: #ffffff;
    --bg-surface: #ffffff;
    --bg-subtle: #f7f7f7;
    --bg-hover: #f3f4f6;
    
    --text-main: #111111;
    --text-secondary: #5f6368;
    --text-tertiary: #888888;
    
    --border-light: #e0e0e0;
    --border-strong: #000000;
    
    --color-green-bg: #dcfce7;
    --color-green-text: #166534;
    --color-yellow-bg: #fef9c3;
    --color-yellow-text: #854d0e;
    --color-red-bg: #fee2e2;
    --color-red-text: #991b1b;
    --color-blue-bg: #dbeafe;
    --color-blue-text: #1e40af;
    --accent-blue: #2563eb;

    --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    --font-mono: 'Space Mono', monospace;
    
    --sidebar-width: 260px;
    --header-height: 70px;
    --radius-sm: 4px;
    --radius-md: 6px;
    --radius-lg: 12px;
  }

  * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

  body {
    margin: 0;
    padding: 0;
    font-family: var(--font-sans);
    background-color: var(--bg-body);
    color: var(--text-main);
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  /* --- Layout --- */
  .app-container {
    display: flex;
    min-height: 100vh;
    width: 100%;
  }

  /* --- Sidebar (Desktop) --- */
  .sidebar {
    width: var(--sidebar-width);
    background: var(--bg-surface);
    border-right: 1px solid var(--border-light);
    display: flex;
    flex-direction: column;
    position: fixed;
    height: 100vh;
    z-index: 50;
    padding: 24px 16px;
    transition: all 0.3s ease;
  }

  .logo-area {
    margin-bottom: 40px;
    padding: 0 12px;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 800;
    font-size: 20px;
    letter-spacing: -0.5px;
    color: var(--text-main);
  }

  .logo-icon {
    width: 32px;
    height: 32px;
    background: #000;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
    font-family: var(--font-mono);
  }

  .nav-menu {
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex: 1;
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    color: var(--text-secondary);
    text-decoration: none;
    border-radius: var(--radius-md);
    font-weight: 500;
    font-size: 14px;
    transition: all 0.15s ease;
    cursor: pointer;
  }

  .nav-item:hover {
    background-color: var(--bg-subtle);
    color: var(--text-main);
  }

  .nav-item.active {
    background-color: var(--bg-subtle);
    color: var(--text-main);
    font-weight: 600;
  }
  
  .nav-item.active .nav-icon { color: var(--text-main); }
  .nav-icon { font-size: 16px; color: var(--text-tertiary); width: 20px; text-align: center; }

  /* LEGAL SIDEBAR SECTION */
  .sidebar-legal {
    margin-top: auto;
    padding-top: 12px;
    border-top: 1px solid var(--border-light);
    margin-bottom: 10px;
  }
  .legal-link {
    display: block;
    font-size: 12px;
    color: var(--text-tertiary);
    text-decoration: none;
    padding: 6px 12px;
    transition: color 0.2s;
  }
  .legal-link:hover { color: var(--text-main); text-decoration: underline; }
  
  /* Sidebar Google Status */
  .sidebar-status-indicator {
      font-size: 12px;
      padding: 0 12px;
      margin-bottom: 8px;
      color: var(--text-tertiary);
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
  }

  /* --- Main Content --- */
  .main-content {
    flex: 1;
    margin-left: var(--sidebar-width);
    display: flex;
    flex-direction: column;
    background: var(--bg-body);
    min-height: 100vh;
  }

  /* --- Header --- */
  .top-header {
    height: var(--header-height);
    border-bottom: 1px solid var(--border-light);
    background: rgba(255,255,255,0.9);
    backdrop-filter: blur(5px);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 40px;
    position: sticky;
    top: 0;
    z-index: 40;
  }

  .header-title span { font-size: 18px; font-weight: 700; letter-spacing: -0.5px; }

  .header-actions { display: flex; align-items: center; gap: 20px; }

  /* LEGAL HEADER PILLS */
  .legal-header-pills {
    display: flex;
    gap: 8px;
    margin-right: 12px;
  }
  .legal-pill {
    font-size: 11px;
    font-weight: 600;
    text-decoration: none;
    color: var(--text-secondary);
    background: var(--bg-subtle);
    padding: 6px 12px;
    border-radius: 20px;
    transition: all 0.2s;
    border: 1px solid transparent;
  }
  .legal-pill:hover {
    background: #fff;
    border-color: var(--border-light);
    color: var(--text-main);
  }
  
  .status-pill-connected {
      background: var(--color-green-bg) !important;
      color: var(--color-green-text) !important;
      border-color: var(--color-green-text) !important;
      cursor: default !important;
  }

  /* --- Notification Bell --- */
  .notification-btn {
    position: relative; cursor: pointer; padding: 8px; border-radius: 50%;
    color: var(--text-secondary); transition: background 0.2s; display: flex; align-items: center; justify-content: center;
  }
  .notification-btn:hover { background: var(--bg-subtle); color: var(--text-main); }
  .notification-icon { width: 20px; height: 20px; stroke-width: 2px; }
  .notification-badge {
    position: absolute; top: 4px; right: 4px;
    background: var(--color-red-text); color: white;
    font-size: 10px; font-weight: 700;
    min-width: 16px; height: 16px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    border: 2px solid #fff; box-sizing: content-box;
    transform: scale(0); transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  .notification-badge.show { transform: scale(1); }

  .profile-area {
    display: flex; align-items: center; gap: 10px; cursor: pointer;
    padding: 4px 8px; border-radius: var(--radius-md); transition: background 0.2s;
  }
  .profile-area:hover { background: var(--bg-subtle); }

  .profile-avatar {
    width: 32px; height: 32px; background: var(--bg-subtle);
    border: 1px solid var(--border-light); border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 700;
  }

  .profile-info { text-align: left; }
  .profile-name { font-size: 13px; font-weight: 600; line-height: 1.2; }

  /* --- Page Structure --- */
  .page-content { padding: 40px; max-width: 1200px; margin: 0 auto; width: 100%; flex: 1; }
  .section-content { animation: fadeIn 0.3s ease-out; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* --- Cards --- */
  .welcome-card { margin-bottom: 40px; }
  .welcome-card h1 { font-size: 32px; font-weight: 800; letter-spacing: -1px; margin-bottom: 12px; color: var(--text-main); }
  .welcome-card p { color: var(--text-secondary); font-size: 16px; max-width: 600px; margin-bottom: 24px; }

  /* --- Dashboard Grid --- */
  .dashboard-cards {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 24px; margin-bottom: 40px;
  }

  .dashboard-card {
    background: #fff; border: 1px solid var(--border-light); padding: 24px;
    border-radius: var(--radius-md); transition: border-color 0.2s, transform 0.2s;
  }
  .dashboard-card:hover { border-color: var(--border-strong); transform: translateY(-2px); }

  .card-header { display: flex; justify-content: space-between; margin-bottom: 16px; }
  .card-title { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); }
  .card-count { font-size: 36px; font-weight: 800; line-height: 1; margin-bottom: 8px; letter-spacing: -1px; }
  .card-desc { font-size: 13px; color: var(--text-tertiary); }
  
  /* Legal Card Specific */
  .legal-card-content { display: flex; flex-direction: column; gap: 8px; }
  .legal-card-link { font-size: 13px; color: var(--accent-blue); text-decoration: none; font-weight: 500; }
  .legal-card-link:hover { text-decoration: underline; }

  /* --- Buttons --- */
  .btn {
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    padding: 0 20px; height: 48px; border-radius: 4px; font-weight: 600; font-size: 15px;
    cursor: pointer; transition: all 0.15s ease; border: 1px solid transparent; white-space: nowrap;
    position: relative;
  }

  .btn-primary { background: #000; color: #fff; border-color: #000; }
  .btn-primary:hover { background: #333; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
  
  .btn-secondary { background: #fff; color: #000; border: 1px solid #ddd; }
  .btn-secondary:hover { border-color: #000; background: #fcfcfc; }
  
  .btn-success { background: #fff; color: var(--text-main); border: 1px solid #ddd; }
  .btn-success:hover { border-color: #000; background: var(--bg-subtle); }
  
  .btn-danger-outline { background: #fff; color: var(--color-red-text); border: 1px solid var(--color-red-bg); }
  .btn-danger-outline:hover { background: var(--color-red-bg); border-color: var(--color-red-text); }
  
  .btn-icon-only { width: 36px; height: 36px; padding: 0; font-size: 16px; color: var(--text-secondary); border: none; background: transparent; }
  .btn-icon-only:hover { color: var(--color-red-text); background: var(--bg-subtle); border-radius: 4px; }

  .action-buttons { display: flex; gap: 12px; flex-wrap: wrap; }

  /* --- Tables & Lists --- */
  .automation-card { border: 1px solid var(--border-light); border-radius: var(--radius-md); background: #fff; overflow: hidden; }
  .automation-header { padding: 24px; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center; background: #fff; }
  .automation-content { padding: 24px; }

  .simple-table { width: 100%; border-collapse: collapse; font-size: 14px; }
  .simple-table th { text-align: left; padding: 12px 16px; font-weight: 600; color: var(--text-secondary); border-bottom: 2px solid var(--border-light); font-size: 12px; text-transform: uppercase; }
  .simple-table td { padding: 12px 16px; border-bottom: 1px solid var(--border-light); vertical-align: middle; }
  .table-input { width: 100%; border: 1px solid transparent; background: transparent; padding: 6px; border-radius: 4px; font-family: inherit; font-size: 14px; }
  .table-input:hover { border-color: #ddd; background: #fff; }
  .table-input:focus { border-color: #000; background: #fff; }

  /* --- Forms --- */
  .message-form { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
  .form-group { margin-bottom: 20px; }
  .form-group.full-width { grid-column: 1 / -1; }
  .form-label { display: block; margin-bottom: 8px; font-size: 13px; font-weight: 700; color: var(--text-main); }
  .form-control { width: 100%; padding: 12px 16px; font-size: 15px; border: 1px solid var(--border-light); border-radius: var(--radius-sm); background: #fff; color: var(--text-main); font-family: var(--font-sans); }
  .form-control:focus { border-color: #000; box-shadow: 0 0 0 1px #000; }

  /* --- Email List --- */
  .email-list-section { border: 1px solid var(--border-light); border-radius: var(--radius-md); background: #fff; }
  .select-all { padding: 16px 20px; border-bottom: 1px solid var(--border-light); background: var(--bg-subtle); display: flex; align-items: center; gap: 12px; }
  .email-list { max-height: 400px; overflow-y: auto; }
  .email-item { display: flex; align-items: center; gap: 16px; padding: 12px 20px; border-bottom: 1px solid var(--border-light); }
  .email-checkbox { width: 18px; height: 18px; accent-color: #000; cursor: pointer; }
  .email-info { flex: 1; }
  .email-address { font-weight: 500; font-size: 14px; word-break: break-all; }
  .email-customer { font-size: 12px; color: var(--text-secondary); }

  /* Status Badges */
  .email-status { font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 12px; text-transform: uppercase; }
  .status-active, [value="Active"] { background: var(--color-green-bg); color: var(--color-green-text); }
  .status-inactive, [value="Inactive"] { background: var(--color-red-bg); color: var(--color-red-text); }
  .status-pending, [value="Pending"] { background: var(--color-yellow-bg); color: var(--color-yellow-text); }

  /* --- Templates Section Styles --- */
  .template-selector { display: flex; gap: 10px; margin-bottom: 24px; flex-wrap: wrap; }
  .template-btn { padding: 8px 16px; background: #fff; border: 1px solid var(--border-light); border-radius: 20px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
  .template-btn:hover { border-color: #999; }
  .template-btn.active { background: #000; color: #fff; border-color: #000; }

  .templates-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px; }
  .template-card { border: 1px solid var(--border-light); border-radius: var(--radius-md); overflow: hidden; background: #fff; transition: transform 0.2s, box-shadow 0.2s; display: flex; flex-direction: column; }
  .template-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: var(--border-strong); }
  .template-card-header { padding: 16px; background: var(--bg-subtle); border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center; }
  .template-name { font-weight: 700; font-size: 15px; }
  .template-tag { font-size: 11px; padding: 2px 8px; border-radius: 10px; background: #e5e7eb; color: #374151; font-weight: 600; }
  .template-body { padding: 16px; flex: 1; font-size: 14px; color: var(--text-secondary); display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
  .template-footer { padding: 16px; border-top: 1px solid var(--border-light); display: flex; gap: 8px; }

  /* --- Analytics Charts Styles --- */
  .chart-container { margin-top: 24px; height: 200px; display: flex; align-items: flex-end; gap: 12px; padding-bottom: 24px; border-bottom: 1px solid var(--border-light); }
  .chart-bar-group { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; height: 100%; justify-content: flex-end; }
  .chart-bar { width: 100%; background: #000; border-radius: 4px 4px 0 0; min-height: 4px; transition: height 0.5s ease-out; position: relative; }
  .chart-bar:hover { background: var(--primary-color); opacity: 0.8; }
  .chart-label { font-size: 12px; color: var(--text-tertiary); }
  .chart-value { font-size: 12px; font-weight: 700; margin-bottom: 4px; }
  .analytics-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px; margin-bottom: 32px; }
  .metric-box { padding: 20px; background: var(--bg-subtle); border-radius: var(--radius-md); }
  .metric-label { font-size: 13px; color: var(--text-secondary); margin-bottom: 4px; }
  .metric-value { font-size: 24px; font-weight: 800; color: var(--text-main); }
  .metric-trend { font-size: 12px; font-weight: 600; margin-top: 8px; display: flex; align-items: center; gap: 4px; }
  .trend-up { color: var(--color-green-text); }
  .trend-down { color: var(--color-red-text); }

  /* --- Google Integration Card CSS --- */
  .google-connect-card {
      background: #fff;
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.02);
      transition: border-color 0.2s;
  }
  .google-connect-card:hover { border-color: var(--border-strong); }
  .google-info h3 { margin: 0 0 6px 0; font-size: 16px; font-weight: 700; color: var(--text-main); }
  .google-info p { margin: 0; font-size: 13px; color: var(--text-secondary); max-width: 400px; }
  
  .connection-status {
      margin-top: 12px; font-size: 12px; font-weight: 600; display: inline-flex;
      align-items: center; gap: 8px; padding: 6px 12px; border-radius: 20px;
  }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: currentColor; }
  
  /* Status Variations */
  .status-disconnected { background: var(--color-red-bg); color: var(--color-red-text); }
  .status-connected { background: var(--color-green-bg); color: var(--color-green-text); }


  /* --- INBOX STYLES (ELITE STRUCTURE) --- */
  .inbox-layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      height: calc(100vh - 180px); /* Adjust based on header/padding */
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      background: #fff;
      overflow: hidden;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
  }
  
  /* Inbox List (Left) */
  .inbox-list {
      border-right: 1px solid var(--border-light);
      overflow-y: auto;
      background: #fff;
      display: flex;
      flex-direction: column;
  }
  .inbox-item {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-light);
      cursor: pointer;
      transition: background 0.1s;
      position: relative;
  }
  .inbox-item:hover { background: var(--bg-hover); }
  .inbox-item.selected { background: var(--bg-subtle); border-left: 3px solid #000; padding-left: 17px; }
  
  /* Read vs Unread Styling */
  .inbox-item.unread .inbox-sender, .inbox-item.unread .inbox-subject { font-weight: 700; color: #000; }
  .inbox-item.unread::after { content: ''; position: absolute; top: 20px; right: 20px; width: 8px; height: 8px; background: var(--accent-blue); border-radius: 50%; }

  .inbox-item-header { display: flex; justify-content: space-between; margin-bottom: 6px; align-items: baseline; }
  .inbox-sender { font-size: 14px; color: var(--text-main); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
  .inbox-date { font-size: 11px; color: var(--text-tertiary); font-feature-settings: "tnum"; }
  
  .inbox-subject { font-size: 13px; color: var(--text-secondary); margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .inbox-snippet { font-size: 12px; color: var(--text-tertiary); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4; }

  /* Inbox View (Right) */
  .inbox-view {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: #fff;
      height: 100%;
  }
  .inbox-empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-tertiary);
      gap: 16px;
  }
  .empty-icon { font-size: 48px; opacity: 0.5; }

  /* Toolbar */
  .inbox-toolbar { padding: 12px 24px; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center; background: #fff; }
  
  .inbox-view-content { overflow-y: auto; flex: 1; }
  .inbox-view-header {
      padding: 32px 32px 24px 32px;
      border-bottom: 1px solid var(--bg-subtle);
  }
  .view-subject { font-size: 24px; font-weight: 700; margin-bottom: 20px; line-height: 1.2; letter-spacing: -0.5px; }
  .view-meta { display: flex; align-items: flex-start; gap: 16px; }
  .view-avatar { width: 48px; height: 48px; background: linear-gradient(135deg, #e0e0e0, #f5f5f5); color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px; border: 1px solid var(--border-light); }
  .view-info { flex: 1; }
  .view-sender-name { font-weight: 600; font-size: 15px; color: var(--text-main); }
  .view-sender-email { font-size: 13px; color: var(--text-tertiary); margin-top: 2px; }
  .view-timestamp { font-size: 12px; color: var(--text-tertiary); background: var(--bg-subtle); padding: 4px 8px; border-radius: 4px; }
  
  .inbox-view-body { padding: 32px; line-height: 1.7; font-size: 15px; color: var(--text-main); max-width: 800px; }
  .inbox-view-body img { max-width: 100%; height: auto; border-radius: 4px; }
  .inbox-view-body a { color: var(--accent-blue); text-decoration: none; }
  .inbox-view-body a:hover { text-decoration: underline; }

  /* --- Settings Styles --- */
  .settings-container { max-width: 800px; }
  .settings-group { margin-bottom: 32px; padding-bottom: 32px; border-bottom: 1px solid var(--border-light); }
  .settings-group:last-child { border-bottom: none; }
  .settings-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; }
  .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; }
  .toggle-label { font-weight: 500; font-size: 15px; }
  .toggle-desc { font-size: 13px; color: var(--text-tertiary); }
  
  /* Toggle Switch */
  .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
  .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: #000; }
  input:checked + .slider:before { transform: translateX(20px); }

  /* --- Modal --- */
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center; }
  .modal-content { background: #fff; width: 90%; max-width: 550px; padding: 40px; border: 1px solid var(--border-light); border-radius: var(--radius-lg); box-shadow: 0 20px 40px rgba(0,0,0,0.1); animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); max-height: 90vh; overflow-y: auto; }
  @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

  /* --- LOADING ANIMATIONS --- */
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  
  /* Button Spinner */
  .btn-spinner {
    width: 16px; height: 16px;
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 0.8s linear infinite;
    display: inline-block;
    margin-right: 8px;
    vertical-align: middle;
  }
  
  .btn-secondary .btn-spinner, .btn-success .btn-spinner {
      border-color: rgba(0,0,0,0.1);
      border-top-color: #000;
  }
  
  /* Global Loader Overlay */
  .loader-overlay {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(5px);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
  }
  
  .loader-spinner {
      width: 50px; height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #000;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
  }
  
  .loader-text {
      font-weight: 600;
      color: var(--text-main);
  }

  /* --- MOBILE RESPONSIVE STYLES --- */
  @media (max-width: 768px) {
    .app-container { flex-direction: column; }
    
    .sidebar { 
      width: 100%; 
      height: auto; 
      position: sticky; 
      top: 0;
      border-right: none; 
      border-bottom: 1px solid var(--border-light); 
      padding: 12px 16px; 
      flex-direction: row;
      align-items: center;
      gap: 16px;
      overflow: hidden;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .sidebar-legal { display: none; } 
    .legal-header-pills { display: none; } 

    .logo-area { margin-bottom: 0; padding: 0; flex-shrink: 0; }
    .logo span { display: none; }
    
    .nav-menu { 
      flex-direction: row; 
      overflow-x: auto; 
      padding-bottom: 0; 
      align-items: center;
      gap: 8px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .nav-menu::-webkit-scrollbar { display: none; }

    .nav-item { 
      white-space: nowrap; 
      padding: 6px 14px;
      font-size: 13px;
      background: var(--bg-subtle);
      border-radius: 20px;
      height: 32px;
    }
    
    .nav-item.active { background: #000; color: #fff; }
    .nav-item.active .nav-icon { color: #fff; }
    .nav-menu[style*="flex: 0"] { display: none; }

    .main-content { margin-left: 0; width: 100%; }
    .top-header { 
      padding: 0 16px; height: 60px; position: static; 
      background: transparent; border-bottom: none;
    }
    .page-content { padding: 16px; }

    .welcome-card h1 { font-size: 24px; }
    .welcome-card p { font-size: 14px; }
    .card-count { font-size: 28px; }

    .dashboard-cards { grid-template-columns: 1fr; gap: 16px; }
    .action-buttons { flex-direction: column; width: 100%; gap: 12px; }
    .btn { width: 100%; }
    .stats-grid { gap: 16px; justify-content: space-between; }
    
    .message-form { grid-template-columns: 1fr; gap: 16px; }
    
    .automation-header { flex-direction: column; align-items: flex-start; gap: 16px; }
    .automation-header h2 { margin-bottom: 8px; }
    .automation-header .action-buttons, .automation-header .btn { width: 100%; }
    
    .modal { align-items: flex-end; }
    .modal-content { 
      width: 100%; 
      border-radius: 12px 12px 0 0; 
      padding: 24px; 
      max-height: 85vh;
      animation: slideUpMobile 0.3s ease-out;
    }
    @keyframes slideUpMobile { from { transform: translateY(100%); } to { transform: translateY(0); } }
    
    .modal-content .form-actions { 
        display: flex; flex-direction: column-reverse; gap: 12px; margin-top: 24px; 
    }
    .modal-content .form-actions .btn { margin-left: 0 !important; }

    .templates-grid { grid-template-columns: 1fr; }
    
    /* Mobile Inbox Adjustment */
    .inbox-layout { grid-template-columns: 1fr; border: none; height: calc(100vh - 120px); box-shadow: none; }
    .inbox-list { border-right: none; height: 100%; }
    .inbox-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); display: flex; }
    .inbox-view.active { transform: translateX(0); }
    .mobile-back-btn { display: inline-flex !important; margin-right: 12px; }
    .inbox-toolbar { padding: 8px 16px; }
    
    .google-connect-card { flex-direction: column; align-items: flex-start; gap: 20px; }
    .google-connect-card .btn { width: 100%; justify-content: center; }
  }
</style>
</head>
<body>

<div class="loader-overlay" id="globalLoader">
    <div class="loader-spinner"></div>
    <div class="loader-text" id="loaderText">Processing...</div>
</div>

<div class="app-container">
  
  <aside class="sidebar" aria-label="Main navigation">
    <div class="logo-area">
      <div class="logo">
        <div class="logo-icon" aria-hidden="true">F</div>
        <span>Flux On</span>
      </div>
    </div>
    
    <nav class="nav-menu" aria-label="Primary navigation">
      <a href="#dashboard" class="nav-item active" onclick="showSection('dashboard')" aria-current="page">
        <span class="nav-icon">üìä</span>
        <span>Dashboard</span>
      </a>
      <a href="#customers" class="nav-item" onclick="showSection('customers')">
        <span class="nav-icon">üë•</span>
        <span>Customers</span>
      </a>
      <a href="#inbox" class="nav-item" onclick="showSection('inbox')">
        <span class="nav-icon">üì•</span>
        <span>Inbox</span>
      </a>
      <a href="#automation" class="nav-item" onclick="showSection('automation')">
        <span class="nav-icon">‚ö°</span>
        <span>Automation</span>
      </a>
      <a href="#analytics" class="nav-item" onclick="showSection('analytics')">
        <span class="nav-icon">üìà</span>
        <span>Analytics</span>
      </a>
      <a href="#templates" class="nav-item" onclick="showSection('templates')">
        <span class="nav-icon">üìù</span>
        <span>Templates</span>
      </a>
      <a href="#settings" class="nav-item" onclick="showSection('settings')">
        <span class="nav-icon">‚öôÔ∏è</span>
        <span>Settings</span>
      </a>
    </nav>
    
    <div id="sidebarGoogleStatus" class="sidebar-status-indicator">
        <div style="width: 8px; height: 8px; border-radius: 50%; background: #ccc;"></div>
        Gmail: Not Linked
    </div>

    <div class="sidebar-legal">
        <a href="https://seraphielspark.github.io/flowon/privacy.html" target="_blank" class="legal-link">Privacy Policy</a>
        <a href="https://seraphielspark.github.io/flowon/terms.html" target="_blank" class="legal-link">Terms of Service</a>
    </div>

    <div class="nav-menu" style="flex: 0; margin-top: 12px;">
      <a href="#" class="nav-item" onclick="confirmLogout()">
        <span class="nav-icon">‚Ü™</span>
        <span>Log Out</span>
      </a>
    </div>
  </aside>

  <main class="main-content">
    
    <header class="top-header" role="banner">
      <div class="header-title" id="pageTitle">
        <span>Dashboard</span>
      </div>
      
      <div class="header-actions">
        <div id="headerGoogleStatus" class="legal-pill status-pill-connected" style="display: none;">
            ‚úì Gmail Linked
        </div>

        <div class="legal-header-pills">
            <a href="https://seraphielspark.github.io/flowon/privacy.html" target="_blank" class="legal-pill">Privacy</a>
            <a href="https://seraphielspark.github.io/flowon/terms.html" target="_blank" class="legal-pill">Terms</a>
        </div>

        <div class="notification-btn" onclick="showSection('inbox')" title="Notifications">
            <svg class="notification-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
            <div class="notification-badge" id="notificationBadge">0</div>
        </div>

        <button class="btn btn-secondary" id="btnRefresh" style="height: 36px; padding: 0 12px; font-size: 13px;" onclick="refreshData()" aria-label="Refresh data">
            Refresh
        </button>
        <div class="profile-area" onclick="showSection('settings')" role="button" tabindex="0" aria-label="User profile">
          <div class="profile-avatar" id="userInitials" aria-hidden="true">U</div>
          <div class="profile-info">
            <div class="profile-name" id="profileName">User</div>
          </div>
        </div>
      </div>
    </header>
    
    <div class="page-content">
      
      <section id="dashboardSection" class="section-content" aria-labelledby="dashboardTitle">
        <div class="welcome-card">
          <h1 id="dashboardTitle">Hello, <span id="userGreeting">User</span>.</h1>
          <p>Here is your overview. Manage customers and automate flows.</p>
          <div class="action-buttons">
            <button class="btn btn-primary" onclick="showSection('automation')">
              Start Automation
            </button>
            <button class="btn btn-secondary" onclick="showSection('customers')">
              Manage Customers
            </button>
          </div>
        </div>
        
        <div class="dashboard-cards">
          <div class="dashboard-card">
            <div class="card-header">
              <div class="card-title">Total Customers</div>
              <div class="card-icon">üë•</div>
            </div>
            <div class="card-count" id="totalCustomers" aria-live="polite">0</div>
            <div class="card-desc">Active in database</div>
          </div>
          
          <div class="dashboard-card">
            <div class="card-header">
              <div class="card-title">Inbox</div>
              <div class="card-icon">üì•</div>
            </div>
            <div class="card-count" id="unreadStats" aria-live="polite">0</div>
            <div class="card-desc">Unread messages</div>
          </div>
          
          <div class="dashboard-card">
            <div class="card-header">
              <div class="card-title">Active Campaigns</div>
              <div class="card-icon">‚ö°</div>
            </div>
            <div class="card-count" id="activeCampaigns" aria-live="polite">0</div>
            <div class="card-desc">Workflows running</div>
          </div>
          
          <div class="dashboard-card">
            <div class="card-header">
              <div class="card-title">Response Rate</div>
              <div class="card-icon">üìà</div>
            </div>
            <div class="card-count" id="responseRate" aria-live="polite">0%</div>
            <div class="card-desc">Average engagement</div>
          </div>

          <div class="dashboard-card">
            <div class="card-header">
                <div class="card-title">Legal & Compliance</div>
                <div class="card-icon">üõ°Ô∏è</div>
            </div>
            <div class="legal-card-content">
                <div style="font-size:12px; color:var(--text-tertiary); margin-bottom:4px;">Account Status: Verified</div>
                <a href="https://seraphielspark.github.io/flowon/privacy.html" target="_blank" class="legal-card-link">View Privacy Policy ‚Üí</a>
                <a href="https://seraphielspark.github.io/flowon/terms.html" target="_blank" class="legal-card-link">View Terms of Service ‚Üí</a>
            </div>
          </div>
        </div>
        
        <div class="automation-card">
          <div class="automation-header">
            <h2>Quick Actions</h2>
          </div>
          <div class="automation-content">
            <div class="action-buttons">
              <button class="btn btn-secondary" onclick="showSection('automation')">
                üéâ Create Welcome Series
              </button>
              <button class="btn btn-secondary" onclick="showSection('automation')">
                üîÑ Send Follow-up
              </button>
            </div>
          </div>
        </div>
      </section>
      
      <section id="customersSection" class="section-content" aria-labelledby="customersTitle" style="display: none;">
        <div class="welcome-card">
          <div style="display: flex; flex-direction: column; gap: 16px;">
            <div>
              <h1 id="customersTitle">Customers</h1>
              <p>View and manage your subscriber database.</p>
            </div>
            <div class="action-buttons">
               <button class="btn btn-secondary" onclick="exportCustomers()">Export CSV</button>
               <button class="btn btn-secondary" onclick="importCustomers()">Import CSV</button>
               <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
               <button class="btn btn-primary" onclick="addNewCustomer()">+ Add Customer</button>
            </div>
          </div>
        </div>
        
        <div class="automation-card">
          <div class="automation-header">
            <span class="card-title" style="margin: 0; font-size: 14px;">All Records <span class="data-count" id="customerCount" style="color: var(--text-tertiary); margin-left: 8px;">(0)</span></span>
            <button class="btn btn-success" id="btnSaveChanges" style="height: 36px;" onclick="saveAllChanges()">
              Save Changes
            </button>
          </div>
          
          <div id="tableContainer" style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
            <div style="padding: 40px; text-align: center; color: var(--text-tertiary);">
              Loading data...
            </div>
          </div>
        </div>
      </section>

      <section id="inboxSection" class="section-content" aria-labelledby="inboxTitle" style="display: none;">
        <div class="welcome-card" style="margin-bottom: 24px;">
           <h1 id="inboxTitle">Inbox</h1>
           <p>Messages from your audience.</p>
        </div>
        
        <div class="inbox-layout">
           <div class="inbox-list" id="inboxList">
               <div style="padding: 32px; text-align: center; color: var(--text-tertiary);">Loading...</div>
           </div>

           <div class="inbox-view" id="inboxView">
               <div class="inbox-empty-state" id="inboxEmptyState">
                   <div class="empty-icon">üì®</div>
                   <div>Select a message to read</div>
               </div>
               
               <div id="inboxContent" style="display: none; height: 100%; flex-direction: column;">
                   <div class="inbox-toolbar">
                       <div style="display: flex; align-items: center;">
                           <button class="btn btn-secondary mobile-back-btn" style="display:none; height: 32px; padding: 0 10px;" onclick="closeMobileInbox()">‚Üê</button>
                           <span style="font-size: 13px; color: var(--text-tertiary);" id="viewMetaToolbar">Reading Message</span>
                       </div>
                       <div>
                           <button class="btn btn-icon-only" onclick="deleteCurrentMessage()" title="Delete Message">
                               <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                           </button>
                       </div>
                   </div>
                   
                   <div class="inbox-view-content">
                       <div class="inbox-view-header">
                           <div class="view-subject" id="viewSubject">Subject</div>
                           <div class="view-meta">
                               <div class="view-avatar" id="viewAvatar">U</div>
                               <div class="view-info">
                                   <div class="view-sender-name" id="viewSender">Sender Name</div>
                                   <div class="view-sender-email" id="viewEmail">sender@email.com</div>
                               </div>
                               <div class="view-timestamp" id="viewDate">Today</div>
                           </div>
                       </div>
                       <div class="inbox-view-body" id="viewBody">
                           </div>
                   </div>
               </div>
           </div>
        </div>
      </section>
      
      <section id="automationSection" class="section-content" aria-labelledby="automationTitle" style="display: none;">
        <div class="welcome-card">
           <h1>Automation Center</h1>
           <p>Compose and schedule email campaigns.</p>
        </div>
        
        <div class="automation-card">
          <div class="automation-header">
            <h2>New Campaign</h2>
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-value" id="selectedCount" aria-live="polite">0</div>
                <div class="stat-label">Recipients</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="totalEmails" aria-live="polite">0</div>
                <div class="stat-label">Total List</div>
              </div>
            </div>
          </div>
          
          <div class="automation-content">
            
            <div class="google-connect-card">
                <div class="google-info">
                    <h3>Connect Google Account</h3>
                    <p>Link your account to send automated emails directly via your Gmail.</p>
                    
                    <div id="connectionStatus" class="connection-status status-disconnected">
                        <span class="status-dot"></span>
                        <span>Disconnected</span>
                    </div>
                </div>
                
                <button id="btnConnectGoogle" class="btn btn-secondary" onclick="connectGoogle()">
                    <svg style="width:18px; height:18px;" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M21.35,11.1H12.18V13.83H17.45C17.19,15.3 16.34,16.58 15.19,17.38V19.51H18.38C20.25,17.79 21.33,15.24 21.33,12.28C21.33,11.9 21.27,11.5 21.18,11.13V11.1M12.18,21.36C14.75,21.36 16.91,20.5 18.38,19.14L15.19,17.01C14.33,17.58 13.25,17.9 12.18,17.9C9.7,17.9 7.6,16.22 6.84,13.93H3.55V16.48C5.07,19.5 8.35,21.36 12.18,21.36M6.84,13.93C6.64,13.36 6.54,12.75 6.54,12.14C6.54,11.53 6.64,10.92 6.84,10.34V7.8H3.55C2.26,10.37 2.26,13.9 3.55,16.48H6.84M12.18,6.38C13.56,6.38 14.81,6.86 15.79,7.79L18.42,5.16C16.91,3.75 14.75,2.92 12.18,2.92C8.35,2.92 5.07,4.78 3.55,7.8L6.84,10.34C7.6,8.05 9.7,6.38 12.18,6.38Z" />
                    </svg>
                    Connect Gmail
                </button>
            </div>

            <div class="email-list-section">
              <div class="select-all">
                <input type="checkbox" id="selectAllEmails" class="select-all-checkbox" onchange="toggleAllEmails()" aria-label="Select all customers">
                <label for="selectAllEmails" style="font-size: 14px; font-weight: 600;">Select All Customers</label>
              </div>
              
              <div class="email-list" id="emailList">
                <div style="padding: 24px; text-align: center;">Loading...</div>
              </div>
            </div>
            
            <div style="margin-top: 40px;">
              <h3 style="font-size: 18px; margin-bottom: 16px;">Compose Message</h3>
              
              <div class="template-selector" id="automationTemplateSelector">
                <button class="template-btn" onclick="loadTemplate('custom')">Blank</button>
              </div>
              
              <form id="messageForm" class="message-form" aria-label="Message composition form">
                <div class="form-group">
                  <label class="form-label required" for="campaignName">Campaign Name</label>
                  <input type="text" class="form-control" id="campaignName" required placeholder="e.g. Q1 Newsletter">
                </div>
                
                <div class="form-group">
                  <label class="form-label" for="scheduleType">Schedule</label>
                  <select class="form-control" id="scheduleType">
                    <option value="now">Send Immediately</option>
                    <option value="scheduled">Schedule for later</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label class="form-label required" for="fromName">From Name</label>
                  <input type="text" class="form-control" id="fromName" required placeholder="Your Name">
                </div>
                
                <div class="form-group">
                  <label class="form-label required" for="fromEmail">From Email</label>
                  <input type="email" class="form-control" id="fromEmail" required placeholder="you@company.com">
                </div>

                <div class="form-group" style="display: none;">
                   <label class="form-label" for="replyToEmail">Reply To</label>
                   <input type="email" class="form-control" id="replyToEmail">
                </div>
                
                <div class="form-group full-width">
                  <label class="form-label required" for="emailSubject">Subject Line</label>
                  <input type="text" class="form-control" id="emailSubject" required placeholder="Enter a catchy subject">
                </div>
                
                <div class="form-group full-width">
                  <label class="form-label required" for="emailBody">Email Body</label>
                  <textarea class="form-control" id="emailBody" required placeholder="Write your message..." style="min-height: 200px;"></textarea>
                  <div style="margin-top: 8px; font-size: 12px; color: var(--text-tertiary); font-family: var(--font-mono);">
                    Variables: {name}, {email}, {company}
                  </div>
                </div>
                
                <div class="form-group" id="scheduleDateGroup" style="display: none;">
                  <label class="form-label" for="scheduleDateTime">Date & Time</label>
                  <input type="datetime-local" class="form-control" id="scheduleDateTime">
                </div>
                
                <div class="form-group full-width form-actions" style="display: flex; justify-content: flex-end; gap: 12px; border-top: 1px solid var(--border-light); padding-top: 24px; margin-top: 10px;">
                  <button type="button" class="btn btn-secondary" onclick="clearForm()">Reset</button>
                  <button type="submit" class="btn btn-primary">Preview & Send</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </section>
      
      <section id="analyticsSection" class="section-content" aria-labelledby="analyticsTitle" style="display: none;">
        <div class="welcome-card">
          <h1 id="analyticsTitle">Analytics</h1>
          <p>Campaign performance and engagement metrics.</p>
        </div>
        
        <div class="analytics-summary">
            <div class="metric-box">
                <div class="metric-label">Avg. Open Rate</div>
                <div class="metric-value">42.5%</div>
                <div class="metric-trend trend-up">‚Üë 5% vs last week</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">Click Rate</div>
                <div class="metric-value">18.2%</div>
                <div class="metric-trend trend-up">‚Üë 2% vs last week</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">Bounce Rate</div>
                <div class="metric-value">0.8%</div>
                <div class="metric-trend trend-down">‚Üì 0.2% vs last week</div>
            </div>
        </div>

        <div class="automation-card">
            <div class="automation-header">
                <h2>Email Performance (Last 7 Days)</h2>
            </div>
            <div class="automation-content">
                <div class="chart-container" id="analyticsChart">
                    </div>
            </div>
        </div>
      </section>
      
      <section id="templatesSection" class="section-content" aria-labelledby="templatesTitle" style="display: none;">
        <div class="welcome-card">
          <div style="display: flex; flex-direction: column; gap: 16px;">
            <div>
                <h1 id="templatesTitle">Templates</h1>
                <p>Manage your saved message layouts and quick responses.</p>
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="createNewTemplate()">+ New Template</button>
             </div>
          </div>
        </div>
        
        <div class="templates-grid" id="templatesGrid">
            </div>
      </section>
      
      <section id="settingsSection" class="section-content" aria-labelledby="settingsTitle" style="display: none;">
        <div class="welcome-card">
          <h1 id="settingsTitle">Settings</h1>
          <p>Configure your account preferences and notifications.</p>
        </div>
        
        <div class="settings-container">
            <div class="automation-card">
                <div class="automation-content">
                    <div class="settings-group">
                        <div class="settings-title">Profile Information</div>
                        <form id="profileForm" onsubmit="event.preventDefault(); saveSettings(this);">
                            <div class="message-form">
                                <div class="form-group">
                                    <label class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="settingsName" value="Admin User">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email Address</label>
                                    <input type="email" class="form-control" id="settingsEmail" value="admin@example.com">
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="settings-group">
                        <div class="settings-title">Notifications</div>
                        <div class="toggle-row">
                            <div>
                                <div class="toggle-label">Email Campaign Summary</div>
                                <div class="toggle-desc">Receive a weekly summary of your campaign stats</div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="toggle-row">
                            <div>
                                <div class="toggle-label">New Customer Alert</div>
                                <div class="toggle-desc">Get notified when a new customer is added</div>
                            </div>
                            <label class="switch">
                                <input type="checkbox">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-group">
                        <div class="settings-title">Security</div>
                        <div class="action-buttons">
                            <button class="btn btn-secondary">Change Password</button>
                            <button class="btn btn-danger-outline" onclick="confirmLogout()">Log Out Everywhere</button>
                        </div>
                    </div>
                    
                    <div style="text-align: right;">
                        <button class="btn btn-primary" onclick="saveSettings(this)">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
      </section>
      
      <footer style="text-align: center; padding: 40px 20px; color: var(--text-tertiary); font-size: 13px; margin-top: auto; border-top: 1px solid var(--border-light); background: #fafafa; border-radius: var(--radius-md);">
        <p style="margin-bottom: 8px;">
            &copy; 2025 Flux On. All rights reserved.
        </p>
        <p>
            <a href="https://seraphielspark.github.io/flowon/privacy.html" target="_blank" style="color: var(--text-secondary); text-decoration: none; margin: 0 10px; font-weight: 500;">Privacy Policy</a>
            ‚Ä¢
            <a href="https://seraphielspark.github.io/flowon/terms.html" target="_blank" style="color: var(--text-secondary); text-decoration: none; margin: 0 10px; font-weight: 500;">Terms of Service</a>
        </p>
      </footer>

    </div>
  </main>
</div>

<div class="modal" id="addCustomerModal" role="dialog" aria-labelledby="modalTitle" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">Add Customer</h3>
    </div>
    <form id="customerForm" onsubmit="event.preventDefault(); saveNewCustomer();">
      <div class="form-group">
        <label class="form-label required" for="newCustomerName">Full Name</label>
        <input type="text" class="form-control" id="newCustomerName" required placeholder="Jane Doe">
      </div>
      <div class="form-group">
        <label class="form-label" for="newCustomerEmail">Email</label>
        <input type="email" class="form-control" id="newCustomerEmail" placeholder="jane@example.com">
      </div>
      <div class="form-group">
        <label class="form-label" for="newCustomerPhone">Phone</label>
        <input type="tel" class="form-control" id="newCustomerPhone" placeholder="+1 (555) 000-0000">
      </div>
      <div class="form-group">
        <label class="form-label" for="newCustomerCompany">Company</label>
        <input type="text" class="form-control" id="newCustomerCompany" placeholder="Acme Inc.">
      </div>
      <div class="form-group">
        <label class="form-label" for="newCustomerStatus">Status</label>
        <select class="form-control" id="newCustomerStatus">
          <option value="Active">Active</option>
          <option value="Inactive">Inactive</option>
          <option value="Pending">Pending</option>
        </select>
      </div>
      <div class="form-actions" style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
        <button type="button" class="btn btn-secondary" onclick="closeModal('addCustomerModal')">Cancel</button>
        <button type="submit" id="btnSaveCustomer" class="btn btn-primary">Save Record</button>
      </div>
    </form>
  </div>
</div>

<div class="modal" id="templateModal" role="dialog" aria-labelledby="templateModalTitle" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="templateModalTitle">Add New Template</h3>
    </div>
    <form id="templateForm" onsubmit="event.preventDefault(); saveTemplate();">
      <input type="hidden" id="templateIndex">
      <div class="form-group">
        <label class="form-label required" for="templateName">Template Name</label>
        <input type="text" class="form-control" id="templateName" required placeholder="e.g. Welcome Series">
      </div>
      <div class="form-group">
        <label class="form-label" for="templateTag">Tag (Category)</label>
        <input type="text" class="form-control" id="templateTag" placeholder="e.g. Sales, Onboarding">
      </div>
      <div class="form-group full-width">
        <label class="form-label required" for="templateSubject">Subject Line</label>
        <input type="text" class="form-control" id="templateSubject" required placeholder="Email Subject">
      </div>
      <div class="form-group full-width">
        <label class="form-label required" for="templateBody">Email Body</label>
        <textarea class="form-control" id="templateBody" required placeholder="Hi {name}..." style="min-height: 200px;"></textarea>
      </div>
      <div class="form-actions" style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
        <button type="button" class="btn btn-secondary" onclick="closeModal('templateModal')">Cancel</button>
        <button type="submit" id="btnSaveTemplate" class="btn btn-primary">Save Template</button>
      </div>
    </form>
  </div>
</div>

<div class="modal" id="previewModal" role="dialog" aria-labelledby="previewTitle" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="previewTitle">Message Preview</h3>
    </div>
    <div style="margin-bottom: 24px; padding: 16px; background: var(--bg-subtle); border-radius: var(--radius-sm);">
      <div style="font-size: 12px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 4px;">Subject</div>
      <div id="previewSubject" style="font-weight: 600; font-size: 16px;"></div>
    </div>
    <div style="padding: 24px; border: 1px solid var(--border-light); border-radius: var(--radius-sm); font-family: var(--font-sans); min-height: 200px; max-height: 400px; overflow-y: auto; line-height: 1.6; white-space: pre-wrap;" id="previewBody">
    </div>
    <div class="form-actions" style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
      <button type="button" class="btn btn-secondary" onclick="closeModal('previewModal')">Back to Edit</button>
      <button type="button" id="btnConfirmSend" class="btn btn-primary" onclick="sendAutomatedMessages()">Confirm & Send</button>
    </div>
  </div>
</div>

<script>
// ============================================
// CONFIGURATION & GLOBAL STATE
// ============================================
const API_BASE_URL = 'https://flowon.onrender.com/api'; 
const flowId = localStorage.getItem('flowid');

// Global Variables
let currentUser = null;
let customers = [];
let templates = [];
let inboxMessages = []; // STORE INBOX MESSAGES
let currentMessageIndex = -1; // TRACK SELECTED MESSAGE
let selectedEmails = new Set();
let isGoogleConnected = false;

const defaultTemplates = [
    { name: "Welcome Email", tag: "Onboarding", body: "Welcome to our community! We're excited to have you..." },
    { name: "Product Update", tag: "News", body: "Check out the latest features we've just released..." },
    { name: "Black Friday Promo", tag: "Sales", body: "Get 50% off everything this weekend only!" },
    { name: "Feedback Request", tag: "Support", body: "We'd love to hear your thoughts on your recent purchase..." }
];

// ============================================
// INITIALIZATION
// ============================================
document.addEventListener('DOMContentLoaded', function() {
  if (!flowId) {
    window.location.href = 'signup.html';
    return;
  }
  
  // 1. Check for Google Connection Success (OAuth Redirect)
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('status') === 'connected') {
      // Clean the URL bar
      window.history.replaceState({}, document.title, window.location.pathname);
      
      // Update UI Immediately
      updateConnectionUI(true);
      showMessage('Google Account Connected Successfully!', 'success');
      
      // Navigate to automation tab automatically
      showSection('automation');
  }
  
  // Initial Load
  loadUserData();
  setupEventListeners();
  // Poll for new emails every 10 seconds
  setInterval(loadInboxMessages, 10000);
});

function setupEventListeners() {
  // Toggle Schedule Date visibility
  const scheduleSelect = document.getElementById('scheduleType');
  if(scheduleSelect) {
      scheduleSelect.addEventListener('change', function() {
        const scheduleDateGroup = document.getElementById('scheduleDateGroup');
        scheduleDateGroup.style.display = this.value === 'scheduled' ? 'block' : 'none';
      });
  }
  
  // Message form submission
  const msgForm = document.getElementById('messageForm');
  if(msgForm) {
      msgForm.addEventListener('submit', function(e) {
        e.preventDefault();
        previewMessage();
      });
  }
}

// ============================================
// GOOGLE INTEGRATION LOGIC
// ============================================

function connectGoogle() {
   // 1. Get the stored User ID
   const userId = localStorage.getItem('flowid'); 
   
   // 2. Security Check
   if (!userId) {
       alert("User ID is missing. Please log in again.");
       return;
   }

   // 3. Construct the URL
   const targetUrl = `${API_BASE_URL}/google/connect?userId=${encodeURIComponent(userId)}`;
   
   // 4. Debug Alert (This proves the code is updated)
   // You can remove this alert after it works once
   console.log("Redirecting to:", targetUrl); 

   // 5. Redirect
   window.location.href = targetUrl;
}

function updateConnectionUI(isConnected) {
    isGoogleConnected = isConnected;

    // 1. Automation Section Card
    const statusEl = document.getElementById('connectionStatus');
    const btn = document.getElementById('btnConnectGoogle');

    if (isConnected) {
        // Connected State
        statusEl.className = 'connection-status status-connected';
        statusEl.innerHTML = '<span class="status-dot"></span><span>Active</span>';
        
        // Show Green Button but keep enabled for Reconnect
        btn.innerHTML = '‚úì Account Linked (Reconnect?)';
        btn.className = 'btn btn-success'; // Green style
        
        // Ensure button triggers reconnect, not just disabled
        btn.onclick = function() {
            if(confirm('Do you want to reconnect your Google Account?')) {
                connectGoogle();
            }
        };
        btn.disabled = false; // Allow clicking to reconnect
    } else {
        // Disconnected State
        statusEl.className = 'connection-status status-disconnected';
        statusEl.innerHTML = '<span class="status-dot"></span><span>Disconnected</span>';
        
        btn.innerHTML = 'Connect Gmail';
        btn.className = 'btn btn-secondary';
        btn.onclick = connectGoogle;
        btn.disabled = false;
    }

    // 2. Header Indicator
    const headerStatus = document.getElementById('headerGoogleStatus');
    if(headerStatus) {
        headerStatus.style.display = isConnected ? 'inline-flex' : 'none';
    }

    // 3. Sidebar Indicator
    const sidebarStatus = document.getElementById('sidebarGoogleStatus');
    if(sidebarStatus) {
        sidebarStatus.innerHTML = isConnected 
            ? '<div style="width: 8px; height: 8px; border-radius: 50%; background: var(--color-green-text);"></div> Gmail: Active'
            : '<div style="width: 8px; height: 8px; border-radius: 50%; background: #ccc;"></div> Gmail: Not Linked';
    }
}

// ============================================
// DATA LOADING ENGINE
// ============================================

function parseAndFlattenCustomers(input) {
    if (!input) return [];
    if (typeof input === 'string') {
        try { input = JSON.parse(input); } catch (e) { return []; }
    }
    if (!Array.isArray(input)) {
        if (typeof input === 'object' && input !== null) return [input];
        return [];
    }

    let flatList = [];
    input.forEach(item => {
        if (typeof item === 'string') {
            try {
                const parsed = JSON.parse(item);
                if (Array.isArray(parsed)) flatList = flatList.concat(parsed);
                else if (typeof parsed === 'object' && parsed !== null) flatList.push(parsed);
            } catch (e) {}
        } 
        else if (Array.isArray(item)) flatList = flatList.concat(item);
        else if (typeof item === 'object' && item !== null) flatList.push(item);
    });
    return flatList;
}

function normalizeCustomerData(flatList) {
    const seenEmails = new Set();
    const uniqueList = [];

    flatList.forEach(c => {
        if (!c || typeof c !== 'object') return;
        const customer = {
            name: c.name || 'Unknown',
            email: c.email || '',
            phone: c.phone || '',
            company: c.company || '',
            status: c.status || 'Active',
            createdAt: c.createdAt || new Date().toISOString()
        };

        if (customer.email && customer.email.includes('@')) {
            if (!seenEmails.has(customer.email.toLowerCase())) {
                seenEmails.add(customer.email.toLowerCase());
                uniqueList.push(customer);
            }
        } else {
            uniqueList.push(customer); 
        }
    });
    return uniqueList;
}

function safeParseTemplates(input) {
    if (Array.isArray(input)) return input;
    if (typeof input === 'string') {
        try { return JSON.parse(input); } catch(e) { return []; }
    }
    return [];
}

async function loadUserData() {
  try {
    showGlobalLoader(true, 'Loading Dashboard...');
    
    // 1. Fetch User Data
    const response = await fetch(`${API_BASE_URL}/userdata/${flowId}`);
    if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
    const userData = await response.json();
    currentUser = userData;

    // 2. Fetch Inbox Data
    await loadInboxMessages();

    // 3. Update UI
    const username = userData.username || userData.email || 'User';
    updateText('userGreeting', username.split(' ')[0]);
    updateText('profileName', username);
    updateText('userInitials', getInitials(username));
    updateValue('settingsName', username);
    updateValue('settingsEmail', userData.email || '');
    
    // 4. Update Google Status (Check for tokens in response)
    // We check if google_access_token AND google_refresh_token exist
    const hasTokens = userData.google_access_token && userData.google_refresh_token;
    
    // Pass this status to the UI updater
    updateConnectionUI(hasTokens);
    
    const rawFlattened = parseAndFlattenCustomers(userData.customers);
    customers = normalizeCustomerData(rawFlattened);
    
    const rawTemplates = safeParseTemplates(userData.templates);
    templates = rawTemplates.length > 0 ? rawTemplates : [...defaultTemplates];

    updateDashboardStats();
    renderCustomerTable();
    renderEmailList();
    renderTemplates();
    renderTemplateSelector();
    renderAnalytics();
    
  } catch (error) {
    console.error('CRITICAL ERROR loading data:', error);
    showMessage('Failed to load data. Please refresh.', 'error');
  } finally {
    showGlobalLoader(false);
  }
}

// ============================================
// INBOX LOGIC (ENHANCED)
// ============================================

// Helper to remove n8n artifacts
function cleanN8nValue(val) {
    if (!val) return '';
    if (typeof val === 'string' && val.startsWith('=')) {
        return val.substring(1);
    }
    return val;
}

async function loadInboxMessages() {
    try {
        const res = await fetch(`${API_BASE_URL}/inbox`);
        if (res.ok) {
            inboxMessages = await res.json();
            updateNotificationCount();
            renderInboxList();
        }
    } catch (e) {
        console.error("Failed to load inbox", e);
    }
}

function updateNotificationCount() {
    const unread = inboxMessages.filter(m => !m.read).length;
    const badge = document.getElementById('notificationBadge');
    
    badge.textContent = unread;
    if (unread > 0) {
        badge.classList.add('show');
        updateText('unreadStats', unread);
    } else {
        badge.classList.remove('show');
        updateText('unreadStats', 0);
    }
}

function renderInboxList() {
    const listContainer = document.getElementById('inboxList');
    if (!listContainer) return;

    if (inboxMessages.length === 0) {
        listContainer.innerHTML = `<div style="padding: 40px 24px; text-align: center; color: var(--text-tertiary);">
            <div style="font-size: 24px; margin-bottom: 8px;">üì≠</div>
            No messages yet
        </div>`;
        return;
    }

    let html = '';
    inboxMessages.forEach((msg, index) => {
        const from = cleanN8nValue(msg.from_name) || cleanN8nValue(msg.from_email) || 'Unknown';
        const subject = cleanN8nValue(msg.subject) || '(No Subject)';
        
        let dateDisplay = 'Today';
        if(msg.date) {
            const d = new Date(cleanN8nValue(msg.date));
            if(!isNaN(d.getTime())) dateDisplay = d.toLocaleDateString();
        }

        const rawBody = cleanN8nValue(msg.body_text || '');
        const snippet = rawBody ? rawBody.substring(0, 50) + '...' : 'No preview available';
        
        // Elite: Unread and selection styling
        const isReadClass = msg.read ? '' : 'unread';
        const selectedClass = index === currentMessageIndex ? 'selected' : '';

        html += `
            <div class="inbox-item ${isReadClass} ${selectedClass}" onclick="viewEmail(${index}, this)">
                <div class="inbox-item-header">
                    <span class="inbox-sender">${escapeHtml(from)}</span>
                    <span class="inbox-date">${dateDisplay}</span>
                </div>
                <div class="inbox-subject">${escapeHtml(subject)}</div>
                <div class="inbox-snippet">${escapeHtml(snippet)}</div>
            </div>
        `;
    });
    listContainer.innerHTML = html;
}

async function viewEmail(index, element) {
    const msg = inboxMessages[index];
    if (!msg) return;

    currentMessageIndex = index;

    // Handle Read Status
    if (!msg.read) {
        msg.read = true;
        updateNotificationCount();
        // Optimistically update backend (assuming backend support added)
        fetch(`${API_BASE_URL}/inbox/read/${msg.id}`, { method: 'POST' }).catch(e=>console.log(e));
    }
    
    // Re-render list to update styling (remove unread dot, add selected bg)
    renderInboxList();

    // Update View
    document.getElementById('inboxEmptyState').style.display = 'none';
    
    // Ensure inboxContent is flex to support new layout
    const content = document.getElementById('inboxContent');
    content.style.display = 'flex'; 

    const fromName = cleanN8nValue(msg.from_name) || 'Unknown';
    const fromEmail = cleanN8nValue(msg.from_email);
    const subject = cleanN8nValue(msg.subject) || '(No Subject)';
    let dateStr = 'Unknown Date';
    
    if (msg.date) {
         const d = new Date(cleanN8nValue(msg.date));
         if(!isNaN(d.getTime())) dateStr = d.toLocaleString();
    }

    updateText('viewSubject', subject);
    updateText('viewSender', fromName);
    updateText('viewEmail', fromEmail);
    updateText('viewDate', dateStr);
    updateText('viewAvatar', getInitials(fromName));

    // Handle HTML Body safely
    const bodyContainer = document.getElementById('viewBody');
    const htmlContent = cleanN8nValue(msg.body_html);
    const textContent = cleanN8nValue(msg.body_text);
    
    bodyContainer.innerHTML = htmlContent || textContent || '<p>No content</p>';
    
    // Mobile handling
    if(window.innerWidth <= 768) {
        document.getElementById('inboxView').classList.add('active');
    }
}

async function deleteCurrentMessage() {
    if (currentMessageIndex === -1) return;
    
    if(!confirm('Delete this message permanently?')) return;

    const msg = inboxMessages[currentMessageIndex];
    
    // 1. Optimistic UI Update
    inboxMessages.splice(currentMessageIndex, 1);
    currentMessageIndex = -1;
    
    // 2. Reset View
    document.getElementById('inboxContent').style.display = 'none';
    document.getElementById('inboxEmptyState').style.display = 'flex';
    if(window.innerWidth <= 768) closeMobileInbox();

    // 3. Render & API Call
    renderInboxList();
    updateNotificationCount();
    
    try {
        await fetch(`${API_BASE_URL}/inbox/${msg.id}`, { method: 'DELETE' });
    } catch (e) {
        console.error("Delete failed on server", e);
        showMessage('Error deleting message on server', 'error');
    }
}

function closeMobileInbox() {
    document.getElementById('inboxView').classList.remove('active');
    currentMessageIndex = -1;
    renderInboxList();
}

// ============================================
// UI RENDERING FUNCTIONS
// ============================================

function updateDashboardStats() {
  const total = customers.length;
  updateText('totalCustomers', total);
  updateText('totalEmails', total); 
  updateText('messagesSent', inboxMessages.length > 0 ? inboxMessages.length + 120 : '124'); 
  updateText('activeCampaigns', '2'); 
  updateText('responseRate', '18%'); 
  updateText('customerCount', `(${total})`);
}

function renderCustomerTable() {
  const container = document.getElementById('tableContainer');
  if (!container) return;
  if (customers.length === 0) {
    container.innerHTML = `
      <div style="padding: 40px; text-align: center;">
        <h3 style="margin-top:0;">No Customers Yet</h3>
        <p style="color: var(--text-secondary); margin-bottom: 20px;">Start by adding or importing customers.</p>
        <button class="btn btn-primary" onclick="addNewCustomer()">Add First Customer</button>
      </div>`;
    return;
  }
  let html = `
    <table class="simple-table">
      <thead>
        <tr>
          <th width="40">#</th>
          <th>Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Company</th>
          <th>Status</th>
          <th width="100">Actions</th>
        </tr>
      </thead>
      <tbody>`;
  customers.forEach((c, i) => {
    const status = c.status || 'Active';
    html += `
      <tr>
        <td style="color: var(--text-tertiary);">${i + 1}</td>
        <td><input class="table-input" value="${escapeHtml(c.name)}" onchange="updateCustomerField(${i}, 'name', this.value)"></td>
        <td><input class="table-input" value="${escapeHtml(c.email)}" onchange="updateCustomerField(${i}, 'email', this.value)"></td>
        <td><input class="table-input" value="${escapeHtml(c.phone)}" onchange="updateCustomerField(${i}, 'phone', this.value)"></td>
        <td><input class="table-input" value="${escapeHtml(c.company)}" onchange="updateCustomerField(${i}, 'company', this.value)"></td>
        <td>
          <select class="table-input email-status status-${status.toLowerCase()}" style="width: auto;" onchange="updateCustomerField(${i}, 'status', this.value)">
            <option value="Active" ${status === 'Active' ? 'selected' : ''}>Active</option>
            <option value="Inactive" ${status === 'Inactive' ? 'selected' : ''}>Inactive</option>
            <option value="Pending" ${status === 'Pending' ? 'selected' : ''}>Pending</option>
          </select>
        </td>
        <td style="display: flex; gap: 4px;">
          <button class="icon-btn btn" style="width: 32px; padding: 0;" onclick="saveCustomer(${i})" title="Save">üíæ</button>
          <button class="icon-btn btn" style="width: 32px; padding: 0; color: var(--color-red-text);" onclick="deleteCustomer(${i})" title="Delete">üóëÔ∏è</button>
        </td>
      </tr>`;
  });
  html += `</tbody></table>`;
  container.innerHTML = html;
}

function renderEmailList() {
  const container = document.getElementById('emailList');
  if(!container) return;
  const validCustomers = customers.filter(c => c.email && c.email.includes('@'));
  if (validCustomers.length === 0) {
    container.innerHTML = `<div style="padding: 24px; text-align: center; color: var(--text-secondary);"><p>No valid email addresses found.</p></div>`;
    return;
  }
  let html = '';
  validCustomers.forEach((c) => {
    const isSelected = selectedEmails.has(c.email);
    const status = c.status || 'Active';
    html += `
      <div class="email-item">
        <input type="checkbox" class="email-checkbox" 
               data-email="${c.email}" 
               ${isSelected ? 'checked' : ''} 
               onchange="toggleEmailSelection(this)">
        <div class="email-info">
          <div class="email-address">${escapeHtml(c.email)}</div>
          <div class="email-customer">${escapeHtml(c.name)} ¬∑ ${escapeHtml(c.company)}</div>
        </div>
        <div class="email-status status-${status.toLowerCase()}">${status}</div>
      </div>`;
  });
  container.innerHTML = html;
  updateSelectionCount();
}

function renderTemplates() {
    const grid = document.getElementById('templatesGrid');
    if(!grid) return;
    if (templates.length === 0) {
        grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 40px;">No templates found.</div>`;
        return;
    }
    let html = '';
    templates.forEach((t, i) => {
        html += `
            <div class="template-card">
                <div class="template-card-header">
                    <span class="template-name">${escapeHtml(t.name)}</span>
                    <span class="template-tag">${escapeHtml(t.tag || 'General')}</span>
                </div>
                <div class="template-body">${escapeHtml(t.body || '')}</div>
                <div class="template-footer">
                    <button class="btn btn-secondary" style="height: 32px; font-size: 13px; flex: 1;" onclick="useTemplate(${i})">Use</button>
                    <button class="btn btn-secondary" style="height: 32px; font-size: 13px;" onclick="editTemplate(${i})">Edit</button>
                    <button class="btn btn-secondary" style="height: 32px; font-size: 13px; color: var(--color-red-text);" onclick="deleteTemplate(${i})">Del</button>
                </div>
            </div>`;
    });
    grid.innerHTML = html;
}

function renderTemplateSelector() {
    const container = document.getElementById('automationTemplateSelector');
    if(!container) return;
    let html = '';
    templates.forEach((t, i) => {
        html += `<button class="template-btn" onclick="loadTemplate(${i})">${escapeHtml(t.name)}</button> `;
    });
    html += `<button class="template-btn" onclick="loadTemplate('custom')">Blank</button>`;
    container.innerHTML = html;
}

// ============================================
// USER ACTIONS & LOGIC
// ============================================

function toggleEmailSelection(checkbox) {
  const email = checkbox.dataset.email;
  if (checkbox.checked) selectedEmails.add(email);
  else selectedEmails.delete(email);
  updateSelectionCount();
  updateSelectAllCheckbox();
}

function toggleAllEmails() {
  const selectAll = document.getElementById('selectAllEmails');
  const checkboxes = document.querySelectorAll('.email-checkbox');
  if (selectAll.checked) {
    selectedEmails.clear();
    checkboxes.forEach(cb => {
        cb.checked = true;
        selectedEmails.add(cb.dataset.email);
    });
  } else {
    selectedEmails.clear();
    checkboxes.forEach(cb => cb.checked = false);
  }
  updateSelectionCount();
}

function updateSelectionCount() {
  updateText('selectedCount', selectedEmails.size);
}

function updateSelectAllCheckbox() {
  const selectAll = document.getElementById('selectAllEmails');
  const checkboxes = document.querySelectorAll('.email-checkbox');
  const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
  if(selectAll) {
      selectAll.checked = checkedCount === checkboxes.length && checkboxes.length > 0;
      selectAll.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
  }
}

function updateCustomerField(index, field, value) {
  if (!customers[index]) customers[index] = {};
  customers[index][field] = value;
}

async function saveCustomer(index) {
  await saveAllChanges();
}

async function deleteCustomer(index) {
  if (!confirm('Are you sure you want to delete this customer?')) return;
  customers.splice(index, 1);
  refreshUI();
  await saveAllChanges();
}

function addNewCustomer() {
  updateValue('newCustomerName', '');
  updateValue('newCustomerEmail', '');
  updateValue('newCustomerPhone', '');
  updateValue('newCustomerCompany', '');
  updateValue('newCustomerStatus', 'Active');
  openModal('addCustomerModal');
}

async function saveNewCustomer() {
  const btn = document.getElementById('btnSaveCustomer');
  setButtonLoading(btn, true, 'Saving...');
  try {
      const name = document.getElementById('newCustomerName').value.trim();
      if (!name) { alert('Name is required'); setButtonLoading(btn, false); return; }

      const newC = {
          name: name,
          email: document.getElementById('newCustomerEmail').value.trim(),
          phone: document.getElementById('newCustomerPhone').value.trim(),
          company: document.getElementById('newCustomerCompany').value.trim(),
          status: document.getElementById('newCustomerStatus').value,
          createdAt: new Date().toISOString()
      };
      
      customers.push(newC);
      closeModal('addCustomerModal');
      refreshUI();
      await saveAllChanges();
  } catch(e) {
      console.error(e);
  } finally {
      setButtonLoading(btn, false);
  }
}

function importCustomers() {
    document.getElementById('csvFileInput').click();
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    showGlobalLoader(true, 'Parsing CSV...');
    const reader = new FileReader();
    reader.onload = function(e) {
        setTimeout(() => processCSV(e.target.result), 100);
    };
    reader.readAsText(file);
    event.target.value = ''; 
}

function processCSV(csvText) {
    const lines = csvText.split(/\r\n|\n/).filter(line => line.trim() !== '');
    if (lines.length < 2) {
        showGlobalLoader(false);
        alert('CSV file is too short or empty.');
        return;
    }
    function parseCSVRow(text) {
        const re_value = /(?!\s*$)\s*(?:'([^']*)'|"([^"]*)"|([^,;]*))\s*(?:[,;]|$)/g;
        const row = [];
        text.replace(re_value, (m, p1, p2, p3) => {
            if (p1 !== undefined) row.push(p1);
            else if (p2 !== undefined) row.push(p2);
            else if (p3 !== undefined) row.push(p3);
            return '';
        });
        return row;
    }
    const rawHeaders = parseCSVRow(lines[0]);
    const headers = rawHeaders.map(h => h.toLowerCase().trim());
    let emailIdx = headers.findIndex(h => h === 'email' || h.includes('primary email') || h.includes('email address'));
    let nameIdx = headers.findIndex(h => h === 'name' || h.includes('full name') || h.includes('first name'));
    let companyIdx = headers.findIndex(h => h.includes('company'));
    let phoneIdx = headers.findIndex(h => h.includes('phone') || h.includes('mobile'));

    if (emailIdx === -1 && lines.length > 0) {
        const firstDataRow = parseCSVRow(lines[1]);
        emailIdx = firstDataRow.findIndex(val => val && val.includes('@'));
    }
    if (emailIdx === -1) {
        showGlobalLoader(false);
        alert('Could not detect an Email column. Please check your CSV.');
        return;
    }
    let importedCount = 0;
    for (let i = 1; i < lines.length; i++) {
        const row = parseCSVRow(lines[i]);
        if (!row || row.length === 0) continue;
        const email = (row[emailIdx] || '').trim();
        if (email && email.includes('@')) {
            let name = 'Unknown';
            if (nameIdx > -1 && row[nameIdx]) name = row[nameIdx];
            else if (headers.includes('first name')) {
                const fNameIdx = headers.indexOf('first name');
                const lNameIdx = headers.indexOf('last name');
                name = `${row[fNameIdx] || ''} ${row[lNameIdx] || ''}`.trim();
            } else name = email.split('@')[0].replace(/[._-]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            customers.push({
                name: name,
                email: email,
                phone: phoneIdx > -1 ? row[phoneIdx] : '',
                company: companyIdx > -1 ? row[companyIdx] : '',
                status: 'Active',
                createdAt: new Date().toISOString()
            });
            importedCount++;
        }
    }
    refreshUI();
    saveAllChanges().finally(() => {
        showGlobalLoader(false);
        showMessage(`Successfully imported ${importedCount} customers!`, 'success');
    });
}

function createNewTemplate() {
    updateValue('templateIndex', '-1');
    document.getElementById('templateForm').reset();
    updateText('templateModalTitle', 'Add New Template');
    openModal('templateModal');
}

function editTemplate(index) {
    const t = templates[index];
    updateValue('templateIndex', index);
    updateValue('templateName', t.name);
    updateValue('templateTag', t.tag);
    updateValue('templateSubject', t.subject || t.name);
    updateValue('templateBody', t.body);
    updateText('templateModalTitle', 'Edit Template');
    openModal('templateModal');
}

async function saveTemplate() {
    const btn = document.getElementById('btnSaveTemplate');
    setButtonLoading(btn, true);
    const index = parseInt(document.getElementById('templateIndex').value);
    const newT = {
        name: document.getElementById('templateName').value,
        tag: document.getElementById('templateTag').value,
        subject: document.getElementById('templateSubject').value,
        body: document.getElementById('templateBody').value
    };
    if (index === -1) templates.push(newT);
    else templates[index] = newT;
    closeModal('templateModal');
    renderTemplates();
    renderTemplateSelector();
    await saveAllChanges();
    setButtonLoading(btn, false);
}

async function deleteTemplate(index) {
    if(!confirm('Delete template?')) return;
    templates.splice(index, 1);
    renderTemplates();
    renderTemplateSelector();
    await saveAllChanges();
}

function useTemplate(index) {
    loadTemplate(index);
    showSection('automation');
}

function loadTemplate(identifier) {
    document.querySelectorAll('.template-btn').forEach(b => b.classList.remove('active'));
    if(event && event.target) event.target.classList.add('active');
    if(identifier === 'custom') {
        updateValue('emailSubject', '');
        updateValue('emailBody', '');
    } else {
        const t = templates[identifier];
        if(t) {
            updateValue('emailSubject', t.subject || t.name);
            updateValue('emailBody', t.body);
        }
    }
}

function previewMessage() {
    const subject = document.getElementById('emailSubject').value;
    const body = document.getElementById('emailBody').value;
    updateText('previewSubject', subject);
    updateText('previewBody', body);
    openModal('previewModal');
}

async function sendAutomatedMessages() {
    if(selectedEmails.size === 0) { alert('No recipients selected'); return; }
    
    // Check Google Connection
    if (!isGoogleConnected) {
        if(!confirm("Warning: Your Google account is not connected. Emails might fail to send. Connect now?")) {
            // User chose to continue anyway, proceed...
        } else {
            connectGoogle();
            return;
        }
    }

    const btn = document.getElementById('btnConfirmSend');
    setButtonLoading(btn, true, 'Sending...');
    const payload = {
        userId: flowId,
        campaignName: document.getElementById('campaignName').value,
        recipients: Array.from(selectedEmails),
        subject: document.getElementById('emailSubject').value,
        body: document.getElementById('emailBody').value,
        fromName: document.getElementById('fromName').value,
        fromEmail: document.getElementById('fromEmail').value
    };
    try {
        const res = await fetch(`${API_BASE_URL}/send-automated-messages`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error('Send failed');
        showMessage(`Sent to ${selectedEmails.size} recipients`, 'success');
        closeModal('previewModal');
        selectedEmails.clear();
        renderEmailList();
    } catch(e) {
        console.error(e);
        showMessage('Failed to send messages', 'error');
    } finally {
        setButtonLoading(btn, false);
    }
}

async function saveAllChanges() {
    const btn = document.getElementById('btnSaveChanges');
    if(btn) setButtonLoading(btn, true, 'Saving...');
    try {
        const payload = {
            userId: flowId,
            customers: customers,
            templates: templates
        };
        await fetch(`${API_BASE_URL}/updatecustomers`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        showMessage('Data saved to cloud', 'success');
    } catch(e) {
        console.error(e);
        showMessage('Error saving data', 'error');
    } finally {
        if(btn) setButtonLoading(btn, false);
    }
}

// ============================================
// UTILITIES
// ============================================

function refreshUI() {
    updateDashboardStats();
    renderCustomerTable();
    renderEmailList();
}

function refreshData() {
    const btn = document.getElementById('btnRefresh');
    setButtonLoading(btn, true, 'Refreshing...');
    loadUserData().finally(() => setButtonLoading(btn, false));
}

function showMessage(text, type) {
    const msg = document.createElement('div');
    msg.textContent = text;
    msg.style.cssText = `position:fixed; top:20px; right:20px; padding:12px 20px; background:${type==='error'?'#991b1b':'#000'}; color:#fff; border-radius:4px; z-index:3000; animation: fadeIn 0.3s;`;
    document.body.appendChild(msg);
    setTimeout(() => msg.remove(), 3000);
}

function setButtonLoading(btn, isLoading, text='Loading...') {
    if(!btn) return;
    if(isLoading) {
        btn.dataset.og = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `<span class="btn-spinner"></span> ${text}`;
    } else {
        btn.innerHTML = btn.dataset.og || 'Submit';
        btn.disabled = false;
    }
}

function showGlobalLoader(show, text='Loading...') {
    const el = document.getElementById('globalLoader');
    if(el) {
        el.style.display = show ? 'flex' : 'none';
        const txt = document.getElementById('loaderText');
        if(txt) txt.textContent = text;
    }
}

function updateText(id, text) {
    const el = document.getElementById(id);
    if(el) el.textContent = text;
}
function updateValue(id, val) {
    const el = document.getElementById(id);
    if(el) el.value = val;
}
function escapeHtml(text) {
  if (!text) return "";
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function getInitials(name) {
    return (name || 'U').split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
}

function showSection(id) {
    document.querySelectorAll('.section-content').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    
    const sec = document.getElementById(id+'Section');
    if(sec) sec.style.display = 'block';
    
    const nav = document.querySelector(`a[href="#${id}"]`);
    if(nav) nav.classList.add('active');
    
    const titles = {
        'dashboard': 'Dashboard',
        'customers': 'Customer Management',
        'inbox': 'Inbox',
        'automation': 'Automation Center',
        'analytics': 'Analytics',
        'templates': 'Templates',
        'settings': 'Settings'
    };
    updateText('pageTitle', titles[id] || 'Dashboard');
}

function openModal(id) { document.getElementById(id).style.display = 'flex'; }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }
function clearForm() { if(confirm('Reset form?')) document.getElementById('messageForm').reset(); }
function confirmLogout() { if(confirm('Log out?')) { localStorage.removeItem('flowid'); window.location.href='signup.html'; } }

function renderAnalytics() {
    const container = document.getElementById('analyticsChart');
    if(!container) return;
    const data = [10, 40, 25, 50, 30, 60, 70];
    const max = Math.max(...data);
    container.innerHTML = data.map((d,i) => `
        <div class="chart-bar-group">
            <div class="chart-value">${d}</div>
            <div class="chart-bar" style="height:${(d/max)*100}%"></div>
            <div class="chart-label">Day ${i+1}</div>
        </div>
    `).join('');
}
</script>
</body>

</html>
